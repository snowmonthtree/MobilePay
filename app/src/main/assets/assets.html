<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>总资产</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 全屏页面基础样式 */
        .fullscreen-page {
            background: #f8f9fa;
            min-height: calc(100vh - 40px);
            padding-bottom: 20px;
            display: none;
        }

        .fullscreen-page.active {
            display: block;
        }

        .back-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
        }

        .back-btn img {
            width: 20px;
            height: 20px;
        }

        /* 页面内容样式 */
        .page-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background-color: #f8f9fa;
        }

        /* 页面底部样式 */
        .page-footer {
            padding: 16px;
            background-color: #fff;
            border-top: 1px solid #f0f2f5;
            position: sticky;
            bottom: 0;
        }

        .transfer-form {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* 金额输入组样式 */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: #fff;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .form-group label {
            font-size: 0.95rem;
            font-weight: 500;
            color: #1d2129;
        }

        .amount-input-group {
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e9ecef;
            transition: border-color 0.2s;
        }

        .amount-input-group:focus-within {
            border-color: #165DFF;
            box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
        }

        .currency {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1d2129;
            margin-right: 8px;
        }

        #transferInAmount,
        #transferOutAmount {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1d2129;
            background: transparent;
            width: 100%;
        }

        #transferInAmount::placeholder,
        #transferOutAmount::placeholder {
            color: #86909C;
            font-weight: 400;
        }

        /* 银行卡选择样式 */
        .bank-card-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bank-card-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background-color: #fff;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bank-card-option:active {
            background-color: #f0f7ff;
        }

        .bank-card-option.selected {
            border-color: #165DFF;
            background-color: #f0f7ff;
        }

        .bank-card-option img {
            width: 32px;
            height: 32px;
        }

        .card-info {
            flex: 1;
        }

        .card-name {
            font-size: 1rem;
            font-weight: 600;
            color: #1d2129;
            margin-bottom: 4px;
        }

        .card-number {
            font-size: 0.85rem;
            color: #86909C;
        }

        .card-balance {
            font-size: 0.9rem;
            color: #165DFF;
            font-weight: 500;
        }

        /* 手续费信息样式 */
        .transfer-fee-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fee-item:first-child {
            margin-bottom: 8px;
        }

        .fee-item span:first-child {
            color: #86909C;
            font-size: 0.9rem;
        }

        .fee-item span:last-child {
            color: #1d2129;
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* 页面底部按钮样式 */
        .page-footer {
            display: flex;
            justify-content: center;
            padding: 16px;
            background-color: #fff;
            border-top: 1px solid #f0f2f5;
        }

        .btn-confirm {
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            outline: none;
            background-color: #165DFF;
            color: white;
        }

        .btn-confirm:active {
            background-color: #0E42D2;
        }

        .full-width {
            width: 100%;
        }

        .available-balance {
            background-color: #d8eaff;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            color: #165DFF;
            font-weight: 500;
        }

        .quick-amounts {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-amount {
            padding: 8px 16px;
            border-radius: 20px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #1d2129;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .quick-amount:active {
            background-color: #e9ecef;
        }

        /* Toast提示样式 */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            text-align: center;
            max-width: 80%;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* 响应式优化 */
        @media (max-width: 480px) {
            .modal .modal-body {
                padding: 18px;
                max-height: 100vh;
            }

            .modal .amount-input-group {
                padding: 14px;
            }

            .modal .currency,
            .modal #transferInAmount {
                font-size: 1.25rem;
            }

            .modal .modal-footer {
                padding: 12px 18px;
                gap: 12px;
            }
        }

        .eye-btn {
            background: none;
            border: none;
            cursor: pointer;
        }

        .eye-btn img {
            width: 20px;
            height: 20px;
            filter: brightness(0) invert(1);
        }

        /* 密码弹窗样式 */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .password-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 80%;
            max-width: 300px;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .password-input {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .password-input input {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .modal-buttons {
            margin-top: 15px;
        }

        .modal-buttons button {
            padding: 8px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* 无银行卡提示样式 */
        .no-card {
            text-align: center;
            padding: 20px;
            color: #86909C;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<div class="app-container">
    <!-- 总资产页面 -->
    <div class="assets-page">
        <!-- 页面头部 -->
        <div class="page-header">
            <button class="back-btn" onclick="AssetPage.goBack()">
                <img src="icons/danjiantouzuo.png" alt="返回">
            </button>
            <h1>总资产</h1>
            <div class="header-placeholder"></div>
        </div>

        <!-- 资产总览 -->
        <div class="asset-overview">
            <div class="total-asset">
                <div class="asset-header">
                    <h3>总资产</h3>
                    <button class="eye-btn" onclick="AssetPage.toggleAssetVisibility()">
                        <img src="icons/xianshimima.png" alt="显示/隐藏" id="eyeIcon">
                    </button>
                </div>
                <div class="asset-amount" id="totalAsset">¥12,580.50</div>
                <div class="asset-update-time">更新时间：2024-01-15 14:30</div>
            </div>

            <!-- 资产变动趋势 -->
            <div class="asset-trend">
                <h4>近7日资产变动</h4>
                <div class="trend-chart">
                    <canvas id="trendChart" width="300" height="120"></canvas>
                </div>
                <div class="trend-summary">
                    <div class="trend-item">
                        <span class="trend-label">本周收入</span>
                        <span class="trend-value positive">+¥2,350.00</span>
                    </div>
                    <div class="trend-item">
                        <span class="trend-label">本周支出</span>
                        <span class="trend-value negative">-¥1,890.50</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 资产详情 -->
        <div class="asset-details">
            <div class="asset-section">
                <h3>账户余额</h3>
                <div class="balance-card">
                    <div class="balance-info">
                        <div class="balance-type">可用余额</div>
                        <div class="balance-amount" id="availableBalance">¥8,580.50</div>
                    </div>
                    <div class="balance-actions">
                        <button class="balance-action-btn" onclick="TransferPage.showTransferIn()">
                            <img src="icons/shuangjiantoushang.png" alt="转入">
                            <span>转入</span>
                        </button>
                        <button class="balance-action-btn" onclick="TransferPage.showTransferOut()">
                            <img src="icons/shuangjiantouxia.png" alt="转出">
                            <span>转出</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 转入页面 -->
    <div class="fullscreen-page" id="transferInPage">
        <div class="page-header">
            <button class="back-btn" onclick="TransferPage.hideFullscreenPage('transferInPage')">
                <img src="icons/danjiantouzuo.png" alt="返回">
            </button>
            <h3>转入余额</h3>
            <div class="header-placeholder"></div>
        </div>
        <div class="page-content">
            <div class="transfer-form">
                <div class="form-group">
                    <label>转入金额</label>
                    <div class="amount-input-group">
                        <span class="currency">¥</span>
                        <input type="number" id="transferInAmount" placeholder="请输入转入金额" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label>选择银行卡</label>
                    <div class="bank-card-list" id="transferInBankList"></div>
                </div>

                <div class="transfer-fee-info">
                    <div class="fee-item">
                        <span>到账时间</span>
                        <span>实时到账</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="page-footer">
            <button class="btn-confirm full-width" onclick="TransferPage.confirmTransferIn()">确认转入</button>
        </div>
    </div>

    <!-- 转出页面 -->
    <div class="fullscreen-page" id="transferOutPage">
        <div class="page-header">
            <button class="back-btn" onclick="TransferPage.hideFullscreenPage('transferOutPage')">
                <img src="icons/danjiantouzuo.png" alt="返回">
            </button>
            <h3>转出至银行卡</h3>
            <div class="header-placeholder"></div>
        </div>
        <div class="page-content">
            <div class="transfer-form">
                <div class="form-group">
                    <label>转出金额</label>
                    <div class="amount-input-group">
                        <span class="currency">¥</span>
                        <input type="number" id="transferOutAmount" placeholder="请输入转出金额" step="0.01">
                    </div>
                    <div class="quick-amounts">
                        <button class="quick-amount" onclick="TransferPage.setQuickAmount(100)">100</button>
                        <button class="quick-amount" onclick="TransferPage.setQuickAmount(500)">500</button>
                        <button class="quick-amount" onclick="TransferPage.setQuickAmount(1000)">1000</button>
                        <button class="quick-amount" onclick="TransferPage.setAllAmount()">全部</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>选择收款银行卡</label>
                    <div class="bank-card-list" id="transferOutBankList"></div>
                </div>

                <div class="transfer-fee-info">
                    <div class="fee-item">
                        <span>到账时间</span>
                        <span>2小时内</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="page-footer">
            <button class="btn-confirm full-width" onclick="TransferPage.confirmTransferOut()">确认转出</button>
        </div>
    </div>
</div>

<!-- 密码输入弹窗 -->
<div id="passwordModal" class="password-modal">
    <div class="modal-content">
        <h3>请输入6位支付密码</h3>
        <div class="password-input">
            <input type="text" maxlength="1" oninput="PasswordHandler.nextPasswordInput(this, 0)">
            <input type="text" maxlength="1" oninput="PasswordHandler.nextPasswordInput(this, 1)">
            <input type="text" maxlength="1" oninput="PasswordHandler.nextPasswordInput(this, 2)">
            <input type="text" maxlength="1" oninput="PasswordHandler.nextPasswordInput(this, 3)">
            <input type="text" maxlength="1" oninput="PasswordHandler.nextPasswordInput(this, 4)">
            <input type="text" maxlength="1" oninput="PasswordHandler.nextPasswordInput(this, 5)">
        </div>
        <div class="modal-buttons">
            <button onclick="PasswordHandler.cancelPasswordInput()">取消</button>
        </div>
    </div>
</div>

<script>
    // 命名空间：资产页面相关功能
    const AssetPage = {
        assetsVisible: true,
        formattedBalance: 0,

        /** 切换资产显示/隐藏 */
        toggleAssetVisibility() {
            const totalAssetEl = document.getElementById('totalAsset');
            const availableBalanceEl = document.getElementById('availableBalance');
            const eyeIcon = document.getElementById('eyeIcon');
            const rawValue = totalAssetEl.dataset.rawValue;

            if (this.assetsVisible) {
                totalAssetEl.textContent = '****';
                availableBalanceEl.textContent = '****';
                eyeIcon.src = 'icons/yincangmima.png';
                this.assetsVisible = false;
            } else {
                totalAssetEl.textContent = `¥${this.formatCurrency(rawValue)}`;
                availableBalanceEl.textContent = `¥${this.formatCurrency(rawValue)}`;
                eyeIcon.src = 'icons/xianshimima.png';
                this.assetsVisible = true;
            }
        },

        /** 返回上一页 */
        goBack() {
            window.history.back();
        },

        /** 显示资产设置（预留功能） */
        showAssetSettings() {
            Toast.show('资产设置功能');
        },

        /** 跳转到添加银行卡页面 */
        addBankCard() {
            window.location.href = 'cards.html';
        },

        /** 格式化金额（保留两位小数，添加千分位） */
        formatCurrency(amount) {
            if (!amount && amount !== 0) return '0.00';
            return parseFloat(amount).toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        },

        /** 格式化日期时间 */
        formatDateTime(isoTime) {
            if (!isoTime) return '';
            const date = new Date(isoTime);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        },

        /** 绘制资产趋势图 */
        drawTrendChart(chartData) {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            // 提取数据和标签
            const data = chartData.map(item => parseFloat(item.balance || 0));
            const labels = chartData.map(item => item.day || '');

            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 设置样式
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 2;
            ctx.fillStyle = 'rgba(76, 175, 80, 0.1)';

            // 计算绘图参数
            const padding = 20;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const stepX = data.length > 1 ? chartWidth / (data.length - 1) : 0;

            // 计算数据范围
            const minValue = Math.min(...data) * 0.95;
            const maxValue = Math.max(...data) * 1.05;
            const valueRange = maxValue - minValue || 1; // 避免除以0

            // 绘制线条和填充区域
            ctx.beginPath();
            data.forEach((value, index) => {
                const x = padding + index * stepX;
                const y = padding + chartHeight - ((value - minValue) / valueRange) * chartHeight;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // 绘制填充区域
            ctx.lineTo(padding + (data.length - 1) * stepX, padding + chartHeight);
            ctx.lineTo(padding, padding + chartHeight);
            ctx.closePath();
            ctx.fill();
        },

        /** 计算并更新本周收支趋势 */
        calculateWeeklyTrend(chartData) {
            const dailyBalances = chartData.map(item => parseFloat(item.balance || 0));
            const dailyChanges = [];

            for (let i = 1; i < dailyBalances.length; i++) {
                dailyChanges.push(dailyBalances[i] - dailyBalances[i - 1]);
            }

            let totalIncome = 0;
            let totalExpense = 0;
            dailyChanges.forEach(change => {
                if (change > 0) {
                    totalIncome += change;
                } else if (change < 0) {
                    totalExpense += Math.abs(change);
                }
            });

            document.querySelector('.trend-value.positive').textContent = `+¥${this.formatCurrency(totalIncome.toFixed(2))}`;
            document.querySelector('.trend-value.negative').textContent = `-¥${this.formatCurrency(totalExpense.toFixed(2))}`;
        },

        /** 更新资产UI显示 */
        updateAssetUI(assetData) {
            if (!assetData) return;

            const totalAssetEl = document.getElementById('totalAsset');
            const availableBalanceEl = document.getElementById('availableBalance');
            const updateTimeEl = document.querySelector('.asset-update-time');

            this.formattedBalance = this.formatCurrency(assetData.balance || 0);
            totalAssetEl.textContent = `¥${this.formattedBalance}`;
            availableBalanceEl.textContent = `¥${this.formattedBalance}`;
            totalAssetEl.dataset.rawValue = assetData.balance || 0;

            updateTimeEl.textContent = `更新时间：${this.formatDateTime(assetData.updateTime)}`;
            this.calculateWeeklyTrend(assetData.assertsChartV0 || []);
        },

        /** 获取资产汇总数据 */
        fetchAssetSummary() {
            const token = this.getToken();
            if (!token) return;

            fetch('http://graywolf.top:6031/appassets/assets/summary', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
                    'Accept': '*/*'
                }
            })
            .then(response => this.handleResponse(response))
            .then(data => {
                if (data.code === 200 && data.data) {
                    this.updateAssetUI(data.data);
                    this.drawTrendChart(data.data.assertsChartV0 || []);
                } else {
                    Toast.show(data.message || '获取资产数据失败');
                }
            })
            .catch(error => {
                console.error('获取资产数据失败:', error);
                Toast.show('网络异常，获取资产数据失败');
            });
        },

        /** 处理接口响应通用逻辑 */
        handleResponse(response) {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        },

        /** 获取用户Token */
        getToken() {
            try {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                const token = userData.token || '';

                if (!token) {
                    Toast.show('请先登录');
                    return '';
                }
                return token;
            } catch (error) {
                console.error('获取token失败:', error);
                Toast.show('登录状态异常，请重新登录');
                return '';
            }
        }
    };

    // 命名空间：转账相关功能
    const TransferPage = {
        selectedBankCard: null,

        /** 显示转入页面 */
        showTransferIn() {
            const page = document.getElementById('transferInPage');
            page.classList.add('active');
            document.querySelector('.assets-page').style.display = 'none';
            BankCardHandler.initBankCardLists();
        },

        /** 显示转出页面 */
        showTransferOut() {
            const page = document.getElementById('transferOutPage');
            page.classList.add('active');
            document.querySelector('.assets-page').style.display = 'none';
            BankCardHandler.initBankCardLists();
        },

        /** 隐藏全屏页面 */
        hideFullscreenPage(pageId) {
            const page = document.getElementById(pageId);
            page.classList.remove('active');
            document.querySelector('.assets-page').style.display = 'block';
            // 清空输入
            document.getElementById('transferInAmount')?.setValue('');
            document.getElementById('transferOutAmount')?.setValue('');
        },

        /** 选择银行卡 */
        selectBankCard(element) {
            if (!element) return;

            const selectedCardId = element.dataset.cardId;
            if (!selectedCardId) {
                console.error('未找到卡片ID');
                Toast.show('银行卡信息异常');
                return;
            }

            // 移除所有选中状态
            document.querySelectorAll('.bank-card-option').forEach(card => {
                card.classList.remove('selected');
            });

            // 添加当前选中状态
            document.querySelectorAll(`.bank-card-option[data-card-id="${selectedCardId}"]`).forEach(card => {
                card.classList.add('selected');
            });

            this.selectedBankCard = document.querySelector(`.bank-card-option[data-card-id="${selectedCardId}"]`);
        },

        /** 设置快捷金额 */
        setQuickAmount(amount) {
            if (amount <= 0) return;
            document.getElementById('transferOutAmount').value = amount;
        },

        /** 设置全部金额 */
        setAllAmount() {
            const availableBalanceEl = document.getElementById('availableBalance');
            if (!availableBalanceEl) return;

            const currentBalance = parseFloat(availableBalanceEl.textContent.replace('¥', '').replace(/,/g, '')) || 0;
            document.getElementById('transferOutAmount').value = currentBalance.toFixed(2);
        },

        /** 确认转入 */
        confirmTransferIn() {
            // 验证金额
            const amountInput = document.getElementById('transferInAmount');
            const amount = this.validateAmount(amountInput);
            if (!amount) return;

            // 验证银行卡选择
            if (!this.selectedBankCard) {
                Toast.show('请选择银行卡');
                return;
            }

            const bankCardId = this.selectedBankCard.dataset.cardId;
            const bankName = this.selectedBankCard.dataset.bankName;
            if (!bankCardId || !bankName) {
                Toast.show('银行卡信息异常，请重新选择');
                return;
            }

            // 显示密码输入框
            PasswordHandler.showPasswordModal('transfer', {
                bankCardId,
                bankName,
                amount
            });
        },

        /** 确认转出 */
        confirmTransferOut() {
            // 验证金额
            const amountInput = document.getElementById('transferOutAmount');
            const amount = this.validateAmount(amountInput);
            if (!amount) return;

            // 验证金额不超过可用余额
            const availableBalanceEl = document.getElementById('availableBalance');
            if (!availableBalanceEl) {
                Toast.show('未获取到可用余额信息');
                return;
            }

            const currentBalance = parseFloat(availableBalanceEl.textContent.replace('¥', '').replace(/,/g, '')) || 0;
            if (parseFloat(amount) > currentBalance) {
                Toast.show('转出金额不能超过可用余额');
                return;
            }

            // 验证银行卡选择
            if (!this.selectedBankCard) {
                Toast.show('请选择收款银行卡');
                return;
            }

            const bankCardId = this.selectedBankCard.dataset.cardId;
            const bankName = this.selectedBankCard.dataset.bankName;
            if (!bankCardId || !bankName) {
                Toast.show('银行卡信息异常，请重新选择');
                return;
            }

            // 显示密码输入框
            PasswordHandler.showPasswordModal('withdraw', {
                bankCardId,
                bankName,
                amount
            });
        },

        /** 验证金额输入 */
        validateAmount(inputElement) {
            if (!inputElement) return null;

            const amount = inputElement.value.trim();
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                Toast.show('请输入有效的金额');
                inputElement.focus();
                return null;
            }

            return parseFloat(amount).toFixed(2);
        },

        /** 执行转入操作 */
        proceedWithTransfer(params) {
            const { bankCardId, bankName, amount, payPassword } = params;
            if (payPassword.length !== 6) {
                Toast.show('请输入6位数字支付密码');
                return;
            }

            const token = AssetPage.getToken();
            if (!token) return;

            Toast.show('正在处理转入请求...');
            const requestData = {
                bankCardId,
                bankName,
                amount,
                payPassword
            };

            fetch('http://graywolf.top:6031/appassets/assets/topup', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': '*/*'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => AssetPage.handleResponse(response))
            .then(data => {
                if (data.code === 200) {
                    Toast.show('转入成功');
                    this.hideFullscreenPage('transferInPage');
                    document.getElementById('transferInAmount').value = '';
                    AssetPage.fetchAssetSummary();
                    BankCardHandler.initBankCardLists();
                } else {
                    throw new Error(data.message || '转入失败，请重试');
                }
            })
            .catch(error => {
                console.error('转入失败:', error);
                Toast.show(error.message || '网络异常，转入失败');
            });
        },

        /** 执行转出操作 */
        proceedWithTransferOut(params) {
            const { bankCardId, bankName, amount, payPassword } = params;
            if (payPassword.length !== 6) {
                Toast.show('请输入6位数字支付密码');
                return;
            }

            const token = AssetPage.getToken();
            if (!token) return;

            Toast.show('正在提交转出申请...');
            const requestData = {
                bankCardId,
                bankName,
                amount,
                payPassword
            };

            fetch('http://graywolf.top:6031/appassets/assets/withdraw', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': '*/*',
                    'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => AssetPage.handleResponse(response))
            .then(data => {
                if (data.code === 200) {
                    Toast.show('转出申请已提交，预计2小时内到账');
                    this.hideFullscreenPage('transferOutPage');
                    document.getElementById('transferOutAmount').value = '';
                    AssetPage.fetchAssetSummary();
                    BankCardHandler.initBankCardLists();
                } else {
                    throw new Error(data.message || '转出申请提交失败，请重试');
                }
            })
            .catch(error => {
                console.error('转出操作失败:', error);
                Toast.show(error.message || '网络异常，转出失败');
            });
        }
    };

    // 命名空间：银行卡处理相关功能
    const BankCardHandler = {
        /** 初始化所有银行卡列表 */
        initBankCardLists() {
            const containers = document.querySelectorAll('.bank-card-list');
            if (containers.length === 0) {
                console.error('未找到任何银行卡列表容器');
                return;
            }

            // 清空所有容器
            containers.forEach(container => {
                container.innerHTML = '';
            });

            const token = AssetPage.getToken();
            if (!token) return;

            fetch('http://graywolf.top:6031/appassets/assets/cards', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
                    'Accept': '*/*'
                }
            })
            .then(response => AssetPage.handleResponse(response))
            .then(data => {
                if (data.code === 200 && Array.isArray(data.data)) {
                    this.renderBankCardLists(containers, data.data);
                } else {
                    Toast.show(data.message || '获取银行卡列表失败');
                }
            })
            .catch(error => {
                console.error('初始化银行卡列表失败:', error);
                Toast.show('网络异常，获取银行卡失败');
            });
        },

        /** 渲染银行卡列表 */
        renderBankCardLists(containers, bankCards) {
            containers.forEach(container => {
                if (bankCards.length === 0) {
                    container.innerHTML = '<div class="no-card">暂无绑定的银行卡</div>';
                    return;
                }

                bankCards.forEach(card => {
                    const cardOption = document.createElement('div');
                    cardOption.className = 'bank-card-option';
                    cardOption.setAttribute('onclick', 'TransferPage.selectBankCard(this)');
                    cardOption.dataset.cardId = card.id;
                    cardOption.dataset.bankName = card.bankName;

                    cardOption.innerHTML = `
                        <img src="icons/a-32-woyaofukuan.png" alt="银行卡">
                        <div class="card-info">
                            <div class="card-name">${card.bankName || ''}</div>
                            <div class="card-number">****${card.lastFourDigits || ''}</div>
                        </div>
                        <div class="card-balance">余额：***</div>
                    `;

                    container.appendChild(cardOption);
                });
            });
        }
    };

    // 命名空间：密码输入处理
    const PasswordHandler = {
        inputtedPassword: '',
        currentAction: '',
        currentParams: null,

        /** 显示密码输入弹窗 */
        showPasswordModal(action, params) {
            this.inputtedPassword = '';
            this.currentAction = action;
            this.currentParams = params;

            const modal = document.getElementById('passwordModal');
            modal.classList.add('show');
            // 清空输入框并聚焦第一个
            const inputs = document.querySelectorAll('.password-input input');
            inputs.forEach(input => input.value = '');
            inputs[0].focus();
        },

        /** 处理密码输入 */
        nextPasswordInput(input, index) {
            // 只允许数字输入
            input.value = input.value.replace(/\D/g, '');

            if (input.value) {
                // 更新密码字符串
                this.inputtedPassword = this.inputtedPassword.substring(0, index) +
                                       input.value +
                                       this.inputtedPassword.substring(index + 1);

                // 自动聚焦下一个输入框
                if (index < 5) {
                    document.querySelectorAll('.password-input input')[index + 1].focus();
                } else {
                    // 输入完成，执行对应操作
                    this.handlePasswordComplete();
                }
            }
        },

        /** 密码输入完成处理 */
        handlePasswordComplete() {
            const modal = document.getElementById('passwordModal');
            modal.classList.remove('show');

            if (this.currentAction === 'transfer') {
                TransferPage.proceedWithTransfer({
                    ...this.currentParams,
                    payPassword: this.inputtedPassword
                });
            } else if (this.currentAction === 'withdraw') {
                TransferPage.proceedWithTransferOut({
                    ...this.currentParams,
                    payPassword: this.inputtedPassword
                });
            }

            // 重置状态
            this.reset();
        },

        /** 取消密码输入 */
        cancelPasswordInput() {
            const modal = document.getElementById('passwordModal');
            modal.classList.remove('show');
            this.reset();
            Toast.show('已取消操作');
        },

        /** 重置状态 */
        reset() {
            this.inputtedPassword = '';
            this.currentAction = '';
            this.currentParams = null;
            document.querySelectorAll('.password-input input').forEach(input => input.value = '');
        }
    };

    // 命名空间：Toast提示
    const Toast = {
        /** 显示提示 */
        show(message) {
            if (!message) return;

            // 移除已存在的toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                document.body.removeChild(existingToast);
            }

            // 创建新toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            // 显示动画
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // 自动关闭
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }
    };

    // 页面初始化
    document.addEventListener('DOMContentLoaded', () => {
        AssetPage.fetchAssetSummary();
        BankCardHandler.initBankCardLists();

        // 点击模态框背景关闭
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('password-modal')) {
                PasswordHandler.cancelPasswordInput();
            }
        });
    });
</script>
</body>
</html>