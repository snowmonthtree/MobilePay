<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付密码修改 - 移动支付应用</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .payment-password-page {
            padding: 0 0 120px 0;
            background: #f8f9fa;
            min-height: calc(100vh - 40px);
        }

        .placeholder {
            width: 40px;
        }

        .settings-section {
            margin: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .settings-section h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .input-group {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0 12px;
            background: #f9f9f9;
            margin-bottom: 15px;
        }

        .input-group img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .input-group input {
            flex: 1;
            border: none;
            padding: 12px 0;
            background: transparent;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
        }

        .input-group .toggle-password-btn {
            background: none;
            border: none;
            padding: 0;
            margin-left: 10px;
        }

        .input-group .toggle-password-btn img {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .password-tips {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .password-tips h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #666;
        }

        .password-tips ul {
            margin: 0;
            padding-left: 20px;
            font-size: 12px;
            color: #999;
        }

        .password-tips li {
            margin-bottom: 4px;
        }

        .password-tips li.valid {
            color: #4CAF50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
        }

        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .success-modal-content {
            background: white;
            border-radius: 12px;
            width: 85%;
            max-width: 350px;
            overflow: hidden;
            text-align: center;
            padding: 20px;
        }

        .psw-success-icon {
            width: 60px;
            height: 60px;
            margin: 10px auto;
        }

        .success-title {
            font-size: 18px;
            color: #333;
            margin: 10px 0;
        }

        .success-message {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .success-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- 顶部状态栏 -->
        <!-- 页面头部 -->
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">
                <img src="icons/danjiantouzuo.png" alt="返回">
            </button>
            <h1>支付密码修改</h1>
            <div class="placeholder"></div>
        </div>

        <!-- 支付密码修改表单 -->
        <div class="settings-section">
            <div class="form-group">
                <label>当前支付密码</label>
                <div class="input-group">
                    <img src="icons/mima.png" alt="当前支付密码">
                    <input type="password" id="currentPaymentPassword" placeholder="请输入当前支付密码(123456)" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                    <button class="toggle-password-btn" onclick="togglePassword('currentPaymentPassword')">
                        <img id="currentPaymentPasswordEye" src="icons/xianshimima.png" alt="显示密码">
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>新支付密码</label>
                <div class="input-group">
                    <img src="icons/mima.png" alt="新支付密码">
                    <input type="password" id="newPaymentPassword" placeholder="请输入新支付密码" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                    <button class="toggle-password-btn" onclick="togglePassword('newPaymentPassword')">
                        <img id="newPaymentPasswordEye" src="icons/xianshimima.png" alt="显示密码">
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>确认新支付密码</label>
                <div class="input-group">
                    <img src="icons/mima.png" alt="确认新支付密码">
                    <input type="password" id="confirmPaymentPassword" placeholder="请再次输入新支付密码" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                    <button class="toggle-password-btn" onclick="togglePassword('confirmPaymentPassword')">
                        <img id="confirmPaymentPasswordEye" src="icons/xianshimima.png" alt="显示密码">
                    </button>
                </div>
            </div>
            <div class="password-tips">
                <h4>支付密码要求：</h4>
                <ul>
                    <li id="paymentLengthTip">必须为6位数字</li>
                    <li id="paymentNumberOnlyTip">只能包含数字</li>
                </ul>
            </div>
            <button class="btn-primary" onclick="updatePaymentPassword()">确认修改</button>
        </div>
    </div>

    <!-- 修改成功弹窗 -->
    <div class="success-modal" id="successModal">
        <div class="success-modal-content">
            <img src="icons/chenggong.png" alt="成功" class="psw-success-icon">
            <h3 class="success-title">修改成功</h3>
            <p class="success-message">您的支付密码已成功修改</p>
            <button class="success-btn" onclick="goBack()">返回</button>
        </div>
    </div>

    <script>
        // 页面加载时添加输入验证
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('newPaymentPassword').addEventListener('input', validatePaymentPasswordInput);
            document.getElementById('confirmPaymentPassword').addEventListener('input', validatePaymentPasswordInput);
        });

        // 切换密码显示/隐藏
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const eyeIcon = document.getElementById(inputId + 'Eye');

            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.src = 'icons/yincangmima.png';
            } else {
                input.type = 'password';
                eyeIcon.src = 'icons/xianshimima.png';
            }
        }

        // 验证支付密码输入
        function validatePaymentPasswordInput() {
            const newPassword = document.getElementById('newPaymentPassword').value;
            const confirmPassword = document.getElementById('confirmPaymentPassword').value;
            const lengthTip = document.getElementById('paymentLengthTip');
            const numberOnlyTip = document.getElementById('paymentNumberOnlyTip');
            
            // 检查长度
            if (newPassword.length === 6) {
                lengthTip.classList.add('valid');
            } else {
                lengthTip.classList.remove('valid');
            }
            
            // 检查是否只包含数字
            if (/^\d*$/.test(newPassword)) {
                numberOnlyTip.classList.add('valid');
            } else {
                numberOnlyTip.classList.remove('valid');
            }
        }

        // 更新支付密码
        function updatePaymentPassword() {
    // 获取表单数据
    const currentPassword = document.getElementById('currentPaymentPassword').value;
    const newPassword = document.getElementById('newPaymentPassword').value;
    const confirmPassword = document.getElementById('confirmPaymentPassword').value;

    // 前端表单验证
    if (!currentPassword) {
        AndroidInterface.showToast('请输入当前支付密码');
        return;
    }

    if (newPassword.length !== 6) {
        AndroidInterface.showToast('新支付密码必须为6位数字');
        return;
    }

    if (!/^\d{6}$/.test(newPassword)) {
        AndroidInterface.showToast('新支付密码只能包含数字');
        return;
    }

    if (newPassword !== confirmPassword) {
        AndroidInterface.showToast('两次输入的新支付密码不一致');
        return;
    }

    // 获取本地存储的token（用于接口身份验证）
    let token = '';
    try {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        token = userData.token || '';
    } catch (error) {
        console.error('获取token失败:', error);
        AndroidInterface.showToast('登录状态异常，请重新登录');
        return;
    }

    if (!token) {
        AndroidInterface.showToast('请先登录');
        return;
    }

    // 构建请求数据
    const requestData = {
        oldPassword: currentPassword,
        newPassword: newPassword
    };

    // 显示加载状态
    //AndroidInterface.showToast('正在更新支付密码...');

    AndroidInterface.showToast(token);
    // 调用后端更新接口
    fetch('http://graywolf.top:6031/app/user/payment-password/update', {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${token}`, // 携带身份验证token
            'Content-Type': 'application/json',
            'Accept': '*/*'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        // 处理HTTP错误状态（如401未授权、400参数错误等）
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        // 假设接口返回格式为 {code: 200, message: "成功"}
        if (data.code === 200) {
            // 显示成功弹窗
            document.getElementById('successModal').style.display = 'flex';
        } else {
            // 处理业务错误（如旧密码错误）
            AndroidInterface.showToast(data.message || '更新失败，请重试');
        }
    })
    .catch(error => {
        // 处理网络错误或接口异常
        console.error('更新支付密码失败:', error);
        AndroidInterface.showToast(error.message || '网络异常，请检查网络后重试');
    });
}

        // 返回上一页
        function goBack() {
            window.history.back();
        }

        // 点击背景关闭成功弹窗
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('successModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    </script>
</body>

</html>