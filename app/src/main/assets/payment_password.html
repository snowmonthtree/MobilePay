<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付密码修改 - 移动支付应用</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .payment-password-page {
            padding: 0 0 120px 0;
            background: #f8f9fa;
            min-height: calc(100vh - 40px);
        }

        .placeholder {
            width: 40px;
        }

        .settings-section {
            margin: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .settings-section h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .input-group {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0 12px;
            background: #f9f9f9;
            margin-bottom: 15px;
        }

        .input-group img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .input-group input {
            flex: 1;
            border: none;
            padding: 12px 0;
            background: transparent;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
        }

        .input-group .toggle-password-btn {
            background: none;
            border: none;
            padding: 0;
            margin-left: 10px;
        }

        .input-group .toggle-password-btn img {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .password-tips {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .password-tips h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #666;
        }

        .password-tips ul {
            margin: 0;
            padding-left: 20px;
            font-size: 12px;
            color: #999;
        }

        .password-tips li {
            margin-bottom: 4px;
        }

        .password-tips li.valid {
            color: #4CAF50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
        }

        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .success-modal-content {
            background: white;
            border-radius: 12px;
            width: 85%;
            max-width: 350px;
            overflow: hidden;
            text-align: center;
            padding: 20px;
        }

        .psw-success-icon {
            width: 60px;
            height: 60px;
            margin: 10px auto;
        }

        .success-title {
            font-size: 18px;
            color: #333;
            margin: 10px 0;
        }

        .success-message {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .success-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- 顶部状态栏 -->
        <!-- 页面头部 -->
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">
                <img src="icons/danjiantouzuo.png" alt="返回">
            </button>
            <h1>支付密码修改</h1>
            <div class="placeholder"></div>
        </div>

        <!-- 支付密码修改表单 -->
        <div class="settings-section">
            <div class="form-group">
                <label>当前支付密码</label>
                <div class="input-group">
                    <img src="icons/mima.png" alt="当前支付密码">
                    <input type="password" id="currentPaymentPassword" placeholder="请输入当前支付密码(123456)" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                    <button class="toggle-password-btn" onclick="togglePassword('currentPaymentPassword')">
                        <img id="currentPaymentPasswordEye" src="icons/xianshimima.png" alt="显示密码">
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>新支付密码</label>
                <div class="input-group">
                    <img src="icons/mima.png" alt="新支付密码">
                    <input type="password" id="newPaymentPassword" placeholder="请输入新支付密码" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                    <button class="toggle-password-btn" onclick="togglePassword('newPaymentPassword')">
                        <img id="newPaymentPasswordEye" src="icons/xianshimima.png" alt="显示密码">
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>确认新支付密码</label>
                <div class="input-group">
                    <img src="icons/mima.png" alt="确认新支付密码">
                    <input type="password" id="confirmPaymentPassword" placeholder="请再次输入新支付密码" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                    <button class="toggle-password-btn" onclick="togglePassword('confirmPaymentPassword')">
                        <img id="confirmPaymentPasswordEye" src="icons/xianshimima.png" alt="显示密码">
                    </button>
                </div>
            </div>
            <div class="password-tips">
                <h4>支付密码要求：</h4>
                <ul>
                    <li id="paymentLengthTip">必须为6位数字</li>
                    <li id="paymentNumberOnlyTip">只能包含数字</li>
                </ul>
            </div>
            <button class="btn-primary" onclick="updatePaymentPassword()">确认修改</button>
        </div>
    </div>

    <!-- 修改成功弹窗 -->
    <div class="success-modal" id="successModal">
        <div class="success-modal-content">
            <img src="icons/chenggong.png" alt="成功" class="psw-success-icon">
            <h3 class="success-title">修改成功</h3>
            <p class="success-message">您的支付密码已成功修改</p>
            <button class="success-btn" onclick="goBack()">返回</button>
        </div>
    </div>

    <script>
        // 支付密码更新模块：统一封装密码更新相关功能，集中管理状态与逻辑
 const PaymentPasswordModule = {
     // 1. 状态管理：存储模块配置与状态
     state: {
         apiConfig: {
             updateUrl: "http://graywolf.top:6031/app/user/payment-password/update",
             headers: {
                 "Content-Type": "application/json",
                 "Accept": "*/*"
             }
         },
         // DOM元素缓存        elements: {
             newPasswordInput: null,
             confirmPasswordInput: null,
             lengthTip: null,
             numberOnlyTip: null,
             successModal: null
         }
     },

     // 2. 初始化：页面加载后执行所有初始化逻辑
     init() {
         document.addEventListener("DOMContentLoaded", () => {
             this.cacheDomElements(); // 缓存DOM元素引用
             this.bindEvents(); // 绑定事件监听
         });

         // 暴露全局方法：兼容HTML中的onclick调用
         this.exposeGlobalMethods();
     },

     // 缓存DOM元素引用，避免重复查询
     cacheDomElements() {
         this.state.elements.newPasswordInput = document.getElementById("newPaymentPassword");
         this.state.elements.confirmPasswordInput = document.getElementById("confirmPaymentPassword");
         this.state.elements.lengthTip = document.getElementById("paymentLengthTip");
         this.state.elements.numberOnlyTip = document.getElementById("paymentNumberOnlyTip");
         this.state.elements.successModal = document.getElementById("successModal");
     },

     // 绑定事件监听
     bindEvents() {
         // 密码输入验证事件
         if (this.state.elements.newPasswordInput) {
             this.state.elements.newPasswordInput.addEventListener("input", () => this.validatePaymentPasswordInput());
         }
         if (this.state.elements.confirmPasswordInput) {
             this.state.elements.confirmPasswordInput.addEventListener("input", () => this.validatePaymentPasswordInput());
         }

         // 成功弹窗背景点击关闭事件
         document.addEventListener("click", (event) => this.handleModalClick(event));
     },

     // 暴露全局方法
     exposeGlobalMethods() {
         window.togglePassword = (inputId) => this.togglePassword(inputId);
         window.updatePaymentPassword = () => this.updatePaymentPassword();
         window.goBack = () => this.goBack();
     },

     // 3. 密码显示/隐藏切换
     /**
      * 切换密码输入框的显示/隐藏状态
      * @param {string} inputId - 密码输入框ID
      */
     togglePassword(inputId) {
         const input = document.getElementById(inputId);
         const eyeIcon = document.getElementById(`${inputId}Eye`);

         if (!input || !eyeIcon) {
             console.error(`密码切换相关DOM元素缺失（inputId: ${inputId}）`);
             return;
         }

         // 切换输入框类型与图标
         if (input.type === "password") {
             input.type = "text";
             eyeIcon.src = "icons/yincangmima.png";
         } else {
             input.type = "password";
             eyeIcon.src = "icons/xianshimima.png";
         }
     },

     // 4. 密码输入验证
     /**
      * 验证支付密码输入（长度和数字格式）
      */
     validatePaymentPasswordInput() {
         const { newPasswordInput, lengthTip, numberOnlyTip } = this.state.elements;

         // 检查DOM元素是否存在
         if (!newPasswordInput || !lengthTip || !numberOnlyTip) {
             console.error("密码验证相关DOM元素缺失");
             return;
         }

         const newPassword = newPasswordInput.value;

         // 检查长度（6位）
         if (newPassword.length === 6) {
             lengthTip.classList.add("valid");
         } else {
             lengthTip.classList.remove("valid");
         }

         // 检查是否只包含数字
         if (/^\d*$/.test(newPassword)) {
             numberOnlyTip.classList.add("valid");
         } else {
             numberOnlyTip.classList.remove("valid");
         }
     },

     // 5. 更新支付密码（核心功能）
     /**
      * 更新支付密码：表单验证 -> 获取Token -> 调用接口 -> 处理结果
      */
     updatePaymentPassword() {
         // 获取表单数据
         const currentPassword = document.getElementById("currentPaymentPassword")?.value || "";
         const newPassword = this.state.elements.newPasswordInput?.value || "";
         const confirmPassword = this.state.elements.confirmPasswordInput?.value || "";

         // 前端表单验证
         if (!this.validateForm(currentPassword, newPassword, confirmPassword)) {
             return;
         }

         // 获取用户Token
         const token = this.getAuthToken();
         if (!token) {
             this.showToast("请先登录");
             return;
         }

         // 构建请求数据
         const requestData = {
             oldPassword: currentPassword,
             newPassword: newPassword
         };

         // 调用更新接口
         this.callUpdateApi(token, requestData);
     },

     /**
      * 表单验证（统一处理所有验证逻辑）
      * @param {string} currentPassword - 当前密码
      * @param {string} newPassword - 新密码
      * @param {string} confirmPassword - 确认新密码
      * @returns {boolean} 验证是否通过
      */
     validateForm(currentPassword, newPassword, confirmPassword) {
         if (!currentPassword) {
             this.showToast("请输入当前支付密码");
             return false;
         }

         if (newPassword.length !== 6) {
             this.showToast("新支付密码必须为6位数字");
             return false;
         }

         if (!/^\d{6}$/.test(newPassword)) {
             this.showToast("新支付密码只能包含数字");
             return false;
         }

         if (newPassword !== confirmPassword) {
             this.showToast("两次输入的新支付密码不一致");
             return false;
         }

         return true;
     },

     /**
      * 获取用户Token（统一封装，便于错误处理）
      * @returns {string} Token或空字符串
      */
     getAuthToken() {
         try {
             const userData = JSON.parse(localStorage.getItem("userData") || "{}");
             return userData.token || "";
         } catch (error) {
             console.error("获取Token失败:", error);
             this.showToast("登录状态异常，请重新登录");
             return "";
         }
     },

     /**
      * 调用更新支付密码接口
      * @param {string} token - 用户Token
      * @param {Object} data - 请求数据
      */
     callUpdateApi(token, data) {
         this.showToast("正在更新支付密码...");

         fetch(this.state.apiConfig.updateUrl, {
             method: "PUT",
             headers: {
                 ...this.state.apiConfig.headers,
                 "Authorization": `Bearer ${token}`
             },
             body: JSON.stringify(data)
         })
             .then(response => {
                 if (!response.ok) {
                     return response.json().then(err => { throw err; });
                 }
                 return response.json();
             })
             .then(result => {
                 if (result.code === 200) {
                     // 更新成功，显示成功弹窗
                     this.state.elements.successModal?.style.display = "flex";
                 } else {
                     this.showToast(result.message || "更新失败，请重试");
                 }
             })
             .catch(error => {
                 console.error("更新支付密码失败:", error);
                 this.showToast(error.message || "网络异常，请检查网络后重试");
             });
     },

     // 6. 工具方法
     /**
      * 显示提示信息（兼容Android原生与Web）
      * @param {string} message - 提示内容
      */
     showToast(message) {
         if (window.AndroidInterface && typeof AndroidInterface.showToast === "function") {
             AndroidInterface.showToast(message);
         } else {
             // Web环境下的简易提示
             alert(message);
         }
     },

     /**
      * 处理模态框点击事件（点击背景关闭）
      * @param {Event} event - 点击事件对象
      */
     handleModalClick(event) {
         if (event.target === this.state.elements.successModal) {
             this.state.elements.successModal.style.display = "none";
         }
     },

     /**
      * 返回上一页
      */
     goBack() {
         window.history.back();
     }
 };

 // 初始化支付密码更新模块
 PaymentPasswordModule.init();
    </script>
</body>

</html>