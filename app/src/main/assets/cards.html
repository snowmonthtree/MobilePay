<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>卡包 - 移动支付应用</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .nav-item img {
            width: 24px;
            height: 24px;
            filter: opacity(0.7);
        }

        .nav-item.active img {
            filter: brightness(0) invert(1);
        }

        .nav-item span {
            font-size: 14px;
            font-weight: 500;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #e0e0e0;
        }

        .action-btn img {
            width: 20px;
            height: 20px;
        }

        .security-notice {
            display: flex;
            align-items: center;
            background-color: #FFF9E6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            border-left: 4px solid #FFB800;
        }

        .security-notice span {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        /* 添加银行卡页面样式 */
        .add-card-page,
        .unbind-card-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            z-index: 100;
            overflow-y: auto;
        }

        .add-card-content,
        .unbind-card-content {
            padding: 20px;
        }

        .form-tips {
            display: flex;
            align-items: flex-start;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .form-tips.warning {
            background-color: #FFF3F3;
            border-left: 4px solid #FF4D4F;
        }

        .card-info-display {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .bank-logo-large {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
        }

        .bank-logo-large img {
            width: 30px;
            height: 30px;
        }

        .card-details-large h3 {
            font-size: 18px;
            margin-bottom: 4px;
            color: #333;
        }

        .card-details-large p {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>

<body>
<div class="app-container">
    <!-- 顶部状态栏 -->

    <!-- 卡包页面 -->
    <div class="cards-page" id="cardsPage">
        <!-- 头部 -->
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">
                <img src="icons/danjiantouzuo.png" alt="返回">
            </button>
            <h1>卡包</h1>
            <div class="header-placeholder"></div>
        </div>

        <!-- 银行卡页面 -->
        <div class="bank-cards-section" id="bankCardsSection">
            <div class="section-header">
                <h2>我的银行卡</h2>
                <button class="add-btn" onclick="addBankCard()">
                    <img src="icons/a-tianjia.png" alt="添加">
                    <span>添加银行卡</span>
                </button>
            </div>

            <div class="cards-list" id="bankCardsContainer">
                <!-- 银行卡项 -->
                <div class="loading" style="text-align: center;
    padding: 20px;
    color: #666;" id="loadingIndicator">...</div>
            </div>
        </div>
    </div>

    <!-- 添加银行卡页面 -->
    <div class="add-card-page" id="addCardPage" style="display: none;">
        <div class="page-header">
            <button class="back-btn" onclick="hideAddCardPage()">
                <img src="icons/danjiantouzuo.png" alt="返回">
            </button>
            <h1>添加银行卡</h1>
            <div class="header-placeholder"></div>
        </div>
        <div class="add-card-content">
            <div class="form-group">
                <label>持卡人姓名</label>
                <input type="text" id="cardHolderName" placeholder="请输入持卡人姓名">
            </div>
            <div class="form-group">
                <label>银行卡号</label>
                <input type="text" id="cardNumber" placeholder="请输入银行卡号" maxlength="19">
            </div>
            <div class="form-group">
                <label>开户行</label>
                <input type="text" id="bankName" placeholder="请输入银行卡的开户行" >
            </div>
            <div class="form-group">
                <label>手机号</label>
                <input type="tel" id="phoneNumber" placeholder="请输入预留手机号">
            </div>
            <div class="form-group">
                <label>验证码</label>
                <div class="verification-input">
                    <input type="text" id="verificationCode" placeholder="请输入验证码">
                    <button class="send-code-btn" onclick="sendVerificationCode()">发送验证码</button>
                </div>
            </div>
            <div class="form-tips">
                <img src="icons/tixinglaba.png" alt="提示" style="width: 16px; height: 16px; margin-right: 8px;">
                <span>银行卡信息仅用于支付验证，我们将严格保障您的信息安全</span>
            </div>
            <button class="btn-primary" onclick="confirmAddCard()">确认添加</button>
        </div>
    </div>
    <!-- 解绑银行卡页面 -->
    <div class="unbind-card-page" id="unbindCardPage" style="display: none;">
        <div class="page-header">
            <button class="back-btn" onclick="hideUnbindCardPage()">
                <img src="icons/danjiantouzuo.png" alt="返回">
            </button>
            <h1>解绑银行卡</h1>
            <div class="header-placeholder"></div>
        </div>
        <div class="unbind-card-content">
            <div class="card-info-display">
                <div class="bank-logo-large">
                    <img src="icons/zhifujiekou.png" alt="银行">
                </div>
                <div class="card-details-large">
                    <h3 id="unbindCardBankName">中国银行</h3>
                    <p id="unbindCardNumber">储蓄卡 ****1234</p>
                </div>
            </div>

            <div class="security-notice">
                <img src="icons/tixinglaba.png" alt="提示" style="width: 20px; height: 20px; margin-right: 8px;">
                <span>为保障账户安全，解绑银行卡需要进行身份验证</span>
            </div>

            <div class="form-group">
                <label>验证码</label>
                <div class="verification-input">
                    <input type="text" id="unbindVerificationCode" placeholder="请输入验证码">
                    <button class="send-code-btn" onclick="sendUnbindVerificationCode()">发送验证码</button>
                </div>
            </div>

            <div class="form-tips warning">
                <img src="icons/sanjiaojingshi-copy.png" alt="警告"
                     style="width: 16px; height: 16px; margin-right: 8px;">
                <span>解绑后，该银行卡将无法用于支付和提现，请谨慎操作</span>
            </div>

            <button class="btn-primary danger" onclick="confirmUnbindCard()">确认解绑</button>
        </div>
    </div>
</div>

<script src="script.js"></script>
<script>
    // 卡包页面模块：统一封装，避免全局变量污染，保持原有功能与样式
const CardPackageModule = {
    // 1. 状态管理：集中存储模块内关键状态
    state: {
        // 解绑银行卡临时数据（避免使用window全局变量）
        unbindTempData: {
            cardId: null,
            cardPhone: null,
            cardElement: null
        },
        // 接口基础配置（便于后续维护）
        apiConfig: {
            baseUrl: 'http://graywolf.top:6031/appassets/assets',
            headers: {
                'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
                'Accept': '*/*'
            }
        }
    },

    // 2. 初始化：页面加载后执行所有初始化逻辑
    init() {
        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            this.fetchBankCards(); // 加载银行卡列表
        });

        // 暴露全局方法：兼容原有HTML中的onclick调用
        this.exposeGlobalMethods();
    },

    // 暴露全局方法：确保HTML中onclick可正常触发
    exposeGlobalMethods() {
        window.showBankCards = () => this.showBankCards();
        window.showCoupons = () => this.showCoupons();
        window.addBankCard = () => this.addBankCard();
        window.hideAddCardPage = () => this.hideAddCardPage();
        window.addCoupon = () => this.addCoupon();
        window.setDefaultCard = (cardId) => this.setDefaultCard(cardId);
        window.removeCard = (cardId) => this.removeCard(cardId);
        window.hideUnbindCardPage = () => this.hideUnbindCardPage();
        window.confirmUnbindCard = () => this.confirmUnbindCard();
        window.filterCoupons = (status) => this.filterCoupons(status);
        window.viewCouponDetail = (coupon) => this.viewCouponDetail(coupon);
        window.sendVerificationCode = (event) => this.sendVerificationCode(event);
        window.sendUnbindVerificationCode = (event) => this.sendUnbindVerificationCode(event);
        window.confirmAddCard = () => this.confirmAddCard();
        window.goBack = () => this.goBack();
    },

    // 3. 银行卡核心功能：获取与渲染
    /**
     * 获取银行卡列表（调用接口）
     */
    fetchBankCards() {
        // 获取Token（统一封装工具方法）
        const token = this.getAuthToken();
        if (!token) {
            this.showLoading(false);
            this.showToast('登录状态异常，无法获取银行卡');
            return;
        }

        // 显示加载状态
        this.showLoading(true);

        // 调用银行卡列表接口
        fetch(`${this.state.apiConfig.baseUrl}/cards`, {
            method: 'GET',
            headers: {
                ...this.state.apiConfig.headers,
                'Authorization': `Bearer ${token}`
            }
        })
            .then(response => this.handleApiResponse(response))
            .then(data => {
                this.showLoading(false);
                const cardsList = data.data || [];
                // 渲染列表或空状态
                Array.isArray(cardsList) && cardsList.length > 0
                    ? this.renderBankCards(cardsList)
                    : this.renderEmptyState();
            })
            .catch(error => {
                this.showLoading(false);
                console.error('获取银行卡失败:', error);
                this.showToast(error.message || '获取银行卡失败，请重试');
                this.renderEmptyState();
            });
    },

    /**
     * 渲染银行卡列表（适配接口返回字段）
     * @param {Array} cards - 接口返回的cardsShowV0数组
     */
    renderBankCards(cards) {
        const container = document.getElementById('bankCardsContainer');
        if (!container) return;

        // 清空容器
        container.innerHTML = '';

        // 遍历生成银行卡DOM
        cards.forEach(card => {
            const cardItem = document.createElement('div');
            cardItem.className = 'card-item';
            // 存储卡片关键数据（用于后续操作）
            cardItem.dataset.cardId = card.id;
            cardItem.dataset.cardPhone = card.cardPhone || '';

            // 拼接卡片HTML（保留原有样式与结构）
            cardItem.innerHTML = `
                <div class="card-info">
                    <div class="bank-logo">
                        <img src="icons/zhifujiekou.png" alt="${card.bankName || '银行图标'}">
                    </div>
                    <div class="card-details">
                        <h3>${card.bankName || '未知银行'}</h3>
                        <p>${card.typeName || '储蓄卡'} ****${card.lastFourDigits || ''}</p>
                        ${card.status === 1 ? '<span class="default-tag">默认</span>' : ''}
                    </div>
                </div>
                <div class="card-actions">
                    <button class="action-btn" onclick="setDefaultCard('${card.id}')">
                        <img src="icons/a-qiehuanmoren.png" alt="设为默认">
                    </button>
                    <button class="action-btn" onclick="removeCard('${card.id}')">
                        <img src="icons/shanchu.png" alt="删除">
                    </button>
                </div>
            `;

            container.appendChild(cardItem);
        });
    },

    /**
     * 渲染无银行卡空状态
     */
    renderEmptyState() {
        const container = document.getElementById('bankCardsContainer');
        if (!container) return;

        container.innerHTML = `
            <div class="empty-state">
                <p style="text-align:center">暂无绑定的银行卡</p>
            </div>
        `;
    },

    // 4. 页面切换与导航功能
    /**
     * 切换到银行卡列表视图
     */
    showBankCards() {
        // 修复原代码event未定义问题
        const event = window.event;
        if (!event) return;

        // 切换导航激活状态
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        event.target.closest('.nav-item').classList.add('active');

        // 切换视图显示
        document.getElementById('bankCardsSection').style.display = 'block';
        document.getElementById('couponsSection').style.display = 'none';
    },

    /**
     * 切换到优惠券列表视图
     */
    showCoupons() {
        const event = window.event;
        if (!event) return;

        // 切换导航激活状态
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        event.target.closest('.nav-item').classList.add('active');

        // 切换视图显示
        document.getElementById('bankCardsSection').style.display = 'none';
        document.getElementById('couponsSection').style.display = 'block';
    },

    /**
     * 跳转到添加银行卡页面
     */
    addBankCard() {
        document.getElementById('cardsPage').style.display = 'none';
        document.getElementById('addCardPage').style.display = 'block';
    },

    /**
     * 隐藏添加银行卡页面，返回卡包主页
     */
    hideAddCardPage() {
        document.getElementById('addCardPage').style.display = 'none';
        document.getElementById('cardsPage').style.display = 'block';
    },

    /**
     * 显示添加优惠券弹窗
     */
    addCoupon() {
        const modal = document.getElementById('addCouponModal');
        if (modal) modal.style.display = 'flex';
    },

    /**
     * 隐藏解绑银行卡页面，返回卡包主页
     */
    hideUnbindCardPage() {
        document.getElementById('unbindCardPage').style.display = 'none';
        document.getElementById('cardsPage').style.display = 'block';
        // 清空临时解绑数据
        this.state.unbindTempData = { cardId: null, cardPhone: null, cardElement: null };
    },

    /**
     * 返回上一页
     */
    goBack() {
        window.history.back();
    },

    // 5. 银行卡操作功能（设为默认、解绑、添加）
    /**
     * 设置银行卡为默认支付方式
     * @param {string|number} cardId - 银行卡ID
     */
    setDefaultCard(cardId) {
        // 兼容Android原生交互（保留原有逻辑）
        if (window.AndroidInterface && typeof window.AndroidInterface.showToast === 'function') {
            window.AndroidInterface.showToast(cardId.toString());
        }

        const token = this.getAuthToken();
        if (!token) return;

        // 显示操作提示
        this.showToast('正在设置默认银行卡...');

        // 调用设为默认接口
        fetch(`${this.state.apiConfig.baseUrl}/cards/default?id=${cardId}`, {
            method: 'PUT',
            headers: {
                ...this.state.apiConfig.headers,
                'Authorization': `Bearer ${token}`
            }
        })
            .then(response => this.handleApiResponse(response))
            .then(data => {
                this.updateDefaultCardUI(cardId); // 更新UI显示
                this.showToast('已设为默认支付方式');
            })
            .catch(error => {
                console.error('设置默认银行卡失败:', error);
                this.showToast(error.message || '设置失败，请重试');
            });
    },

    /**
     * 更新默认银行卡UI显示（移除旧默认标签，添加新标签）
     * @param {string|number} activeCardId - 新默认银行卡ID
     */
    updateDefaultCardUI(activeCardId) {
        // 移除所有卡片的默认标签
        document.querySelectorAll('.default-tag').forEach(tag => tag.remove());

        // 给目标卡片添加默认标签
        const targetCard = document.querySelector(`.card-item[data-card-id="${activeCardId}"]`);
        if (targetCard) {
            const cardDetails = targetCard.querySelector('.card-details');
            const defaultTag = document.createElement('span');
            defaultTag.className = 'default-tag';
            defaultTag.textContent = '默认';
            cardDetails.appendChild(defaultTag);
        }
    },

    /**
     * 触发银行卡解绑流程（跳转解绑页面并携带卡片信息）
     * @param {string|number} cardId - 待解绑银行卡ID
     */
    removeCard(cardId) {
        // 查找待解绑卡片元素
        const cardItem = document.querySelector(`.card-item[data-card-id="${cardId}"]`);
        if (!cardItem) {
            this.showToast('未找到该银行卡信息');
            return;
        }

        // 存储解绑临时数据（替代window全局变量）
        this.state.unbindTempData = {
            cardId: cardId,
            cardPhone: cardItem.dataset.cardPhone || '',
            cardElement: cardItem
        };

        // 提取卡片信息用于解绑页面显示
        const bankName = cardItem.querySelector('.card-details h3').textContent || '未知银行';
        const cardNumber = cardItem.querySelector('.card-details p').textContent || '未知卡号';

        // 填充解绑页面信息
        document.getElementById('unbindCardBankName').textContent = bankName;
        document.getElementById('unbindCardNumber').textContent = cardNumber;

        // 切换到解绑页面
        document.getElementById('cardsPage').style.display = 'none';
        document.getElementById('unbindCardPage').style.display = 'block';
    },

    /**
     * 确认解绑银行卡（验证验证码+调用解绑接口）
     */
    confirmUnbindCard() {
        // 1. 校验临时解绑数据
        const { cardId, cardPhone, cardElement } = this.state.unbindTempData;
        if (!cardId || !cardPhone || !cardElement) {
            this.showToast('未获取到银行卡信息，请重试');
            return;
        }

        // 2. 校验验证码输入
        const verificationCode = document.getElementById('unbindVerificationCode').value.trim();
        if (!this.validateVerificationCode(verificationCode)) return;

        // 3. 获取Token
        const token = this.getAuthToken();
        if (!token) return;

        // 4. 第一步：验证验证码
        this.showToast('正在验证验证码...');
        const verifyData = {
            phone: cardPhone,
            verifyCode: verificationCode
        };

        fetch(`${this.state.apiConfig.baseUrl}/cards/verifyCode`, {
            method: 'POST',
            headers: {
                ...this.state.apiConfig.headers,
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(verifyData)
        })
            .then(response => this.handleApiResponse(response))
            .then(() => {
                // 验证码验证通过，调用解绑接口
                this.showToast('验证码验证通过，正在解绑银行卡...');
                return fetch(`${this.state.apiConfig.baseUrl}/cards?id=${cardId}`, {
                    method: 'DELETE',
                    headers: {
                        ...this.state.apiConfig.headers,
                        'Authorization': `Bearer ${token}`
                    }
                });
            })
            .then(response => this.handleApiResponse(response))
            .then(() => {
                // 解绑成功，更新页面
                cardElement.remove(); // 移除卡片DOM
                this.showToast('银行卡已成功解绑');
                this.hideUnbindCardPage(); // 返回卡包主页
                document.getElementById('unbindVerificationCode').value = ''; // 清空验证码
                this.fetchBankCards(); // 刷新银行卡列表（确保数据一致性）
            })
            .catch(error => {
                console.error('解绑银行卡失败:', error);
                this.showToast(error.message || '操作失败，请检查信息或网络');
            });
    },

    /**
     * 确认添加银行卡（验证验证码+调用添加接口）
     */
    confirmAddCard() {
        // 1. 获取并校验表单数据
        const formData = this.getAddCardFormData();
        if (!formData) return;

        // 2. 获取Token
        const token = this.getAuthToken();
        if (!token) return;

        // 3. 第一步：验证验证码
        this.showToast('正在验证验证码...');
        const verifyData = {
            phone: formData.phone,
            verifyCode: formData.code
        };

        fetch(`${this.state.apiConfig.baseUrl}/cards/verifyCode`, {
            method: 'POST',
            headers: {
                ...this.state.apiConfig.headers,
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(verifyData)
        })
            .then(response => this.handleApiResponse(response))
            .then(() => {
                // 验证码验证通过，调用添加接口
                this.showToast('验证码验证通过，正在添加银行卡...');
                const addCardData = {
                    cardName: formData.name,
                    cardPhone: formData.phone,
                    bankName: formData.bankName,
                    cardNumber: formData.cardNumber,
                    type: 1 // 业务固定值
                };

                return fetch(`${this.state.apiConfig.baseUrl}/cards`, {
                    method: 'POST',
                    headers: {
                        ...this.state.apiConfig.headers,
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(addCardData)
                });
            })
            .then(response => this.handleApiResponse(response))
            .then(() => {
                // 添加成功，更新页面
                this.showToast('银行卡添加成功');
                this.hideAddCardPage(); // 返回卡包主页
                this.clearAddCardForm(); // 清空表单
                this.fetchBankCards(); // 刷新银行卡列表
            })
            .catch(error => {
                console.error('添加银行卡失败:', error);
                this.showToast(error.message || '操作失败，请检查信息或网络');
            });
    },

    // 6. 优惠券相关功能
    /**
     * 筛选优惠券（按状态：全部/可用/已过期）
     * @param {string} status - 筛选状态（all/available/expired）
     */
    filterCoupons(status) {
        const event = window.event;
        if (!event) return;

        // 切换筛选按钮激活状态
        document.querySelectorAll('.card-filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // 筛选优惠券显示/隐藏
        document.querySelectorAll('.coupon-item').forEach(coupon => {
            if (status === 'all' || coupon.dataset.status === status) {
                coupon.style.display = 'flex';
            } else {
                coupon.style.display = 'none';
            }
        });
    },

    /**
     * 查看优惠券详情（弹窗显示）
     * @param {HTMLElement} coupon - 优惠券DOM元素
     */
    viewCouponDetail(coupon) {
        // 提取优惠券信息
        const amount = coupon.querySelector('.coupon-amount').textContent.replace('¥', '') || '0';
        const condition = coupon.querySelector('.coupon-condition').textContent.replace('满', '').replace('可用', '') || '无门槛';
        const title = coupon.querySelector('h3').textContent || '未知优惠券';
        const description = coupon.querySelector('p').textContent || '无使用说明';
        const expire = coupon.querySelector('.expire-date').textContent || '永久有效';

                // 填充详情弹窗
        document.getElementById('detailAmount').textContent = amount;
        document.getElementById('detailCondition').textContent = condition;
        document.getElementById('detailTitle').textContent = title;
        document.getElementById('detailDescription').textContent = description;
        document.getElementById('detailExpire').textContent = expire;

        // 显示详情弹窗
        document.getElementById('couponDetailModal').style.display = 'flex';
    },

    // 7. 验证码相关功能
    /**
     * 发送添加银行卡验证码
     * @param {Event} event - 点击事件对象
     */
    sendVerificationCode(event) {
        const button = event.target;
        // 获取表单数据
        const phoneNumber = document.getElementById('phoneNumber').value.trim();
        const cardNumber = document.getElementById('cardNumber').value.trim();

        // 前端表单验证
        if (!phoneNumber) {
            this.showToast('请先输入手机号');
            return;
        }
        if (!cardNumber) {
            this.showToast('请输入银行卡号');
            return;
        }
        if (!/^\d{16,19}$/.test(cardNumber)) {
            this.showToast('请输入正确的银行卡号（16-19位数字）');
            return;
        }

        // 避免重复发送
        if (button.disabled) return;

        // 获取Token
        const token = this.getAuthToken();
        if (!token) return;

        // 构建请求数据
        const requestData = {
            phone: phoneNumber,
            cardNumber: cardNumber
        };

        // 调用发送验证码接口
        this.showToast('正在发送验证码...');
        fetch(`${this.state.apiConfig.baseUrl}/cards/sendverifyCode`, {
            method: 'POST',
            headers: {
                ...this.state.apiConfig.headers,
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
            .then(response => this.handleApiResponse(response))
            .then(data => {
                // 发送成功，开始倒计时
                this.showToast('验证码已发送，请注意查收');
                this.startCountdown(button);

                // 兼容Android原生交互
                if (window.AndroidInterface && typeof window.AndroidInterface.showToast === 'function') {
                    window.AndroidInterface.showToast(data.data?.code || '');
                }
            })
            .catch(error => {
                console.error('发送验证码失败:', error);
                this.showToast(error.message || '网络异常，发送失败');
                button.disabled = false;
                button.textContent = '发送验证码';
            });
    },

    /**
     * 发送解绑银行卡验证码
     * @param {Event} event - 点击事件对象
     */
    sendUnbindVerificationCode(event) {
        const button = event.target;
        const { cardPhone } = this.state.unbindTempData;

        // 校验临时数据
        if (!cardPhone) {
            this.showToast('未获取到银行卡信息，请重试');
            return;
        }

        // 避免重复发送
        if (button.disabled) return;

        // 获取Token
        const token = this.getAuthToken();
        if (!token) return;

        // 构建请求数据
        const requestData = {
            phone: cardPhone,
            cardNumber: '0123456789123456' // 占位符，实际应从卡片数据获取
        };

        // 调用发送验证码接口
        this.showToast('正在发送验证码...');
        fetch(`${this.state.apiConfig.baseUrl}/cards/sendverifyCode`, {
            method: 'POST',
            headers: {
                ...this.state.apiConfig.headers,
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
            .then(response => this.handleApiResponse(response))
            .then(data => {
                // 发送成功，开始倒计时
                this.startCountdown(button);
                // 显示脱敏手机号提示
                const maskedPhone = cardPhone.replace(/^(\d{3})\d{4}(\d{4})$/, '$1****$2');
                this.showToast(`验证码已发送至${maskedPhone}`);

                // 兼容Android原生交互
                if (window.AndroidInterface && typeof window.AndroidInterface.showToast === 'function') {
                    window.AndroidInterface.showToast(data.data?.code || '');
                }
            })
            .catch(error => {
                console.error('发送验证码失败:', error);
                this.showToast(error.message || '网络异常，发送失败');
                button.disabled = false;
                button.textContent = '发送验证码';
            });
    },

    // 8. 工具方法：通用功能封装
    /**
     * 获取用户Token（统一封装，便于维护）
     * @returns {string} 用户Token或空字符串
     */
    getAuthToken() {
        try {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            return userData.token || '';
        } catch (error) {
            console.error('获取token失败:', error);
            this.showToast('登录状态异常，请重新登录');
            return '';
        }
    },

    /**
     * 处理API响应（统一错误处理）
     * @param {Response} response - 接口响应对象
     * @returns {Promise} 解析后的响应数据
     */
    handleApiResponse(response) {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || `请求失败: ${response.status}`);
            });
        }
        return response.json().then(data => {
            if (data.code !== 200) {
                throw new Error(data.message || '接口返回业务错误');
            }
            return data;
        });
    },

    /**
     * 显示/隐藏加载状态
     * @param {boolean} show - 是否显示加载状态
     */
    showLoading(show) {
        const loading = document.getElementById('loadingIndicator');
        if (loading) {
            loading.style.display = show ? 'block' : 'none';
        }
    },

    /**
     * 显示Toast提示
     * @param {string} message - 提示内容
     */
    showToast(message) {
        // 移除现有Toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            document.body.removeChild(existingToast);
        }

        // 创建新Toast
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        // 保留原有样式
        toast.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 14px;
        `;

        // 添加到页面并自动移除
        document.body.appendChild(toast);
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 2000);
    },

    /**
     * 验证码倒计时
     * @param {HTMLElement} button - 按钮元素
     */
    startCountdown(button) {
        let countdown = 60;
        button.disabled = true;
        button.textContent = `${countdown}s后重发`;

        const timer = setInterval(() => {
            countdown--;
            button.textContent = `${countdown}s后重发`;
            if (countdown <= 0) {
                clearInterval(timer);
                button.disabled = false;
                button.textContent = '发送验证码';
            }
        }, 1000);
    },

    /**
     * 验证验证码格式（6位数字）
     * @param {string} code - 验证码
     * @returns {boolean} 是否验证通过
     */
    validateVerificationCode(code) {
        if (!code) {
            this.showToast('请输入验证码');
            return false;
        }
        if (code.length !== 6 || !/^\d{6}$/.test(code)) {
            this.showToast('请输入6位数字验证码');
            return false;
        }
        return true;
    },

    /**
     * 获取并验证添加银行卡表单数据
     * @returns {Object|boolean} 表单数据或false（验证失败）
     */
    getAddCardFormData() {
        const name = document.getElementById('cardHolderName').value.trim();
        const cardNumber = document.getElementById('cardNumber').value.trim();
        const phone = document.getElementById('phoneNumber').value.trim();
        const code = document.getElementById('verificationCode').value.trim();
        const bankName = document.getElementById('bankName').value.trim();

        // 验证必填项
        if (!name || !cardNumber || !phone || !code || !bankName) {
            this.showToast('请填写完整信息');
            return false;
        }

        // 验证卡号格式
        if (!/^\d{16,19}$/.test(cardNumber)) {
            this.showToast('请输入正确的银行卡号（16-19位数字）');
            return false;
        }

        // 验证验证码格式
        if (!this.validateVerificationCode(code)) {
            return false;
        }

        return { name, cardNumber, phone, code, bankName };
    },

    /**
     * 清空添加银行卡表单
     */
    clearAddCardForm() {
        document.getElementById('cardHolderName').value = '';
        document.getElementById('cardNumber').value = '';
        document.getElementById('phoneNumber').value = '';
        document.getElementById('verificationCode').value = '';
        // 保留银行名称选择（可选）
    }
};

// 初始化卡包模块
CardPackageModule.init();
</script>
</body>

</html>