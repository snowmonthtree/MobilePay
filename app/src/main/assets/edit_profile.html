<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>修改个人信息 - 移动支付应用</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        .edit-profile-page {
            padding: 0 0 120px 0;
            background: #f8f9fa;
            min-height: calc(100vh - 40px);
        }

        /* 信息项样式 */
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-item-left {
            font-size: 15px;
            color: #666;
        }

        .info-item-right {
            display: flex;
            align-items: center;
        }

        .info-item-value {
            font-size: 15px;
            color: #333;
            margin-right: 10px;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 编辑区域样式 */
        .edit-area {
            display: none;
            padding-top: 15px;
        }

        .placeholder {
            width: 40px;
        }

        .form-section {
            margin: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .form-section h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .edit-area .form-group {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 0px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
        }

        .avatar-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #667eea;
            margin: 0px;
        }

        .change-avatar-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }

        .input-group {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0 12px;
            background: #f9f9f9;
        }

        .input-group img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .input-group input {
            flex: 1;
            border: none;
            padding: 12px 0;
            background: transparent;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
        }

        .input-group .send-code-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        .input-group .send-code-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* 不可修改输入框组样式 */
        .readonly-group {
            /* 浅灰色背景，与可编辑区域区分 */
            background: #e9e9e9;
            /* 更浅的边框色 */
            border-color: #e0e0e0;
        }

        /* 不可修改输入框样式 */
        .readonly-group input[readonly] {
            /* 鼠标悬停显示禁止图标 */
            cursor: not-allowed;
            /* 文字颜色稍浅，弱化视觉权重 */
            color: #666;
        }

        .toggle-password-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        .toggle-password-btn img {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .info-text {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }

        /* 安全项目样式 */
        .security-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .security-item:last-child {
            border-bottom: none;
        }

        .security-item-left {
            display: flex;
            align-items: center;
        }

        .security-item-left img {
            width: 24px;
            height: 24px;
            margin-right: 12px;
        }

        .security-item-left span {
            font-size: 15px;
            color: #333;
        }

        .arrow-icon {
            width: 16px;
            height: 16px;
            opacity: 0.5;
        }

        /* 手机号和密码弹窗样式 */
        .modal-form {
            padding: 0 15px 15px;
        }

        .modal-form .form-group {
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
<div class="app-container">
    <!-- 顶部状态栏 -->

    <!-- 修改个人信息页面 -->
    <div class="edit-profile-page">
        <!-- 页面头部 -->
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">
                <img src="icons/danjiantouzuo.png" alt="返回" />
            </button>
            <h1 class="page-title">修改个人信息</h1>
            <div class="placeholder"></div>
        </div>

        <div id="profilePage">
            <!-- 表单内容 -->
            <div class="form-section">
                <h3>基本信息</h3>
                <div class="form-group">
                    <!-- 头像信息项 -->
                    <div class="info-item" onclick="toggleEditArea('avatarEdit')">
                        <div class="info-item-left">头像</div>
                        <div class="info-item-right">
                            <img id="userAvatar" src="icons/a-29-gerenxinxi.png" alt="用户头像" class="user-avatar"
                                 style="width: 40px; height: 40px; border-radius: 50%" />
                            <img src="icons/danjiantouyou.png" alt="编辑" class="arrow-icon" />
                        </div>
                    </div>

                    <!-- 用户名信息项 -->
                    <div class="info-item" onclick="toggleEditArea('usernameEdit')">
                        <div class="info-item-left">用户名</div>
                        <div class="info-item-right">
                            <div id="usernameDisplay" class="info-item-value">
                                加载中...
                            </div>
                            <img src="icons/danjiantouyou.png" alt="编辑" class="arrow-icon" />
                        </div>
                    </div>

                    <!-- 手机号信息项 -->
                    <div class="info-item" onclick="toggleEditArea('phoneEdit')">
                        <div class="info-item-left">手机号</div>
                        <div class="info-item-right">
                            <div id="phoneDisplay" class="info-item-value">加载中...</div>
                            <img src="icons/danjiantouyou.png" alt="编辑" class="arrow-icon" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>账户安全</h3>
                <div class="form-group">
                    <!-- 密码信息项 -->
                    <div class="info-item" onclick="toggleEditArea('passwordEdit')">
                        <div class="info-item-left">登录密码</div>
                        <div class="info-item-right">
                            <div class="info-item-value">已设置</div>
                            <img src="icons/danjiantouyou.png" alt="编辑" class="arrow-icon" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑区域 -->
        <div class="form-section" id="editProfilePage" style="display: none">
            <!-- 头像编辑区域 -->
            <div id="avatarEdit" class="edit-area">
                <div class="avatar-container">
                    <img id="userAvatarLarge" src="icons/a-29-gerenxinxi.png" alt="用户头像" class="user-avatar" />
                    <button class="change-avatar-btn" style="margin-top: 20px" onclick="changeAvatar()">
                        更换头像
                    </button>
                </div>
            </div>

            <!-- 用户名编辑区域 -->
            <div id="usernameEdit" class="edit-area">
                <div class="input-group">
                    <img src="icons/a-29-gerenxinxi.png" alt="用户名" />
                    <input type="text" id="username" placeholder="请输入用户名" />
                </div>
                <button class="btn-primary" style="margin-top: 20px" onclick="saveUsername()">
                    保存
                </button>
            </div>

            <!-- 手机号编辑区域 -->
            <div id="phoneEdit" class="edit-area">
                <div class="input-group readonly-group">
                    <img src="icons/shoujihao.png" alt="当前手机号" />
                    <input type="tel" id="currentPhone" readonly />
                </div>
                <p class="info-text">当前绑定的手机号码</p>

                <div class="input-group" style="margin-top: 15px">
                    <img src="icons/shoujihao.png" alt="新手机号" />
                    <input type="tel" id="newPhone" placeholder="请输入新手机号" maxlength="11" />
                </div>

                <div class="input-group" style="margin-top: 15px">
                    <img src="icons/mima.png" alt="验证码" />
                    <input type="text" id="verifyCode" placeholder="请输入验证码" maxlength="6" />
                    <button class="send-code-btn" id="sendCodeBtn" onclick="sendVerifyCode()">
                        发送验证码
                    </button>
                </div>

                <button class="btn-primary" style="margin-top: 20px" onclick="updatePhone()">
                    保存
                </button>
            </div>

            <!-- 密码编辑区域 -->
            <div id="passwordEdit" class="edit-area">
                <div class="form-group">
                    <label>当前密码</label>
                    <div class="input-group">
                        <img src="icons/mima.png" alt="当前密码" />
                        <input type="password" id="currentPassword" placeholder="请输入当前密码(123456)" />
                        <button class="toggle-password-btn" onclick="togglePassword('currentPassword')">
                            <img id="currentPasswordEye" src="icons/xianshimima.png" alt="显示密码" />
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>新密码</label>
                    <div class="input-group">
                        <img src="icons/mima.png" alt="新密码" />
                        <input type="password" id="newPassword" placeholder="请输入新密码" />
                        <button class="toggle-password-btn" onclick="togglePassword('newPassword')">
                            <img id="newPasswordEye" src="icons/xianshimima.png" alt="显示密码" />
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>确认新密码</label>
                    <div class="input-group">
                        <img src="icons/mima.png" alt="确认新密码" />
                        <input type="password" id="confirmPassword" placeholder="请再次输入新密码" />
                        <button class="toggle-password-btn" onclick="togglePassword('confirmPassword')">
                            <img id="confirmPasswordEye" src="icons/xianshimima.png" alt="显示密码" />
                        </button>
                    </div>
                </div>

                <button class="btn-primary" style="margin-top: 20px" onclick="updatePassword()">
                    保存
                </button>
            </div>
        </div>
    </div>
</div>

<script src="script.js"></script>
<script>
    // 个人信息管理模块：统一封装，避免全局变量污染，保持功能完整性
const ProfileModule = {
    // 1. 状态管理：集中存储模块内关键状态（替代全局变量）
    state: {
        codeCountdown: 0,
        verificationCode: "",
        avatarChanged: false,
        selectedAvatar: "icons/a-29-gerenxinxi.png",
        currentEditArea: null,
        // 接口基础配置：便于后续维护与修改
        apiConfig: {
            baseUrl: "http://graywolf.top:6031/app",
            defaultAvatar: "icons/default-avatar.png",
            headers: {
                "User-Agent": "Apifox/1.0.0 (https://apifox.com)",
                "Accept": "*/*"
            }
        }
    },

    // 2. 初始化：页面加载后执行所有初始化逻辑
    init() {
        // DOM加载完成后初始化
        document.addEventListener("DOMContentLoaded", () => {
            this.initializePage();
            this.updateTime(); // 初始化状态栏时间
            this.startTimeUpdateTimer(); // 启动时间更新定时器
        });

        // 暴露全局方法：兼容原有HTML中的onclick调用
        this.exposeGlobalMethods();

        // 绑定模态框背景点击关闭事件
        this.bindModalCloseEvent();
    },

    // 暴露全局方法：确保HTML中onclick可正常触发
    exposeGlobalMethods() {
        window.toggleEditArea = (areaId) => this.toggleEditArea(areaId);
        window.changeAvatar = () => this.changeAvatar();
        window.saveUsername = () => this.saveUsername();
        window.togglePassword = (inputId) => this.togglePassword(inputId);
        window.sendVerifyCode = () => this.sendVerifyCode();
        window.updatePhone = () => this.updatePhone();
        window.updatePassword = () => this.updatePassword();
        window.closeModal = (modalId) => this.closeModal(modalId);
        window.goBack = () => this.goBack();
    },

    // 3. 页面基础功能
    /**
     * 初始化页面：加载用户信息（用户名、头像、手机号）
     */
    initializePage() {
        const userDataStr = localStorage.getItem("userData");
        if (userDataStr) {
            try {
                const userData = JSON.parse(userDataStr);
                console.log("用户数据:", userData);

                // 初始化手机号显示
                this.initPhoneDisplay(userData);
                // 初始化用户名显示
                this.initUsernameDisplay(userData);
                // 初始化头像显示
                this.initAvatarDisplay(userData);

            } catch (error) {
                console.error("解析用户数据失败:", error);
                this.setDefaultUserInfo(); // 解析失败用默认值
            }
        } else {
            this.setDefaultUserInfo(); // 无用户数据用默认值
        }
    },

    /**
     * 设置默认用户信息（统一默认值管理）
     */
    setDefaultUserInfo() {
        // 默认用户名
        document.getElementById("username").value = "用户";
        document.getElementById("usernameDisplay").textContent = "用户";

        // 默认头像
        const defaultAvatar = this.state.apiConfig.defaultAvatar;
        document.getElementById("userAvatar")?.setAttribute("src", defaultAvatar);
        document.getElementById("userAvatarLarge")?.setAttribute("src", defaultAvatar);
        this.state.selectedAvatar = defaultAvatar;

        // 默认手机号
        document.getElementById("currentPhone").value = "未绑定手机号";
        document.getElementById("phoneDisplay").textContent = "未绑定";
    },

    /**
     * 初始化手机号显示（含脱敏处理）
     * @param {Object} userData - 用户数据对象
     */
    initPhoneDisplay(userData) {
        const userPhone = userData.phone?.trim() || "";
        if (userPhone) {
            document.getElementById("currentPhone").value = userPhone;
            document.getElementById("phoneDisplay").textContent = this.maskPhoneNumber(userPhone);
        } else {
            document.getElementById("currentPhone").value = "未绑定手机号";
            document.getElementById("phoneDisplay").textContent = "未绑定";
        }
    },

    /**
     * 初始化用户名显示
     * @param {Object} userData - 用户数据对象
     */
    initUsernameDisplay(userData) {
        const userName = userData.nickName?.trim() || "未知用户";
        document.getElementById("username").value = userName;
        document.getElementById("usernameDisplay").textContent = userName;
    },

    /**
     * 初始化头像显示（含加载失败兜底）
     * @param {Object} userData - 用户数据对象
     */
    initAvatarDisplay(userData) {
        const avatarUrl = userData.avatarUrl?.trim() || this.state.apiConfig.defaultAvatar;
        const avatarElements = [
            document.getElementById("userAvatar"),
            document.getElementById("userAvatarLarge")
        ];

        avatarElements.forEach(el => {
            if (el) {
                el.src = avatarUrl;
                // 加载失败时使用默认头像
                el.onerror = () => {
                    el.src = this.state.apiConfig.defaultAvatar;
                };
            }
        });

        this.state.selectedAvatar = avatarUrl;
    },

    /**
     * 更新状态栏时间
     */
    updateTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, "0");
        const minutes = now.getMinutes().toString().padStart(2, "0");
        document.querySelector(".time").textContent = `${hours}:${minutes}`;
    },

    /**
     * 启动时间更新定时器（每分钟更新一次）
     */
    startTimeUpdateTimer() {
        setInterval(() => this.updateTime(), 60000);
    },

    // 4. 编辑区域切换功能
    /**
     * 切换编辑区域显示/隐藏（头像、用户名、手机号、密码）
     * @param {string} areaId - 编辑区域ID
     */
    toggleEditArea(areaId) {
        const editArea = document.getElementById(areaId);
        if (!editArea) return;

        const allEditAreas = document.querySelectorAll(".edit-area");
        const pageTitle = document.querySelector(".page-title");
        const infoSections = document.querySelectorAll(".form-section:not(:last-child)");
        const profilePage = document.getElementById("profilePage");
        const editProfilePage = document.getElementById("editProfilePage");

        // 切换页面容器显示
        profilePage.style.display = "none";
        editProfilePage.style.display = "block";

        // 隐藏所有编辑区域
        allEditAreas.forEach(area => {
            area.style.display = "none";
        });

        // 更新页面标题（根据编辑类型）
        this.updateEditPageTitle(pageTitle, areaId);

        // 处理当前编辑区域状态（显示/隐藏）
        if (this.state.currentEditArea === editArea && editArea.style.display === "block") {
            // 已显示则隐藏，恢复默认视图
            editArea.style.display = "none";
            this.state.currentEditArea = null;
            pageTitle.textContent = "修改个人信息";
            infoSections.forEach(section => {
                section.style.display = "block";
            });
        } else {
            // 显示选中编辑区域，隐藏其他信息区域
            editArea.style.display = "block";
            this.state.currentEditArea = editArea;
            infoSections.forEach(section => {
                section.style.display = "none";
            });
        }
    },

    /**
     * 根据编辑类型更新页面标题
     * @param {HTMLElement} pageTitle - 标题元素
     * @param {string} areaId - 编辑区域ID
     */
    updateEditPageTitle(pageTitle, areaId) {
        const titleMap = {
            "avatarEdit": "修改头像",
            "usernameEdit": "修改用户名",
            "phoneEdit": "修改手机号",
            "passwordEdit": "修改密码"
        };
        pageTitle.textContent = titleMap[areaId] || "修改个人信息";
    },

    // 5. 头像管理功能
    /**
     * 更换头像（调用原生相册选择+上传接口）
     */
    changeAvatar() {
        // 检查原生交互支持
        if (!window.AndroidInterface) {
            this.showToast("不支持图片选择功能");
            return;
        }

        // 定义图片选择成功回调（挂载到window供原生调用）
        window.onImageSelected = (imageUri) => {
            if (!imageUri) {
                this.showToast("未选择图片");
                return;
            }

            this.showToast("正在上传头像...");
            // 上传头像到服务器
            this.uploadAvatarToServer(imageUri)
                .then(newAvatarUrl => {
                    // 上传成功，更新头像显示
                    this.state.selectedAvatar = newAvatarUrl;
                    document.getElementById("userAvatar").src = newAvatarUrl;
                    document.getElementById("userAvatarLarge").src = newAvatarUrl;
                    // 保存头像到本地存储
                    this.saveUserData("avatar", newAvatarUrl);
                    this.showToast("头像已更换");
                })
                .catch(error => {
                    this.showToast(error.message || "头像上传失败");
                });
        };

        // 调用原生方法打开相册
        try {
            window.AndroidInterface.openImagePicker("onImageSelected");
        } catch (error) {
            console.error("调用相册选择失败:", error);
            this.showToast("打开相册失败，请重试");
        }
    },

    /**
     * 上传头像到服务器
     * @param {string} imageUri - 原生传递的图片URI
     * @returns {Promise<string>} - 新头像URL
     */
    uploadAvatarToServer(imageUri) {
        return new Promise((resolve, reject) => {
            // 获取用户Token
            const token = this.getAuthToken();
            if (!token) {
                reject(new Error("请先登录"));
                return;
            }

            // 转换URI为Blob（适配WebView上传）
            this.convertUriToBlob(imageUri)
                .then(blob => {
                    // 构建FormData
                    const formData = new FormData();
                    formData.append("file", blob, `avatar_${Date.now()}.jpg`);

                    // 调用上传接口
                    fetch(`${this.state.apiConfig.baseUrl}/user/avatar/upload`, {
                        method: "POST",
                        headers: {
                            ...this.state.apiConfig.headers,
                            "Authorization": `Bearer ${token}`
                            // 不手动设置Content-Type，FormData自动处理
                        },
                        body: formData
                    })
                        .then(response => this.handleApiResponse(response))
                        .then(data => {
                            const newAvatarUrl = data.data?.avatarUrl || "";
                            if (!newAvatarUrl) {
                                reject(new Error("未获取到头像地址"));
                                return;
                            }
                            resolve(newAvatarUrl);
                        })
                        .catch(error => {
                            reject(error);
                        });
                })
                .catch(error => {
                    reject(new Error("图片处理失败: " + error.message));
                });
        });
    },

    /**
     * 将图片URI转换为Blob对象
     * @param {string} uri - 图片URI
     * @returns {Promise<Blob>} - 转换后的Blob
     */
    convertUriToBlob(uri) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", uri, true);
            xhr.responseType = "blob";

            xhr.onload = () => {
                if (xhr.status === 200) {
                    resolve(xhr.response);
                } else {
                    reject(new Error(`获取图片失败: ${xhr.statusText}`));
                }
            };

            xhr.onerror = () => {
                reject(new Error("图片请求失败，请检查权限"));
            };

            xhr.send();
        });
    },

    // 6. 用户名管理功能
    /**
     * 保存用户名（验证+调用接口更新）
     */
    saveUsername() {
        const username = document.getElementById("username").value.trim();

        // 前端验证
        if (!username) {
            this.showToast("用户名不能为空");
            return;
        }

        // 获取用户Token和现有数据
        const { token, userData } = this.getAuthTokenAndData();
        if (!token) return;

        // 构建请求数据（仅传递nickName字段）
        const requestData = { nickName: username };

        this.showToast("正在保存用户名...");
        // 调用更新接口
        fetch(`${this.state.apiConfig.baseUrl}/user/profile/update`, {
            method: "PUT",
            headers: {
                ...this.state.apiConfig.headers,
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestData)
        })
            .then(response => this.handleApiResponse(response))
            .then(() => {
                // 更新本地存储
                const updatedUserData = { ...userData, userName: username };
                localStorage.setItem("userData", JSON.stringify(updatedUserData));
                // 更新页面显示
                document.getElementById("usernameDisplay").textContent = username;
                this.showToast("用户名已更换");
                this.goBack(); // 返回上一页
            })
            .catch(error => {
                console.error("保存用户名失败:", error);
                this.showToast(error.message || "网络异常，请检查网络后重试");
            });
    },

    // 7. 手机号管理功能
    /**
     * 发送验证码（修改手机号场景）
     */
    sendVerifyCode() {
        const newPhone = document.getElementById("newPhone").value.trim();
        const sendBtn = document.getElementById("sendCodeBtn");
        if (!sendBtn) return;

        // 前端验证
        if (!this.validatePhoneNumber(newPhone)) {
            this.showToast("请输入正确的手机号");
            return;
        }

        // 检查新手机号是否与当前一致
        const { userData } = this.getAuthTokenAndData();
        const currentPhone = userData.phone?.trim() || "";
        if (newPhone === currentPhone) {
            this.showToast("新手机号不能与当前手机号相同");
            return;
        }

        // 避免重复发送（倒计时中）
        if (this.state.codeCountdown > 0) return;

        // 构建接口参数（场景：修改手机号）
        const params = new URLSearchParams();
        params.append("phone", newPhone);
        params.append("scene", "resetPhone");
        const url = `${this.state.apiConfig.baseUrl}/verifyCode/send?${params.toString()}`;

        this.showToast("正在发送验证码...");
        // 调用发送验证码接口
        fetch(url, {
            method: "GET",
            headers: this.state.apiConfig.headers
        })
            .then(response => this.handleApiResponse(response))
            .then(data => {
                // 发送成功，启动倒计时
                this.showToast("验证码已发送到新手机，请注意查收");
                // 兼容原生Toast显示验证码
                if (window.AndroidInterface && typeof window.AndroidInterface.showToast === "function") {
                    window.AndroidInterface.showToast(data.data?.code || "");
                }
                this.state.codeCountdown = 60;
                this.updateCodeButton(sendBtn);

                // 倒计时定时器
                const timer = setInterval(() => {
                    this.state.codeCountdown--;
                    if (this.state.codeCountdown <= 0) {
                        clearInterval(timer);
                        sendBtn.textContent = "发送验证码";
                        sendBtn.disabled = false;
                    } else {
                        this.updateCodeButton(sendBtn);
                    }
                }, 1000);
            })
            .catch(error => {
                console.error("发送验证码失败:", error);
                this.showToast(error.message || "网络异常，发送失败");
            });
    },

    /**
     * 更新验证码按钮状态（倒计时显示）
     * @param {HTMLElement} sendBtn - 发送按钮元素
     */
    updateCodeButton(sendBtn) {
        sendBtn.textContent = `${this.state.codeCountdown}s后重发`;
        sendBtn.disabled = true;
    },

    /**
     * 更新手机号（验证验证码+调用接口）
     */
    updatePhone() {
        // 获取表单数据
        const newPhone = document.getElementById("newPhone").value.trim();
        const verifyCode = document.getElementById("verifyCode").value.trim();

        // 前端基础验证
        if (!newPhone || !verifyCode) {
            this.showToast("请填写完整信息");
            return;
        }
        if (!this.validatePhoneNumber(newPhone)) {
            this.showToast("请输入正确的手机号");
            return;
        }

        // 获取Token和现有用户数据
        const { token, userData } = this.getAuthTokenAndData();
        if (!token) return;

        // 检查新手机号是否与当前一致
        const currentPhone = userData.phone?.trim() || "";
        if (newPhone === currentPhone) {
            this.showToast("新手机号不能与当前手机号相同");
            return;
        }

        // 第一步：验证验证码
        this.showToast("正在验证验证码...");
        const checkCodeData = {
            phone: newPhone,
            verifyCode: verifyCode,
            scene: "resetPhone"
        };

        fetch(`${this.state.apiConfig.baseUrl}/verifyCode/check`, {
            method: "POST",
            headers: {
                ...this.state.apiConfig.headers,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(checkCodeData)
        })
            .then(response => this.handleApiResponse(response))
            .then(() => {
                // 验证码验证通过，调用修改手机号接口
                this.showToast("验证码验证通过，正在修改手机号...");
                const updatePhoneData = { phone: newPhone };

                return fetch(`${this.state.apiConfig.baseUrl}/user/profile/update`, {
                    method: "PUT",
                    headers: {
                        ...this.state.apiConfig.headers,
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(updatePhoneData)
                });
            })
            .then(response => this.handleApiResponse(response))
            .then(() => {
                // 更新成功，同步本地存储和页面显示
                const updatedUserData = { ...userData, phone: newPhone };
                localStorage.setItem("userData", JSON.stringify(updatedUserData));
                localStorage.setItem("userPhone", newPhone); // 兼容旧存储

                // 脱敏显示新手机号
                const maskedPhone = this.maskPhoneNumber(newPhone);
                document.getElementById("currentPhone").value = newPhone;
                document.getElementById("phoneDisplay").textContent = maskedPhone;

                // 清空表单
                document.getElementById("newPhone").value = "";
                document.getElementById("verifyCode").value = "";

                this.showToast("手机号修改成功");
                this.goBack();
            })
            .catch(error => {
                console.error("手机号修改失败:", error);
                this.showToast(error.message || "操作失败，请检查网络或信息");
            });
    },

    // 8. 密码管理功能
    /**
     * 更新密码（验证+调用接口）
     */
    updatePassword() {
        // 获取表单数据
        const currentPassword = document.getElementById("currentPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

        // 前端验证
        if (!currentPassword || !newPassword || !confirmPassword) {
            this.showToast("请填写完整信息");
            return;
        }
        if (!this.validatePassword(newPassword)) {
            this.showToast("新密码至少需要6位");
            return;
        }
        if (newPassword !== confirmPassword) {
            this.showToast("两次输入的新密码不一致");
            return;
        }

        // 获取Token
        const token = this.getAuthToken();
        if (!token) return;

        // 构建请求数据
        const requestData = {
            oldPassword: currentPassword,
            newPassword: newPassword
        };

        this.showToast("正在更新密码...");
        // 调用更新密码接口
        fetch(`${this.state.apiConfig.baseUrl}/user/password/update`, {
            method: "PUT",
            headers: {
                ...this.state.apiConfig.headers,
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestData)
        })
            .then(response => this.handleApiResponse(response))
            .then(data => {
                // 清空表单
                document.getElementById("currentPassword").value = "";
                document.getElementById("newPassword").value = "";
                document.getElementById("confirmPassword").value = "";

                this.showToast(data.message || "密码更新成功");
                this.goBack();
            })
            .catch(error => {
                console.error("更新密码失败:", error);
                this.showToast(error.message || "网络异常，请检查网络后重试");
            });
    },

    // 9. 通用功能与工具方法
    /**
     * 显示Toast提示
     * @param {string} message - 提示内容
     * @param {number} duration - 显示时长（毫秒，默认2000）
     */
    showToast(message, duration = 2000) {
        // 移除现有Toast
        const existingToast = document.querySelector(".toast");
        if (existingToast) {
            document.body.removeChild(existingToast);
        }

        // 创建新Toast
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;
        // 保留原有样式
        toast.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 14px;
        `;

        document.body.appendChild(toast);
        // 自动移除
        setTimeout(() => {
            document.body.removeChild(toast);
        }, duration);
    },

    /**
     * 手机号脱敏处理（138****1234）
     * @param {string} phone - 手机号
     * @returns {string} 脱敏后的手机号
     */
    maskPhoneNumber(phone) {
        return phone.replace(/^(\d{3})\d{4}(\d{4})$/, "$1****$2");
    },

    /**
     * 验证手机号格式（11位数字，以1开头）
     * @param {string} phone - 手机号
     * @returns {boolean} 是否验证通过
     */
    validatePhoneNumber(phone) {
        return /^1[3-9]\d{9}$/.test(phone);
    },

    /**
     * 验证密码格式（至少6位）
     * @param {string} password - 密码
     * @returns {boolean} 是否验证通过
     */
    validatePassword(password) {
        return password && password.length >= 6;
    },

    /**
     * 切换密码显示/隐藏
     * @param {string} inputId - 密码输入框ID
     */
    togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const eyeIcon = document.getElementById(inputId + "Eye");
        if (!input || !eyeIcon) return;

        if (input.type === "password") {
            input.type = "text";
            eyeIcon.src = "icons/yincangmima.png";
        } else {
            input.type = "password";
            eyeIcon.src = "icons/xianshimima.png";
        }
    },

    /**
     * 关闭模态框
     * @param {string} modalId - 模态框ID
     */
    closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = "none";
    },

    /**
     * 绑定模态框背景点击关闭事件
     */
    bindModalCloseEvent() {
        document.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal")) {
                e.target.style.display = "none";
            }
        });
    },

    /**
     * 返回上一页或关闭编辑区域
     */
    goBack() {
        if (this.state.currentEditArea) {
            // 关闭编辑区域，恢复默认视图
            const allEditAreas = document.querySelectorAll(".edit-area");
            const pageTitle = document.querySelector(".page-title");
            const infoSections = document.querySelectorAll(".form-section:not(:last-child)");
            const profilePage = document.getElementById("profilePage");
            const editProfilePage = document.getElementById("editProfilePage");

            // 恢复页面容器显示
            profilePage.style.display = "block";
            editProfilePage.style.display = "none";

            // 隐藏所有编辑区域
            allEditAreas.forEach(area => {
                area.style.display = "none";
            });

            // 恢复标题和信息区域
            pageTitle.textContent = "修改个人信息";
            infoSections.forEach(section => {
                section.style.display = "block";
            });

            this.state.currentEditArea = null;
        } else {
            // 无编辑区域打开，返回上一页
            window.history.back();
        }
    },

    /**
     * 保存用户数据到本地存储
     * @param {string} field - 字段名（username/avatar）
     * @param {string} newValue - 新值
     */
    saveUserData(field, newValue) {
        let userData = localStorage.getItem("userData");
        let parsedData = userData ? JSON.parse(userData) : {};

        // 根据字段更新数据
        if (field === "username") {
            parsedData.nickName = newValue;
        } else if (field === "avatar") {
            parsedData.avatarUrl = newValue;
        }

        localStorage.setItem("userData", JSON.stringify(parsedData));
    },

    /**
     * 获取用户Token（统一封装，便于维护）
     * @returns {string} Token或空字符串
     */
    getAuthToken() {
        try {
            const userData = JSON.parse(localStorage.getItem("userData") || "{}");
            return userData.token || "";
        } catch (error) {
            console.error("获取token失败:", error);
            this.showToast("登录状态异常，请重新登录");
            return "";
        }
    },

    /**
     * 获取Token和用户数据（统一处理）
     * @returns {Object} { token, userData }
     */
    getAuthTokenAndData() {
        try {
            const userData = JSON.parse(localStorage.getItem("userData") || "{}");
            return {
                token: userData.token || "",
                userData: userData
            };
        } catch (error) {
            console.error("获取用户信息失败:", error);
            this.showToast("登录状态异常，请重新登录");
            return { token: "", userData: {} };
        }
    },

    /**
     * 处理API响应（统一错误处理）
     * @param {Response} response - 接口响应对象
     * @returns {Promise} 解析后的响应数据
     */
    handleApiResponse(response) {
        return new Promise((resolve, reject) => {
            if (!response.ok) {
                response.json()
                    .then(err => reject(new Error(err.message || `请求失败: ${response.status}`)))
                    .catch(() => reject(new Error(`请求失败: ${response.status}`)));
                return;
            }

            response.json()
                .then(data => {
                    if (data.code === 200) {
                        resolve(data);
                    } else {
                        reject(new Error(data.message || "接口返回业务错误"));
                    }
                })
                .catch(error => {
                    reject(new Error("解析响应数据失败: " + error.message));
                });
        });
    }
};

// 初始化个人信息模块
ProfileModule.init();
</script>
</body>

</html>