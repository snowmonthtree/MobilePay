<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
<div class="app-container">
    <!-- 状态栏 -->

    <!-- 注册页面 -->
    <div class="register-page">
        <!-- 页面头部 -->
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">
                <img src="icons/danjiantouzuo.png" alt="返回">
            </button>
            <h1>注册</h1>
            <div class="header-placeholder"></div>
        </div>

        <!-- 注册步骤指示器 -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-label">手机验证</div>
            </div>
            <div class="step-line"></div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-label">设置密码</div>
            </div>
            <div class="step-line"></div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-label">支付密码</div>
            </div>
        </div>

        <!-- 注册表单 -->
        <div class="register-form">
            <!-- 步骤1：手机验证 -->
            <div class="step-content" id="stepContent1">
                <div class="step-title">
                    <h2>手机号验证</h2>
                    <p>请输入您的手机号码，我们将发送验证码</p>
                </div>

                <div class="form-group">
                    <label>手机号</label>
                    <div class="input-group">
                        <img src="icons/shoujihao.png" alt="手机" class="input-icon">
                        <input type="tel" id="registerPhone" placeholder="请输入手机号" maxlength="11">
                    </div>
                </div>

                <div class="form-group">
                    <label>验证码</label>
                    <div class="input-group">
                        <img src="icons/mima.png" alt="验证码" class="input-icon">
                        <input type="text" id="phoneVerifyCode" placeholder="请输入验证码" maxlength="6"
                               style="width:50%">
                        <button class="send-sms-btn" onclick="sendPhoneVerifyCode()" id="phoneSmsBtn">发送验证码</button>
                    </div>
                </div>

                <button class="next-btn" onclick="nextStep(1)">下一步</button>
            </div>

            <!-- 步骤2：设置密码 -->
            <div class="step-content hidden" id="stepContent2">
                <div class="step-title">
                    <h2>设置登录密码</h2>
                    <p>请设置您的登录密码，密码长度6-20位</p>
                </div>

                <div class="form-group">
                    <label>登录密码</label>
                    <div class="input-group">
                        <img src="icons/mima.png" alt="密码" class="input-icon">
                        <input type="password" id="registerPassword" placeholder="请输入密码">
                        <button class="toggle-password" onclick="togglePassword('registerPassword')">
                            <img src="icons/xianshimima.png" alt="显示密码" id="registerPasswordEye">
                        </button>
                    </div>
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <span class="strength-text" id="strengthText">密码强度：弱</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>确认密码</label>
                    <div class="input-group">
                        <img src="icons/mima.png" alt="密码" class="input-icon">
                        <input type="password" id="confirmRegisterPassword" placeholder="请再次输入密码">
                        <button class="toggle-password" onclick="togglePassword('confirmRegisterPassword')">
                            <img src="icons/xianshimima.png" alt="显示密码" id="confirmRegisterPasswordEye">
                        </button>
                    </div>
                </div>

                <div class="password-tips">
                    <h4>密码要求：</h4>
                    <ul style="margin-left: 16px;">
                        <li id="lengthTip">长度6-20位</li>
                        <li id="letterTip">包含字母</li>
                        <li id="numberTip">包含数字</li>
                    </ul>
                </div>

                <div class="step-buttons">
                    <button class="prev-btn" onclick="prevStep(2)">上一步</button>
                    <button class="next-btn" onclick="nextStep(2)">下一步</button>
                </div>
            </div>

            <!-- 步骤3：设置支付密码 -->
            <div class="step-content hidden" id="stepContent3">
                <div class="step-title">
                    <h2>设置支付密码</h2>
                    <p>请设置您的支付密码，用于交易验证，密码长度为6位数字</p>
                </div>

                <div class="form-group">
                    <label>支付密码</label>
                    <div class="input-group">
                        <img src="icons/mima.png" alt="支付密码" class="input-icon">
                        <input type="password" id="paymentPassword" placeholder="请输入6位数字支付密码" maxlength="6"
                               pattern="[0-9]*" inputmode="numeric">
                        <button class="toggle-password" onclick="togglePassword('paymentPassword')">
                            <img src="icons/xianshimima.png" alt="显示密码" id="paymentPasswordEye">
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>确认支付密码</label>
                    <div class="input-group">
                        <img src="icons/mima.png" alt="确认支付密码" class="input-icon">
                        <input type="password" id="confirmPaymentPassword" placeholder="请再次输入支付密码" maxlength="6"
                               pattern="[0-9]*" inputmode="numeric">
                        <button class="toggle-password" onclick="togglePassword('confirmPaymentPassword')">
                            <img src="icons/xianshimima.png" alt="显示密码" id="confirmPaymentPasswordEye">
                        </button>
                    </div>
                </div>

                <div class="password-tips">
                    <h4>支付密码要求：</h4>
                    <ul style="margin-left: 16px;">
                        <li id="paymentLengthTip">必须为6位数字</li>
                        <li id="paymentNumberOnlyTip">只能包含数字</li>
                    </ul>
                </div>

                <div class="step-buttons">
                    <button class="prev-btn" onclick="prevStep(3)">上一步</button>
                    <button class="next-btn" onclick="submitRegistration()">提交注册</button>
                </div>
            </div>

            <!-- 用户协议 -->
            <div class="agreement">
                <label class="checkbox-label">
                    <input type="checkbox" id="agreeRegisterTerms" checked>
                    <span class="checkmark"></span>
                    我已阅读并同意
                </label>
                <a href="#" onclick="showUserAgreement()">《用户协议》</a>
                <span>和</span>
                <a href="#" onclick="showPrivacyPolicy()">《隐私政策》</a>
            </div>


        </div>
    </div>

    <!-- 注册成功模态框 -->
    <div class="register-modal" id="successModal">
        <div class="register-modal-content success">
            <div class="success-icon">
                <img src="icons/chenggong.png" alt="成功">
            </div>
            <h3 style="text-align: center;">注册成功</h3>
            <p style="text-align: center;">您的账户已创建成功</p>
            <div class="success-info">
                <div class="info-item">
                    <span class="info-label">注册手机：</span>
                    <span class="info-value" id="successPhone"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">支付密码：</span>
                    <span class="info-value">已设置</span>
                </div>
                <div class="info-item">
                    <span class="info-label">预计时间：</span>
                    <span class="info-value">1-3个工作日</span>
                </div>
            </div>
            <div class="success-actions">
                <button class="btn-primary" onclick="goToHome()">返回首页</button>
            </div>
        </div>
    </div>
</div>

<!-- 隐藏的文件输入 -->
<input type="file" id="frontFileInput" accept="image/*" style="display: none"
       onchange="handleFileUpload('front', this)">
<input type="file" id="backFileInput" accept="image/*" style="display: none"
       onchange="handleFileUpload('back', this)">

<script>
    // 用户注册模块：统一封装多步骤注册流程（手机号验证、密码设置、支付密码设置）
const UserRegistrationModule = {
    // 1. 状态管理：存储注册流程状态、数据与DOM元素缓存
    state: {
        currentStep: 1,                // 当前注册步骤（1-手机号验证，2-登录密码，3-支付密码）
        phoneVerifyCountdown: 0,       // 手机号验证码倒计时（秒）
        phoneVerifyTimer: null,        // 验证码倒计时定时器
        registrationData: {},          // 注册数据（手机号、密码、支付密码等）
        paymentPasswordValid: false,   // 支付密码验证状态
        apiConfig: {
            sendVerifyCodeUrl: "http://graywolf.top:6031/app/verifyCode/send",
            checkVerifyCodeUrl: "http://graywolf.top:6031/app/verifyCode/check",
            registerUrl: "http://graywolf.top:6031/app/user/register",
            headers: {
                "accept": "application/json",
                "Content-Type": "application/json"
            }
        },
        elements: {
            // 步骤相关元素
            stepContents: [],
            stepIndicators: [],
            // 手机号验证步骤元素
            registerPhone: null,
            phoneVerifyCode: null,
            agreeRegisterTerms: null,
            phoneSmsBtn: null,
            // 登录密码步骤元素
            registerPassword: null,
            confirmRegisterPassword: null,
            // 支付密码步骤元素
            paymentPassword: null,
            confirmPaymentPassword: null,
            paymentLengthTip: null,
            paymentNumberOnlyTip: null,
            // 密码强度相关元素
            strengthFill: null,
            strengthText: null,
            lengthTip: null,
            letterTip: null,
            numberTip: null,
            // 模态框与结果元素
            successModal: null,
            successPhone: null
        }
    },

    // 2. 初始化：页面加载后执行配置与事件绑定
    init() {
        document.addEventListener("DOMContentLoaded", () => {
            this.cacheDomElements();  // 缓存DOM元素
            this.bindEventListeners(); // 绑定事件监听
            this.initStepElements();   // 初始化步骤元素引用
        });

        // 暴露全局方法（兼容HTML onclick调用）
        this.exposeGlobalMethods();
    },

    // 缓存DOM元素引用，减少重复查询
    cacheDomElements() {
        // 步骤相关元素
        this.state.elements.stepContents = [
            document.getElementById("stepContent1"),
            document.getElementById("stepContent2"),
            document.getElementById("stepContent3")
        ];
        this.state.elements.stepIndicators = [
            document.getElementById("step1"),
            document.getElementById("step2"),
            document.getElementById("step3")
        ];

        // 手机号验证步骤元素
        this.state.elements.registerPhone = document.getElementById("registerPhone");
        this.state.elements.phoneVerifyCode = document.getElementById("phoneVerifyCode");
        this.state.elements.agreeRegisterTerms = document.getElementById("agreeRegisterTerms");
        this.state.elements.phoneSmsBtn = document.getElementById("phoneSmsBtn");

        // 登录密码步骤元素
        this.state.elements.registerPassword = document.getElementById("registerPassword");
        this.state.elements.confirmRegisterPassword = document.getElementById("confirmRegisterPassword");

        // 支付密码步骤元素
        this.state.elements.paymentPassword = document.getElementById("paymentPassword");
        this.state.elements.confirmPaymentPassword = document.getElementById("confirmPaymentPassword");
        this.state.elements.paymentLengthTip = document.getElementById("paymentLengthTip");
        this.state.elements.paymentNumberOnlyTip = document.getElementById("paymentNumberOnlyTip");

        // 密码强度相关元素
        this.state.elements.strengthFill = document.getElementById("strengthFill");
        this.state.elements.strengthText = document.getElementById("strengthText");
        this.state.elements.lengthTip = document.getElementById("lengthTip");
        this.state.elements.letterTip = document.getElementById("letterTip");
        this.state.elements.numberTip = document.getElementById("numberTip");

        // 模态框与结果元素
        this.state.elements.successModal = document.getElementById("successModal");
        this.state.elements.successPhone = document.getElementById("successPhone");
    },

    // 初始化步骤元素（确保DOM加载完成后引用有效）
    initStepElements() {
        // 初始化显示第一步
        this.showStep(this.state.currentStep);
    },

    // 绑定全局事件监听
    bindEventListeners() {
        // 登录密码输入监听（实时更新强度）
        this.state.elements.registerPassword?.addEventListener("input", () => this.updatePasswordStrength());

        // 模态框背景点击关闭
        document.addEventListener("click", (e) => {
            if (e.target?.classList.contains("register-modal")) {
                e.target.style.display = "none";
            }
        });
    },

    // 暴露全局方法到window对象
    exposeGlobalMethods() {
        window.nextStep = (step) => this.nextStep(step);
        window.prevStep = (step) => this.prevStep(step);
        window.sendPhoneVerifyCode = () => this.sendPhoneVerifyCode();
        window.togglePassword = (inputId) => this.togglePassword(inputId);
        window.uploadIdCardFront = () => this.uploadIdCardFront();
        window.uploadIdCardBack = () => this.uploadIdCardBack();
        window.handleFileUpload = (type, input) => this.handleFileUpload(type, input);
        window.submitRegistration = () => this.submitRegistration();
        window.closeModal = (modalId) => this.closeModal(modalId);
        window.goToHome = () => this.goToHome();
        window.showUserAgreement = () => this.showUserAgreement();
        window.showPrivacyPolicy = () => this.showPrivacyPolicy();
        window.goBack = () => this.goBack();
    },

    // 3. 步骤控制逻辑
    /**
     * 下一步：验证当前步骤后切换到下一步
     * @param {number} step - 当前步骤
     */
    async nextStep(step) {
        const isValid = await this.validateStep(step);
        if (isValid) {
            if (step < 3) {
                this.showStep(step + 1);
            } else if (step === 3) {
                this.submitRegistration();
            }
        }
    },

    /**
     * 上一步：切换到上一步骤
     * @param {number} step - 当前步骤
     */
    prevStep(step) {
        if (step > 1) {
            this.showStep(step - 1);
        }
    },

    /**
     * 显示指定步骤：更新步骤指示器与内容显示
     * @param {number} step - 目标步骤
     */
    showStep(step) {
        const { stepContents, stepIndicators } = this.state.elements;

        // 隐藏所有步骤内容，重置步骤指示器
        stepContents.forEach((content, index) => {
            content?.classList.add("hidden");
            stepIndicators[index]?.classList.remove("active", "completed");
        });

        // 显示当前步骤内容，激活步骤指示器
        const targetIndex = step - 1;
        stepContents[targetIndex]?.classList.remove("hidden");
        stepIndicators[targetIndex]?.classList.add("active");

        // 标记已完成的步骤
        for (let i = 0; i < targetIndex; i++) {
            stepIndicators[i]?.classList.add("completed");
        }

        // 更新当前步骤状态
        this.state.currentStep = step;

        // 支付密码步骤：绑定实时验证事件
        if (step === 3) {
            this.state.elements.paymentPassword?.addEventListener("input", () => this.validatePaymentPasswordInput());
            this.state.elements.confirmPaymentPassword?.addEventListener("input", () => this.validatePaymentPasswordInput());
        }
    },

    // 4. 步骤验证逻辑（按步骤分发验证任务）
    /**
     * 验证当前步骤：根据步骤号调用对应验证方法
     * @param {number} step - 当前步骤
     * @returns {Promise<boolean>} 验证结果（成功true/失败false）
     */
    validateStep(step) {
        switch (step) {
            case 1:
                return this.validatePhoneStep();    // 手机号+验证码验证（异步）
            case 2:
                return Promise.resolve(this.validatePasswordStep()); // 登录密码验证（同步）
            case 3:
                return Promise.resolve(this.validatePaymentPasswordStep()); // 支付密码验证（同步）
            default:
                return Promise.resolve(false);
        }
    },

    /**
     * 步骤1：验证手机号与验证码（调用后端接口）
     * @returns {Promise<boolean>} 验证结果
     */
    validatePhoneStep() {
        return new Promise((resolve) => {
            const { registerPhone, phoneVerifyCode, agreeRegisterTerms } = this.state.elements;
            const phone = registerPhone?.value.trim() || "";
            const code = phoneVerifyCode?.value.trim() || "";
            const isAgreed = agreeRegisterTerms?.checked || false;

            // 前端基础验证（失败直接返回）
            if (!this.validatePhoneNumber(phone)) {
                this.showToast("请输入正确手机号");
                resolve(false);
                return;
            }
            if (!code || code.length !== 6) {
                this.showToast("请输入6位验证码");
                resolve(false);
                return;
            }
            if (!isAgreed) {
                this.showToast("请同意用户协议和隐私政策");
                resolve(false);
                return;
            }

            // 调用后端验证码验证接口
            fetch(this.state.apiConfig.checkVerifyCodeUrl, {
                method: "POST",
                headers: this.state.apiConfig.headers,
                body: JSON.stringify({
                    phone,
                    verifyCode: code,
                    scene: "register"
                })
            })
                .then((response) => {
                    if (!response.ok) throw new Error(`请求失败 (${response.status})`);
                    return response.json();
                })
                .then((data) => {
                    if (data.code === 200) {
                        // 验证成功：保存手机号，返回true
                        this.showToast("验证码验证成功");
                        this.state.registrationData.phone = phone;
                        resolve(true);
                    } else {
                        // 验证失败：返回错误信息
                        const errorMsg = data.message || "验证码错误或已过期";
                        this.showToast(errorMsg);
                        resolve(false);
                    }
                })
                .catch((error) => {
                    // 网络错误或接口异常
                    console.error("验证码验证失败:", error);
                    const errorMsg = error.message || "验证码验证失败，请重试";
                    this.showToast(errorMsg);
                    resolve(false);
                });
        });
    },

    /**
     * 步骤2：验证登录密码（格式、一致性、强度）
     * @returns {boolean} 验证结果
     */
    validatePasswordStep() {
        const { registerPassword, confirmRegisterPassword } = this.state.elements;
        const password = registerPassword?.value.trim() || "";
        const confirmPwd = confirmRegisterPassword?.value.trim() || "";

        // 密码长度验证（6-20位）
        if (password.length < 6 || password.length > 20) {
            this.showToast("密码长度必须在6-20位之间");
            return false;
        }

        // 密码一致性验证
        if (password !== confirmPwd) {
            this.showToast("两次输入的密码不一致");
            return false;
        }

        // 密码强度验证（字母+数字）
        if (!this.validatePasswordStrength(password)) {
            this.showToast("密码强度不够，请包含字母和数字");
            return false;
        }

        // 验证成功：保存密码
        this.state.registrationData.password = password;
        return true;
    },

    /**
     * 步骤3：验证支付密码（格式、一致性）
     * @returns {boolean} 验证结果
     */
    validatePaymentPasswordStep() {
        const { paymentPassword, confirmPaymentPassword } = this.state.elements;
        const payPwd = paymentPassword?.value.trim() || "";
        const confirmPayPwd = confirmPaymentPassword?.value.trim() || "";

        // 支付密码长度验证（6位）
        if (payPwd.length !== 6) {
            this.showToast("支付密码必须为6位数字");
            return false;
        }

        // 支付密码格式验证（纯数字）
        if (!/^\d{6}$/.test(payPwd)) {
            this.showToast("支付密码必须为纯数字");
            return false;
        }

        // 支付密码一致性验证
        if (payPwd !== confirmPayPwd) {
            this.showToast("两次输入支付密码不一致");
            return false;
        }

        // 验证成功：保存支付密码
        this.state.registrationData.paymentPassword = payPwd;
        return true;
    },

    // 5. 验证码相关逻辑
    /**
     * 发送手机号验证码（调用后端接口，启动倒计时）
     */
    sendPhoneVerifyCode() {
        const { registerPhone, phoneSmsBtn } = this.state.elements;
        const phone = registerPhone?.value.trim() || "";

        // 手机号格式验证
        if (!this.validatePhoneNumber(phone)) {
            this.showToast("请输入正确手机号");
            return;
        }

        // 防止倒计时期间重复点击
        if (this.state.phoneVerifyCountdown > 0) return;

        // 构建请求URL（带参数）
        const requestUrl = `${this.state.apiConfig.sendVerifyCodeUrl}?phone=${encodeURIComponent(phone)}&scene=register`;

        // 调用后端发送验证码接口
        fetch(requestUrl, {
            method: "GET",
            headers: this.state.apiConfig.headers
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.code === 200) {
                    // 发送成功：启动倒计时
                    this.showToast(data.message || "验证码已发送到您的手机");
                    this.startPhoneVerifyCountdown(phoneSmsBtn);
                } else if (data.code === 409) {
                    // 手机号已注册
                    this.showToast(data.message || "手机号已被注册，请更换手机号");
                } else {
                    // 其他错误
                    this.showToast(data.message || "发送失败，请稍后重试");
                }
            })
            .catch((error) => {
                // 网络错误
                console.error("发送验证码失败:", error);
                this.showToast("网络异常，请检查网络设置");
            });
    },

    /**
     * 启动手机号验证码倒计时（60秒）
     * @param {HTMLElement} btn - 发送按钮元素
     */
    startPhoneVerifyCountdown(btn) {
        // 清除旧定时器（防止重复）
        if (this.state.phoneVerifyTimer) {
            clearInterval(this.state.phoneVerifyTimer);
        }

        // 初始化倒计时状态
        this.state.phoneVerifyCountdown = 60;
        this.updateSmsButton(btn, this.state.phoneVerifyCountdown);

        // 启动定时器
        this.state.phoneVerifyTimer = setInterval(() => {
            this.state.phoneVerifyCountdown--;
            if (this.state.phoneVerifyCountdown <= 0) {
                // 倒计时结束：重置按钮
                clearInterval(this.state.phoneVerifyTimer);
                btn.textContent = "发送验证码";
                btn.disabled = false;
            } else {
                // 倒计时中：更新按钮文本
                this.updateSmsButton(btn, this.state.phoneVerifyCountdown);
            }
        }, 1000);
    },

    /**
     * 更新验证码按钮状态（显示倒计时）
     * @param {HTMLElement} btn - 发送按钮元素
     * @param {number} countdown - 剩余秒数
     */
    updateSmsButton(btn, countdown) {
        btn.textContent = `${countdown}s后重发`;
        btn.disabled = true;
    },

    // 6. 密码相关工具逻辑
    /**
     * 切换密码显示/隐藏（明文/密文）
     * @param {string} inputId - 密码输入框ID
     */
    togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const eyeIcon = document.getElementById(`${inputId}Eye`);
        if (!input || !eyeIcon) return;

        // 切换输入框类型
        if (input.type === "password") {
            input.type = "text";
            eyeIcon.src = "icons/yincangmima.png";
        } else {
            input.type = "password";
            eyeIcon.src = "icons/xianshimima.png";
        }
    },

    /**
     * 实时更新登录密码强度显示
     */
    updatePasswordStrength() {
        const { registerPassword, strengthFill, strengthText, lengthTip, letterTip, numberTip } = this.state.elements;
        const password = registerPassword?.value || "";

        // 初始化强度参数
        let strength = 0;
        let strengthLabel = "弱";
        let strengthColor = "#ff4444";

        // 验证长度（6-20位）
        if (password.length >= 6 && password.length <= 20) {
            strength += 1;
            lengthTip?.classList.add("valid");
            } else {
            lengthTip?.classList.remove("valid");
        }

        // 验证包含字母
        if (/[a-zA-Z]/.test(password)) {
            strength += 1;
            letterTip?.classList.add("valid");
        } else {
            letterTip?.classList.remove("valid");
        }

        // 验证包含数字
        if (/\d/.test(password)) {
            strength += 1;
            numberTip?.classList.add("valid");
        } else {
            numberTip?.classList.remove("valid");
        }

        // 更新强度等级与颜色
        if (strength >= 3) {
            strengthLabel = "强";
            strengthColor = "#4CAF50";
        } else if (strength >= 2) {
            strengthLabel = "中";
            strengthColor = "#FF9800";
        }

        // 应用到UI
        if (strengthFill) {
            strengthFill.style.width = `${(strength / 3) * 100}%`;
            strengthFill.style.backgroundColor = strengthColor;
        }
        if (strengthText) {
            strengthText.textContent = `密码强度：${strengthLabel}`;
            strengthText.style.color = strengthColor;
        }
    },

    /**
     * 实时验证支付密码输入（长度、格式、一致性）
     */
    validatePaymentPasswordInput() {
        const { paymentPassword, confirmPaymentPassword, paymentLengthTip, paymentNumberOnlyTip } = this.state.elements;
        const payPwd = paymentPassword?.value || "";
        const confirmPayPwd = confirmPaymentPassword?.value || "";

        // 验证长度（6位）
        if (payPwd.length === 6) {
            paymentLengthTip?.classList.add("valid");
        } else {
            paymentLengthTip?.classList.remove("valid");
        }

        // 验证格式（纯数字）
        if (/^\d*$/.test(payPwd)) {
            paymentNumberOnlyTip?.classList.add("valid");
        } else {
            paymentNumberOnlyTip?.classList.remove("valid");
        }

        // 验证一致性（更新状态标记）
        this.state.paymentPasswordValid = payPwd && confirmPayPwd && payPwd === confirmPayPwd;
    },

    // 7. 身份验证（身份证上传）相关逻辑
    /**
     * 触发身份证正面上传
     */
    uploadIdCardFront() {
        document.getElementById("frontFileInput")?.click();
    },

    /**
     * 触发身份证反面上传
     */
    uploadIdCardBack() {
        document.getElementById("backFileInput")?.click();
    },

    /**
     * 处理身份证文件上传（验证格式、大小，预览图片）
     * @param {string} type - 上传类型（front/back）
     * @param {HTMLInputElement} input - 文件输入框元素
     */
    handleFileUpload(type, input) {
        const file = input.files[0];
        if (!file) return;

        // 验证文件类型（图片）
        if (!file.type.startsWith("image/")) {
            this.showToast("请选择图片文件");
            return;
        }

        // 验证文件大小（不超过5MB）
        if (file.size > 5 * 1024 * 1024) {
            this.showToast("图片大小不能超过5MB");
            return;
        }

        // 预览图片
        const reader = new FileReader();
        reader.onload = (e) => {
            const previewId = `${type}Preview`;
            const imageId = `${type}Image`;

            // 显示预览区域，隐藏上传框
            const previewEl = document.getElementById(previewId);
            const uploadBox = previewEl?.previousElementSibling;
            if (previewEl) previewEl.classList.remove("hidden");
            if (uploadBox) uploadBox.style.display = "none";

            // 设置预览图片
            const imageEl = document.getElementById(imageId);
            if (imageEl) imageEl.src = e.target.result;
        };
        reader.readAsDataURL(file);
    },

    // 8. 注册提交逻辑
    /**
     * 提交注册：整合所有数据，调用后端注册接口
     */
    submitRegistration() {
        const { paymentPassword, confirmPaymentPassword } = this.state.elements;
        const payPwd = paymentPassword?.value || "";
        const confirmPayPwd = confirmPaymentPassword?.value || "";

        // 最终验证支付密码（防止绕过步骤验证）
        if (payPwd.length !== 6) {
            this.showToast("请输入6位数字支付密码");
            return;
        }
        if (payPwd !== confirmPayPwd) {
            this.showToast("两次输入的支付密码不一致");
            return;
        }

        // 整合注册数据
        const requestData = {
            phone: this.state.registrationData.phone,
            loginPassword: this.state.registrationData.password,
            payPassword: payPwd
        };

        // 显示提交状态
        this.showToast("正在提交注册...");

        // 调用后端注册接口
        fetch(this.state.apiConfig.registerUrl, {
            method: "POST",
            headers: this.state.apiConfig.headers,
            body: JSON.stringify(requestData)
        })
            .then((response) => {
                if (!response.ok) throw new Error(`请求失败 (${response.status})`);
                return response.json();
            })
            .then((result) => {
                if (result.code === 200) {
                    // 注册成功：保存用户数据，显示成功弹窗
                    this.showToast(result.message || "注册成功");
                    this.saveUserData(result.data);
                    this.showSuccessModal();
                } else {
                    // 注册失败：显示错误信息
                    this.showToast(result.message || "注册失败，请重试");
                }
            })
            .catch((error) => {
                // 网络错误处理
                console.error("注册请求失败:", error);
                this.showToast(error.message || "网络异常，注册失败");
            });
    },

    /**
     * 保存注册成功后的用户数据（本地存储+原生存储）
     * @param {Object} userData - 接口返回的用户数据（含token、userId等）
     */
    saveUserData(userData) {
        if (!userData) return;

        // 保存到模块状态
        this.state.registrationData.userId = userData.userId;
        this.state.registrationData.token = userData.token;

        // 保存到原生存储（Android环境）
        if (window.AndroidInterface && typeof window.AndroidInterface.saveUserToken === "function") {
            window.AndroidInterface.saveUserToken(
                userData.token,
                userData.userId,
                userData.phone
            );
        }

        // 保存到Web本地存储
        localStorage.setItem("isLoggedIn", "true");
        localStorage.setItem("userData", JSON.stringify(userData));
    },

    /**
     * 显示注册成功弹窗
     */
    showSuccessModal() {
        if (this.state.elements.successPhone) {
            this.state.elements.successPhone.textContent = this.state.registrationData.phone;
        }
        if (this.state.elements.successModal) {
            this.state.elements.successModal.style.display = "flex";
        }
    },

    // 9. 通用工具方法
    /**
     * 显示提示信息（兼容Android原生与Web环境）
     * @param {string} message - 提示内容
     */
    showToast(message) {
        if (window.AndroidInterface && typeof window.AndroidInterface.showToast === "function") {
            window.AndroidInterface.showToast(message);
        } else {
            // Web环境降级使用alert
            alert(message);
        }
    },

    /**
     * 验证手机号格式（11位，以13-9开头）
     * @param {string} phone - 手机号
     * @returns {boolean} 验证结果
     */
    validatePhoneNumber(phone) {
        return /^1[3-9]\d{9}$/.test(phone);
    },

    /**
     * 验证密码强度（包含字母和数字）
     * @param {string} password - 密码
     * @returns {boolean} 验证结果
     */
    validatePasswordStrength(password) {
        const hasLetter = /[a-zA-Z]/.test(password);
        const hasNumber = /\d/.test(password);
        return hasLetter && hasNumber;
    },

    /**
     * 关闭模态框
     * @param {string} modalId - 模态框ID
     */
    closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = "none";
    },

    /**
     * 跳转到首页
     */
    goToHome() {
        window.location.href = "index.html";
    },

    /**
     * 显示用户协议（弹窗）
     */
    showUserAgreement() {
        this.showToast("用户协议内容...");
    },

    /**
     * 显示隐私政策（弹窗）
     */
    showPrivacyPolicy() {
        this.showToast("隐私政策内容...");
    },

    /**
     * 返回操作：步骤内返回上一步，第一步返回上一页
     */
    goBack() {
        if (this.state.currentStep > 1) {
            this.prevStep(this.state.currentStep);
        } else {
            window.history.back();
        }
    }
};

// 初始化用户注册模块
UserRegistrationModule.init();
</script>
</body>

</html>