<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>收款记录 - 移动支付应用</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .no-records {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            margin-top: 20px;
        }

        .no-records img {
            width: 64px;
            height: 64px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 顶部状态栏 -->

        <!-- 收款记录页面 -->
        <div class="transaction-records-page" id="receiveHistoryPage">
            <!-- 头部 -->
            <div class="page-header">
                <button class="back-btn" onclick="goBack()">
                    <img src="icons/danjiantouzuo.png" alt="返回">
                </button>
                <h1>收款记录</h1>
                <div class="header-placeholder"></div>
            </div>

            <!-- 统计概览 -->
            <div class="transaction-summary">
                <div class="summary-item">
                    <span class="summary-label">本月收款</span>
                    <span class="summary-amount income" id="monthlyReceiveAmount">¥0.00</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">总收款笔数</span>
                    <span class="summary-count" id="totalReceiveCount">0</span>
                </div>
            </div>

            <!-- 搜索栏 -->
            <div class="search-container">
                <div class="search-box">
                    <img src="icons/sousuo.png" alt="搜索" class="search-icon">
                    <input type="text" placeholder="搜索收款记录" id="searchInput">
                    <button class="clear-btn" onclick="clearSearch()" style="display: none;">
                        <img src="icons/shanchu.png" alt="清除">
                    </button>
                </div>
            </div>

            <!-- 收款记录列表 -->
            <div class="transaction-list" id="receiveRecordsList">
                <!-- 动态加载收款记录 -->
            </div>

            <!-- 加载更多 -->
            <div class="load-more">
                <button class="load-more-btn" onclick="loadMoreRecords()">加载更多</button>
            </div>

            <!-- 无记录提示 -->
            <div class="no-records" id="noRecordsMessage" style="display: none;">
                <img src="icons/a-22-shoukuandingdan.png" alt="无记录">
                <p>暂无收款记录</p>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // 收款记录模块：统一封装收款记录加载、搜索、渲染等功能
const ReceiveRecordsModule = {
    // 1. 状态管理：存储配置、DOM元素缓存与状态
    state: {
        apiConfig: {
            recordsUrl: "http://graywolf.top:6031/payment/receipt/records",
            headers: {
                "User-Agent": "Apifox/1.0.0 (https://apifox.com)",
                "Accept": "*/*"
            }
        },
        elements: {
            listContainer: null,
            noRecordsMessage: null,
            searchInput: null,
            clearBtn: null,
            monthlyAmountEl: null,
            totalCountEl: null
        }
    },

    // 2. 初始化：页面加载后执行所有初始化逻辑
    init() {
        document.addEventListener("DOMContentLoaded", () => {
            this.cacheDomElements(); // 缓存DOM元素
            this.initSearchBox(); // 初始化搜索框
            this.loadReceiveRecords(); // 加载收款记录
        });

        // 暴露全局方法
        this.exposeGlobalMethods();
    },

    // 缓存DOM元素引用
    cacheDomElements() {
        this.state.elements.listContainer = document.getElementById("receiveRecordsList");
        this.state.elements.noRecordsMessage = document.getElementById("noRecordsMessage");
        this.state.elements.searchInput = document.getElementById("searchInput");
        this.state.elements.clearBtn = document.querySelector(".clear-btn");
        this.state.elements.monthlyAmountEl = document.getElementById("monthlyReceiveAmount");
        this.state.elements.totalCountEl = document.getElementById("totalReceiveCount");
    },

    // 暴露全局方法
    exposeGlobalMethods() {
        window.clearSearch = () => this.clearSearch();
        window.searchRecords = (keyword) => this.searchRecords(keyword);
        window.loadReceiveRecords = () => this.loadReceiveRecords();
        window.viewReceiveDetail = (record) => this.viewReceiveDetail(record);
        window.loadMoreRecords = () => this.loadMoreRecords();
    },

    // 3. 搜索功能初始化与处理
    /**
     * 初始化搜索框：绑定输入事件与清除按钮逻辑
     */
    initSearchBox() {
        const { searchInput, clearBtn } = this.state.elements;
        if (!searchInput || !clearBtn) return;

        // 输入事件监听
        searchInput.addEventListener("input", () => {
            // 显示/隐藏清除按钮
            clearBtn.style.display = searchInput.value.length > 0 ? "block" : "none";
            // 实时搜索
            this.searchRecords(searchInput.value);
        });
    },

    /**
     * 清除搜索内容并重新加载所有记录
     */
    clearSearch() {
        const { searchInput, clearBtn } = this.state.elements;
        if (!searchInput || !clearBtn) return;

        searchInput.value = "";
        clearBtn.style.display = "none";
        this.loadReceiveRecords(); // 重新加载所有记录
    },

    /**
     * 搜索记录（根据关键字过滤）
     * @param {string} keyword - 搜索关键字
     */
    searchRecords(keyword) {
        if (!keyword.trim()) {
            this.loadReceiveRecords();
            return;
        }

        // 从本地存储获取记录（假设已缓存）
        const records = this.getCachedRecords();
        if (!records.length) return;

        // 过滤匹配的记录
        const filteredRecords = records.filter(record =>
            record.name.includes(keyword) ||
            record.amount.toString().includes(keyword) ||
            record.time.includes(keyword)
        );

        // 渲染过滤结果
        this.renderReceiveRecords(filteredRecords);
    },

    /**
     * 从本地存储获取缓存的收款记录
     * @returns {Array} 收款记录数组
     */
    getCachedRecords() {
        try {
            return JSON.parse(localStorage.getItem("receiveRecords") || "[]");
        } catch (error) {
            console.error("获取缓存记录失败:", error);
            return [];
        }
    },

    // 4. 收款记录加载与处理
    /**
     * 从接口加载收款记录
     */
    loadReceiveRecords() {
        const { listContainer, noRecordsMessage } = this.state.elements;
        if (!listContainer || !noRecordsMessage) return;

        // 显示加载状态
        listContainer.innerHTML = '<div class="records-loading">加载收款记录中...</div>';
        noRecordsMessage.style.display = "none";

        // 获取用户Token
        const token = this.getAuthToken();
        if (!token) {
            listContainer.innerHTML = '<div class="records-error">请先登录</div>';
            return;
        }

        // 调用接口获取记录
        fetch(this.state.apiConfig.recordsUrl, {
            method: "GET",
            headers: {
                ...this.state.apiConfig.headers,
                "Authorization": `Bearer ${token}`
            }
        })
            .then(response => {
                if (!response.ok) throw new Error(`请求失败: ${response.status}`);
                return response.json();
            })
            .then(result => {
                if (result.code !== 200 || !Array.isArray(result.data?.items)) {
                    throw new Error(result.message || "获取收款记录失败");
                }

                // 转换接口数据格式
                const records = this.transformRecords(result.data.items);

                // 缓存记录到本地存储
                localStorage.setItem("receiveRecords", JSON.stringify(records));

                // 更新统计数据
                this.updateStatistics(records);

                // 渲染记录列表
                this.renderReceiveRecords(records);
            })
            .catch(error => {
                console.error("加载收款记录出错:", error);
                listContainer.innerHTML = `<div class="records-error">${error.message || "加载失败，请重试"}</div>`;
            });
    },

    /**
     * 转换接口数据为本地所需格式
     * @param {Array} apiRecords - 接口返回的原始记录
     * @returns {Array} 转换后的记录数组
     */
    transformRecords(apiRecords) {
        return apiRecords.map(item => ({
            id: item.transactionId,          // 交易ID
            name: item.payerId.toString(),   // 付款方ID
            amount: item.amount,             // 金额
            time: item.timestamp,            // 原始时间戳
            displayTime: ""                  // 预留显示时间字段
        }));
    },

    // 5. 统计数据更新
    /**
     * 更新收款统计数据（本月总额与总笔数）
     * @param {Array} records - 收款记录数组
     */
    updateStatistics(records) {
        const { monthlyAmountEl, totalCountEl } = this.state.elements;
        if (!monthlyAmountEl || !totalCountEl) return;

        // 计算本月收款总额
        const [currentYear, currentMonth] = this.getCurrentYearMonth();
        let monthlyTotal = 0;

        records.forEach(record => {
            try {
                const recordDate = new Date(record.time);
                if (!isNaN(recordDate.getTime()) &&
                    recordDate.getFullYear() === currentYear &&
                    recordDate.getMonth() === currentMonth) {
                    monthlyTotal += parseFloat(record.amount) || 0;
                }
            } catch (error) {
                console.warn("解析记录时间失败:", error, record);
            }
        });

        // 更新UI显示
        monthlyAmountEl.textContent = this.formatCurrency(monthlyTotal);
        totalCountEl.textContent = records.length;
    },

    /**
     * 获取当前年份和月份
     * @returns {Array} [年份, 月份]
     */
    getCurrentYearMonth() {
        const now = new Date();
        return [now.getFullYear(), now.getMonth()];
    },

    // 6. 记录渲染与分组
    /**
     * 渲染收款记录列表
     * @param {Array} records - 收款记录数组
     */
    renderReceiveRecords(records) {
        const { listContainer, noRecordsMessage } = this.state.elements;
        if (!listContainer || !noRecordsMessage) return;

        // 清空现有内容
        listContainer.innerHTML = "";

        // 处理空数据
        if (records.length === 0) {
            noRecordsMessage.style.display = "flex";
            return;
        }

        // 隐藏无记录提示
        noRecordsMessage.style.display = "none";

        // 按日期分组记录
        const groupedRecords = this.groupRecordsByDate(records);

        // 渲染分组记录
        Object.keys(groupedRecords).forEach(dateGroup => {
            const dateRecords = groupedRecords[dateGroup];
            listContainer.appendChild(this.createDateGroupElement(dateGroup, dateRecords));
        });
    },

    /**
     * 创建日期分组元素
     * @param {string} dateGroup - 日期分组名称（今天/昨天/具体日期）
     * @param {Array} records - 该日期下的记录
     * @returns {HTMLElement} 日期分组元素
     */
    createDateGroupElement(dateGroup, records) {
        // 计算当天收款总额
        const dailyTotal = records.reduce((sum, record) => {
            return sum + (parseFloat(record.amount) || 0);
        }, 0);

        // 创建日期组容器
        const dateGroupElement = document.createElement("div");
        dateGroupElement.className = "date-group";

        // 添加日期头部
        const dateHeader = document.createElement("div");
        dateHeader.className = "date-header";
        dateHeader.innerHTML = `
            <span class="date-text">${dateGroup}</span>
            <span class="date-amount">收款 ${this.formatCurrency(dailyTotal)}</span>
        `;
        dateGroupElement.appendChild(dateHeader);

        // 添加记录项
        records.forEach(record => {
            dateGroupElement.appendChild(this.createRecordItemElement(record));
        });

        return dateGroupElement;
    },

    /**
     * 创建单个记录项元素
     * @param {Object} record - 收款记录
     * @returns {HTMLElement} 记录项元素
     */
    createRecordItemElement(record) {
        const recordItem = document.createElement("div");
        recordItem.className = "transaction-item";
        recordItem.setAttribute("data-type", "income");
        recordItem.setAttribute("data-transaction-id", record.id);

        // 构建记录HTML
        recordItem.innerHTML = `
            <div class="transaction-icon">
                <img src="icons/shoukuanjiekou.png" alt="收款">
            </div>
            <div class="transaction-info">
                <div class="transaction-title">${record.name}</div>
                <div class="transaction-time">${record.displayTime}</div>
            </div>
            <div class="transaction-amount income">+${this.formatCurrency(record.amount)}</div>
        `;

        // 添加点击事件查看详情
        recordItem.addEventListener("click", () => {
            this.viewReceiveDetail(record);
        });

        return recordItem;
    },

    /**
     * 按日期分组记录（今天/昨天/具体日期）
     * @param {Array} records - 收款记录数组
     * @returns {Object} 按日期分组的记录
     */
    groupRecordsByDate(records) {
        const grouped = {};
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        const todayStr = today.toLocaleDateString("zh-CN");
        const yesterdayStr = yesterday.toLocaleDateString("zh-CN");

        records.forEach(record => {
            try {
                const recordDate = new Date(record.time);
                if (isNaN(recordDate.getTime())) {
                    throw new Error("无效的时间格式");
                }

                // 确定日期分组名称
                const dateStr = recordDate.toLocaleDateString("zh-CN");
                const displayDate = dateStr === todayStr
                    ? "今天"
                    : dateStr === yesterdayStr
                        ? "昨天"
                        : dateStr;

                // 初始化分组
                if (!grouped[displayDate]) {
                    grouped[displayDate] = [];
                }

                // 设置显示时间（时分）
                record.displayTime = recordDate.toLocaleTimeString("zh-CN", {
                    hour: "2-digit",
                    minute: "2-digit"
                });

                // 添加到分组
                grouped[displayDate].push(record);
            } catch (error) {
                console.warn("处理记录日期失败:", error, record);
            }
        });

        return grouped;
    },

    // 7. 详情查看与加载更多
    /**
     * 查看收款详情（跳转到结果页）
     * @param {Object} record - 收款记录
     */
    viewReceiveDetail(record) {
        console.log("查看收款详情:", record);

        // 构建跳转参数
        const params = new URLSearchParams({
            status: "success",
            amount: record.amount,
            merchant: record.name,
            method: "收款码",
            time: new Date(record.time).toLocaleString("zh-CN"),
            transaction: record.id,
            type: "history"
        });

        window.location.href = `payment-result.html?${params.toString()}`;
    },

    /**
     * 加载更多记录（分页功能）
     */
    loadMoreRecords() {
        // 实际项目中可实现分页加载逻辑
        this.showToast("已加载全部记录");
    },

    // 8. 工具方法
    /**
     * 格式化金额为货币格式
     * @param {number} amount - 金额数值
     * @returns {string} 格式化后的金额字符串
     */
    formatCurrency(amount) {
        return new Intl.NumberFormat("zh-CN", {
            style: "currency",
            currency: "CNY",
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount);
    },

    /**
     * 获取用户认证Token
     * @returns {string} Token或空字符串
     */
    getAuthToken() {
        try {
            const userData = JSON.parse(localStorage.getItem("userData") || "{}");
            return userData.token || "";
        } catch (error) {
            console.error("获取token失败:", error);
            this.showToast("登录状态异常，请重新登录");
            return "";
        }
    },

    /**
     * 显示提示信息
     * @param {string} message - 提示内容
     */
    showToast(message) {
        // 简单实现，实际项目中可使用更完善的Toast组件
        alert(message);
    }
};

// 初始化收款记录模块
ReceiveRecordsModule.init();
    </script>
</body>
</html>