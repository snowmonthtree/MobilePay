<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出行码 - 移动支付应用</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 城市徽章样式 */
        .city-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 10px 15px;
            margin: 0 auto;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .city-badge:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .transit-tip {
            margin-top: 10px;
        }

        #currentCity {
            font-size: 16px;
        }
        
        /* 城市选择网格样式 */
        .city-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .city-item {
            background-color: #f5f5f5;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .city-item.active {
            border-color: #4a90e2;
            background-color: rgba(74, 144, 226, 0.1);
        }
        
        .city-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .city-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .city-support {
            font-size: 12px;
            color: #666;
        }
        
        /* 模拟操作区域样式 */
        .simulation-section {
            margin: 25px 15px;
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .simulation-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .simulation-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .simulation-item {
            position: relative;
        }
        
        .simulation-item.full-width {
            grid-column: span 2;
        }
        
        .simulation-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px 10px;
            border: none;
            border-radius: 10px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .simulation-btn .btn-icon {
            margin-bottom: 8px;
        }
        
        .simulation-btn .btn-icon img {
            width: 28px;
            height: 28px;
        }
        
        .simulation-btn span {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* 不同类型按钮的样式 */
        .simulation-btn.entry {
            background-color: rgba(82, 196, 26, 0.1);
            color: #52c41a;
        }
        
        .simulation-btn.exit {
            background-color: rgba(24, 144, 255, 0.1);
            color: #1890ff;
        }
        
        .simulation-btn.warning {
            background-color: rgba(250, 173, 20, 0.1);
            color: #faad14;
        }
        
        .simulation-btn.error {
            background-color: rgba(245, 34, 45, 0.1);
            color: #f5222d;
        }
        
        .simulation-btn.timeout {
            background-color: rgba(114, 46, 209, 0.1);
            color: #722ed1;
        }
        
        .simulation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .simulation-btn.entry:hover {
            background-color: rgba(82, 196, 26, 0.2);
        }
        
        .simulation-btn.exit:hover {
            background-color: rgba(24, 144, 255, 0.2);
        }
        
        .simulation-btn.warning:hover {
            background-color: rgba(250, 173, 20, 0.2);
        }
        
        .simulation-btn.error:hover {
            background-color: rgba(245, 34, 45, 0.2);
        }
        
        .simulation-btn.timeout:hover {
            background-color: rgba(114, 46, 209, 0.2);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- 顶部状态栏 -->

        <!-- 城市切换页面 -->
        <div class="transit-setup-page" id="transitSetupPage" style="display: none;">
            <!-- 头部导航 -->
            <div class="page-header">
                <button class="back-btn" onclick="showTransitPage()">
                    <img src="icons/danjiantouzuo.png" alt="返回">
                </button>
                <h1>城市切换</h1>
                <div class="header-placeholder"></div>
            </div>

            <!-- 城市切换说明 -->
            <div class="setup-intro">
                <div class="intro-icon">
                    <img src="icons/quanyitubiaoV1.png" alt="出行码">
                </div>
                <h2>切换城市</h2>
                <p>支持全国多个城市的公交、地铁出行</p>
                <p>先乘车，后付费，出行更便捷</p>
            </div>

            <!-- 城市选择 -->
            <div class="city-selection">
                <h3>选择城市</h3>
                <div class="city-grid">
                <div class="city-item active" onclick="selectCity('北京', event)">
                    <div class="city-name">北京</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('上海', event)">
                    <div class="city-name">上海</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('广州', event)">
                    <div class="city-name">广州</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('深圳', event)">
                    <div class="city-name">深圳</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('杭州', event)">
                    <div class="city-name">杭州</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('成都', event)">
                    <div class="city-name">成都</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('南京', event)">
                    <div class="city-name">南京</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('武汉', event)">
                     <div class="city-name">武汉</div>
                     <div class="city-support">地铁 · 公交</div>
                 </div>
             </div>
            </div>

            <!-- 切换按钮 -->
            <div class="setup-actions">
                <button class="btn-primary full-width" onclick="switchCity()">
                    确认切换
                </button>
                <div class="setup-agreement">
                    <label>
                        <input type="checkbox" checked>
                        我已阅读并同意《出行码服务协议》
                    </label>
                </div>
            </div>
        </div>

        <!-- 出行码使用页面 -->
        <div class="transit-page" id="transitPage">
            <!-- 头部导航 -->
            <div class="page-header">
                <button class="back-btn" onclick="goBack()">
                    <img src="icons/danjiantouzuo.png" alt="返回">
                </button>
                <h1>出行码</h1>
                <div class="header-placeholder"></div>
            </div>

            <!-- 城市信息 -->
            <div class="transit-city-info">
                <div class="city-badge" onclick="showCitySetupPage()">
                    <span id="currentCity">北京</span>
                    <img src="icons/danjiantouxia.png" alt="切换城市" style="width: 16px; height: 16px; margin-left: 5px; filter: brightness(0) invert(1);">
                </div>
                <p class="transit-tip">请对准闸机扫码</p>
            </div>

            <!-- 出行码区域 -->
            <div class="transit-qr-container">
                <div class="transit-qr-code" id="transitQR">
                    <!-- 动态出行码 -->
                    <div class="qr-placeholder transit-qr">
                        <div class="qr-grid">
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                        </div>
                    </div>
                </div>
                <div class="qr-refresh-timer">
                    <span id="refreshCountdown">60</span>秒后自动刷新
                </div>
            </div>

            <!-- 出行记录入口 -->
            <div class="transit-records-entry">
                <button class="records-btn" onclick="goToTransitRecords()">
                    <img src="icons/a-27-lishishuju.png" alt="出行记录">
                    <span>出行记录</span>
                    <img src="icons/danjiantouyou.png" alt="查看">
                </button>
            </div>

            <div class="simulation-section">
                <h3 class="simulation-title">模拟操作</h3>
                
                <div class="simulation-grid">
                    <!-- 模拟进站按钮 -->
                    <div class="simulation-item">
                        <button class="simulation-btn entry" onclick="submitTransitEntry()">
                            <span>模拟进站</span>
                        </button>
                    </div>

                    <!-- 模拟出站按钮 -->
                    <div class="simulation-item">
                        <button class="simulation-btn exit" onclick="submitTransitExit()">
                            <span>模拟出站</span>
                        </button>
                    </div>


            </div>
        </div>

        <!-- 出行结果弹窗 -->
        <div class="modal" id="transitResultModal" style="display: none;">
            <div class="modal-content">
                <div class="transit-result-icon">
                    <img src="icons/chenggong.png" alt="成功">
                </div>
                <h2 style="text-align: center; margin-bottom: 5px;">出站成功</h2>
                <div class="transit-result-info">
                    <div class="result-item">
                        <span class="label">进站：</span>
                        <span class="value">天安门东站</span>
                    </div>
                    <div class="result-item">
                        <span class="label">出站：</span>
                        <span class="value">王府井站</span>
                    </div>
                    <div class="result-item">
                        <span class="label">时长：</span>
                        <span class="value">15分钟</span>
                    </div>
                    <div class="result-item">
                        <span class="label">费用：</span>
                        <span class="value amount">¥4.00</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeModal('transitResultModal')">返回</button>
                    <button class="btn-primary" onclick="goToTransitRecords()">查看记录</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script src="libs/qrcode.js"></script>
    <script src="script.js"></script>
    <script>
        let transitQRTimer;
        let refreshCountdown = 60;
        let countdownTimer;
        let selectedCity = '北京';
        let selectedCityId='1100'
        let selectedPayment = 'balance';

let siteName = "";
let type = "";
// 用于缓存接口返回的城市列表数据（ID与名称映射）
let cityList = [];

        // 页面加载时的初始化
document.addEventListener('DOMContentLoaded', function () {
    console.log('页面加载完成');
    fetchTransitPassList();
    // 1. 先获取城市列表并渲染组件
    fetchCityList().then(() => {
        // 2. 渲染城市选择组件
        renderCityGrid();
        // 3. 初始化用户所在城市
        initUserCity();
        // 4. 显示出行码页面
        setTimeout(showTransitPage, 100);
        fetchTransitQRByCityId();
    });
});
function fetchTransitPassList() {
    // 获取用户token
    let token = '';
    try {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        token = userData.token || '';
    } catch (error) {
        console.error('解析用户token失败:', error);
        showToast('初始化出行码失败');
        return;
    }

    if (!token) {
        console.error('用户token为空');
        showToast('初始化出行码失败');
        return;
    }

    // 调用接口
    fetch('http://graywolf.top:6031/payment/transit/pass/list', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
            'Accept': '*/*',
            'Host': 'graywolf.top:6031',
            'Connection': 'keep-alive'
        }
    })
    .then(response => {
        // 只关心返回码是否为200
        if (!response.ok) {
            throw new Error(`HTTP状态码: ${response.status}`);
        }
        // 成功时不做任何提示
    })
    .catch(error => {
        console.error('调用出行码列表接口失败:', error);
        showToast('初始化出行码失败');
    });
}
/**
 * 调用接口获取城市列表
 */
function fetchCityList() {
    return new Promise((resolve) => {
        // 获取token
        let token = '';
        try {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            token = userData.token || '';
        } catch (error) {
            console.error('获取token失败:', error);
        }

        // 调用城市列表接口
        fetch('http://graywolf.top:6031/payment/transit/pass/cities', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
                'Accept': '*/*'
            }
        })
        .then(response => response.ok ? response.json() : { code: -1 })
        .then(result => {
            if (result.code === 200 && Array.isArray(result.data)) {
                cityList = result.data; // 缓存城市列表
                console.log('城市列表获取成功:', cityList);
            } else {
                console.warn('使用默认城市列表');
                // 接口失败时使用默认数据
                cityList = [
                    { id: 1, cityId: '1100', cityName: '北京' },
                    { id: 2, cityId: '3100', cityName: '上海' },
                ];
            }
            resolve();
        })
        .catch(error => {
            console.error('获取城市列表失败:', error);
            // 网络错误时使用默认数据
            cityList = [
                { id: 1, cityId: '1100', cityName: '北京' },
                { id: 2, cityId: '3100', cityName: '上海' }
            ];
            resolve();
        });
    });
}

/**
 * 动态渲染城市选择组件
 */
function renderCityGrid() {
    const cityGrid = document.querySelector('.city-grid');
    if (!cityGrid) {
        console.error('未找到城市网格容器');
        return;
    }

    // 清空原有内容
    cityGrid.innerHTML = '';

    // 动态生成城市项
    cityList.forEach((city, index) => {
        const cityItem = document.createElement('div');
        // 第一个城市默认选中
        cityItem.className = `city-item ${index === 0 ? 'active' : ''}`;
        // 绑定点击事件，传递城市名称和事件对象
        cityItem.onclick = (event) => selectCity(city.cityName, event);

        // 设置城市项内容
        cityItem.innerHTML = `
            <div class="city-name">${city.cityName}</div>
            <div class="city-support">地铁 · 公交</div>
        `;

        cityGrid.appendChild(cityItem);
    });
}

/**
 * 初始化用户所在城市
 */
function initUserCity() {
    const userLocation = getUserLocation();
    console.log('用户所在城市:', userLocation);

    // 查找用户所在城市在列表中的位置
    const matchedCity = cityList.find(city => city.cityName === userLocation);
    if (matchedCity) {
        selectedCity = matchedCity.cityName;
        selectedCityId = matchedCity.cityId;
    } else {
        // 未找到时使用列表第一个城市
        selectedCity = cityList[0]?.cityName || '北京';
        selectedCityId = cityList[0]?.cityId || '1100';
    }

    // 保存到会话存储
    sessionStorage.setItem('transitCity', selectedCity);
    sessionStorage.setItem('transitCityId', selectedCityId);
}

/**
 * 获取用户所在城市（模拟函数）
 */
function getUserLocation() {
    // 实际应用中通过定位API获取
    return '北京';
}

/**
 * 选择城市 - 同步更新城市ID和选中状态
 * @param {string} cityName - 城市名称
 * @param {Event} event - 点击事件
 */
function selectCity(cityName, event) {
    if (!event) event = window.event;
    console.log('选择城市:', cityName);

    // 更新选中的城市名称和ID
    selectedCity = cityName;
    const matchedCity = cityList.find(city => city.cityName === cityName);
    selectedCityId = matchedCity ? matchedCity.cityId : '';
    console.log('当前城市ID:', selectedCityId);

    // 更新选中样式
    document.querySelectorAll('.city-item').forEach(item => {
        item.classList.remove('active');
    });
    const cityItem = event.target.closest('.city-item');
    if (cityItem) {
        cityItem.classList.add('active');
    }

    // 保存到会话存储
    sessionStorage.setItem('transitCity', selectedCity);
    sessionStorage.setItem('transitCityId', selectedCityId);
}
/**
 * 根据当前选中的城市ID获取出行码并生成二维码
 */
function fetchTransitQRByCityId() {
    // 获取二维码容器和倒计时元素
    const qrContainer = document.getElementById('transitQR');
    const countdownEl = document.getElementById('refreshCountdown');

    // 验证必要元素
    if (!qrContainer || !countdownEl) {
        console.error('未找到二维码容器或倒计时元素');
        return;
    }

    // 显示加载状态
    qrContainer.innerHTML = '<div class="qr-loading">加载出行码中...</div>';

    // 验证城市ID
    if (!selectedCityId) {
        showQRCodeError('未选择城市，请先选择城市');
        return;
    }

    // 获取用户token
    let token = '';
    try {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        token = userData.token || '';

    } catch (error) {
        console.error('获取token失败:', error);
        showQRCodeError('登录状态异常，请重新登录');
        return;
    }

    if (!token) {
        showQRCodeError('未检测到登录状态，请先登录');
        return;
    }

    // 调用接口获取出行码数据
    fetch(`http://graywolf.top:6031/payment/transit/pass/city/${selectedCityId}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
            'Accept': '*/*'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`请求失败，状态码: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        // 验证接口返回数据
        if (result.code !== 200 || !result.data || !result.data.codeUrl) {
            throw new Error(result.message || '获取出行码失败');
        }

        // 生成二维码
        generateQRCode(result.data.codeUrl);

        // 启动刷新倒计时
    })
    .catch(error => {
        console.error('获取出行码出错:', error);
        showQRCodeError(error.message || '加载出行码失败，请重试');
    });
}

/**
 * 生成二维码
 * @param {string} codeUrl - 接口返回的二维码内容URL
 */
function generateQRCode(codeUrl) {
    const qrContainer = document.getElementById('transitQR');
    if (!qrContainer) return;

    // 清空容器
    qrContainer.innerHTML = '';

    // 检查二维码库是否加载
    if (typeof QRCode === 'undefined') {
        qrContainer.innerHTML = '<div class="qr-error">二维码生成库未加载</div>';
        return;
    }
let optimizedUrl = codeUrl;
    try {
        const urlObj = new URL(codeUrl);
        // 保留核心路径，移除签名参数（根据实际需求调整）
        optimizedUrl = urlObj.origin + urlObj.pathname;
    } catch (e) {
        console.warn('URL优化失败，使用原始URL:', e);
        optimizedUrl = codeUrl; // 优化失败时使用原始URL
    }

                fetchRandomSite();
    // 生成二维码
    new QRCode(qrContainer, {
        text: optimizedUrl,
        width: 240,
        height: 240,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H,
        version:20
    });
}
function showQRCodeError(message) {
    const qrContainer = document.getElementById('transitQR');
    if (qrContainer) {
        qrContainer.innerHTML = `
            <div class="qr-error">
                <div class="error-icon">⚠️</div>
                <div class="error-message">${message}</div>
                <button class="retry-btn" onclick="fetchTransitQRByCityId()">重试</button>
            </div>
        `;
    }

    // 清除计时器
    if (window.qrRefreshTimer) {
        clearInterval(window.qrRefreshTimer);
    }
}
        // 选择支付方式
        function selectPayment(payment) {
            selectedPayment = payment;
            document.querySelectorAll('.payment-item').forEach(item => {
                item.classList.remove('active');
                item.querySelector('.payment-check').textContent = '';
            });
            event.target.closest('.payment-item').classList.add('active');
            event.target.closest('.payment-item').querySelector('.payment-check').textContent = '✓';
        }

        // 显示城市设置页面
        function showCitySetupPage() {
            console.log('显示城市设置页面');
            const transitPage = document.getElementById('transitPage');
            const setupPage = document.getElementById('transitSetupPage');
            
            console.log('transitPage:', transitPage);
            console.log('setupPage:', setupPage);
            
            if (transitPage) {
                transitPage.style.display = 'none';
            } else {
                console.error('找不到transitPage元素');
            }
            
            if (setupPage) {
                setupPage.style.display = 'block';
            } else {
                console.error('找不到transitSetupPage元素');
            }
            
            // 设置当前选中的城市
            const currentCity = sessionStorage.getItem('transitCity') || '北京';
            selectedCity = currentCity;
            console.log('当前选中城市:', currentCity);
            
            // 更新城市选择UI
            document.querySelectorAll('.city-item').forEach(item => {
                const cityName = item.querySelector('.city-name').textContent;
                if (cityName === currentCity) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // 切换城市
        function switchCity() {
            const loading = showLoading('正在切换城市...');

            setTimeout(function () {
                hideLoading(loading);
                sessionStorage.setItem('transitCity', selectedCity);
                showToast('城市切换成功！');
                showTransitPage();
            }, 1000);
        }

        // 显示出行码页面
        function showTransitPage() {
            console.log('显示出行码页面');
            document.getElementById('transitSetupPage').style.display = 'none';
            document.getElementById('transitPage').style.display = 'block';

            // 设置城市信息
            const city = sessionStorage.getItem('transitCity') || '北京';
            document.getElementById('currentCity').textContent = city;

            // 启动二维码刷新
            startTransitQRRefresh();
        }

        // 启动出行码自动刷新
        function startTransitQRRefresh() {
            refreshTransitQR();

            transitQRTimer = setInterval(function () {
                refreshTransitQR();
            }, 60000);

            startCountdown();
        }

        // 刷新出行码
        function refreshTransitQR() {
            fetchTransitQRByCityId()
        }

        // 倒计时
        function startCountdown() {
            if (countdownTimer) {
        clearInterval(countdownTimer);
    }

    // 重置倒计时（可选，根据需求决定是否重置）
    refreshCountdown = 60;
    document.getElementById('refreshCountdown').textContent = refreshCountdown;

    // 创建新计时器
    countdownTimer = setInterval(function () {
        refreshCountdown--;
        document.getElementById('refreshCountdown').textContent = refreshCountdown;

        if (refreshCountdown <= 0) {
            // 倒计时结束：清除计时器并执行刷新逻辑
            clearInterval(countdownTimer);
            refreshCountdown = 60; // 重置为初始值
            // 这里可以添加刷新二维码的逻辑，例如：
            // fetchTransitQRByCityId();
            // 刷新后重新启动倒计时：
            startCountdown();
        }
    }, 1000);
        }

        // 更换支付方式
        function changePaymentMethod() {
            showToast('支付方式更换功能');
        }

        // 模拟出行结果
        function simulateTransitResult(isInStation = false, isError = false, errorType = '') {
            const transitStatus = document.getElementById('transitStatus');
            const modal = document.getElementById('transitResultModal');
            const modalContent = modal.querySelector('.modal-content');
            const resultIcon = modal.querySelector('.transit-result-icon img');
            const resultTitle = modal.querySelector('h2');
            const resultInfo = modal.querySelector('.transit-result-info');
            const modalActions = modal.querySelector('.modal-actions');

            // 处理异常情况
            if (isError) {
            console.log('错误',errorType)
                if (errorType === 'payment_failed') {
                    // 调整弹窗内容为支付异常提示
                    resultIcon.src = "icons/shibai.png"; // 使用失败图标
                    resultIcon.parentElement.style.background = "red"
                    resultTitle.textContent = "支付异常";
                    resultTitle.style.color = "#FF3B30";

                    // 支付失败异常
                    resultInfo.innerHTML = `
                    <div class="result-item">
                        <span class="label">异常类型：</span>
                        <span class="value" style="color: #FF3B30">支付失败</span>
                    </div>
                    <div class="result-item">
                        <span class="label">出站：</span>
                        <span class="value">${siteName}</span>
                    </div>
                    <div class="result-item">
                        <span class="label">费用：</span>
                        <span class="value amount">¥4.00</span>
                    </div>
                    <div class="result-item">
                        <span class="label">处理方式：</span>
                        <span class="value">请立即补缴或联系客服</span>
                    </div>
                    `;
                } else if (errorType === 'no_entry') {
                    // 调整弹窗内容为异常提示
                    resultIcon.src = "icons/shibai.png"; // 使用失败图标
                    resultIcon.parentElement.style.background = "red"
                    resultTitle.textContent = "出行异常";
                    resultTitle.style.color = "#FF3B30";
                    
                    resultInfo.innerHTML = `
                    <div class="result-item">
                        <span class="label">异常类型：</span>
                        <span class="value" style="color: #FF3B30">无入站记录出站</span>
                    </div>
                    <div class="result-item">
                        <span class="label">出站：</span>
                        <span class="value">王府井站</span>
                    </div>
                    <div class="result-item">
                        <span class="label">时间：</span>
                        <span class="value">${getCurrentTime()}</span>
                    </div>
                    <div class="result-item">
                        <span class="label">处理方式：</span>
                        <span class="value">请联系客服</span>
                    </div>
                    `;
                } else if (errorType === '24h_no_exit') {
                    // 调整弹窗内容为异常提示
                    resultIcon.src = "icons/shibai.png"; // 使用失败图标
                    resultIcon.parentElement.style.background = "red"
                    resultTitle.textContent = "出行异常";
                    resultTitle.style.color = "#FF3B30";
                    
                    resultInfo.innerHTML = `
                    <div class="result-item">
                        <span class="label">异常类型：</span>
                        <span class="value" style="color: #FF3B30">24小时未出站</span>
                    </div>
                    <div class="result-item">
                        <span class="label">进站：</span>
                        <span class="value">${siteName}</span>
                    </div>
                    <div class="result-item">
                        <span class="label">时间：</span>
                        <span class="value">${getCurrentTime()}</span>
                    </div>
                    <div class="result-item">
                        <span class="label">处理方式：</span>
                        <span class="value">请联系客服</span>
                    </div>
                    `;
                } else {
                    // 调整弹窗内容为异常提示
                    resultIcon.src = "icons/shibai.png"; // 使用失败图标
                    resultIcon.parentElement.style.background = "red"
                    resultTitle.textContent = "出行异常";
                    resultTitle.style.color = "#FF3B30";
                    
                    resultInfo.innerHTML = `
                    <div class="result-item">
                        <span class="label">异常类型：</span>
                        <span class="value" style="color: #FF3B30">未知异常</span>
                    </div>
                    <div class="result-item">
                        <span class="label">时间：</span>
                        <span class="value">${getCurrentTime()}</span>
                    </div>
                    <div class="result-item">
                        <span class="label">处理方式：</span>
                        <span class="value">请联系客服</span>
                    </div>
                    `;
                }

                // 根据异常类型更新按钮
                if (errorType === 'payment_failed') {
                    // 支付失败时显示立即补缴和联系客服按钮
                    modalActions.innerHTML = `
                        <button class="btn-secondary" onclick="contactCustomerService()">联系客服</button>
                        <button class="btn-primary" onclick="makePayment()">立即补缴</button>
                    `;
                } else {
                    // 其他异常情况只显示联系客服和关闭按钮
                    modalActions.innerHTML = `
                        <button class="btn-secondary" onclick="closeModal('transitResultModal')">关闭</button>
                        <button class="btn-primary" onclick="contactCustomerService()">联系客服</button>
                    `;
                }
            } else if (isInStation) {
                // 调整弹窗内容为进站成功
                resultIcon.src = "icons/chenggong.png"; 
                resultIcon.parentElement.style.background = "#52c41a"
                resultTitle.textContent = "进站成功";
                resultTitle.style.color = "#333";

                resultInfo.innerHTML = `
                <div class="result-item">
                    <span class="label">进站：</span>
                    <span class="value">${siteName}</span>
                </div>
                <div class="result-item">
                    <span class="label">时间：</span>
                    <span class="value">${getCurrentTime()}</span>
                </div>
            `;

                // 恢复默认按钮
                modalActions.innerHTML = `
                    <button class="btn-secondary" onclick="closeModal('transitResultModal')">返回</button>
                    <button class="btn-primary" onclick="goToTransitRecords()">查看记录</button>
                `;
            } else {
                resultIcon.src = "icons/chenggong.png";
                resultIcon.parentElement.style.background = "#52c41a"
                resultTitle.textContent = "出站成功";
                resultTitle.style.color = "#333";

                resultInfo.innerHTML = `
                <div class="result-item">
                    <span class="label">出站：</span>
                    <span class="value">${siteName}</span>
                </div>
                <div class="result-item">
                    <span class="label">时间：</span>
                    <span class="value">${getCurrentTime()}</span>
                </div>
                <div class="result-item">
                    <span class="label">费用：</span>
                    <span class="value amount">¥4.00</span>
                </div>
            `;

                // 恢复默认按钮
                modalActions.innerHTML = `
                    <button class="btn-secondary" onclick="closeModal('transitResultModal')">返回</button>
                    <button class="btn-primary" onclick="goToTransitRecords()">查看记录</button>
                `;
            }

            modal.style.display = 'flex';
        }

        // 获取当前时间函数
        function getCurrentTime() {
            const now = new Date();
            return `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        // 关闭弹窗
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 联系客服
        function contactCustomerService() {
            // 关闭当前弹窗
            closeModal('transitResultModal');
            
            // 显示联系客服提示
            const loading = showLoading('正在连接客服...');
            
            setTimeout(function() {
                hideLoading(loading);
                showToast('已为您转接至客服，请稍候...');
                
                // 这里可以添加实际的客服联系逻辑
                // 例如跳转到客服页面或打开聊天窗口
            }, 1500);
        }
        
        // 立即补缴
        function makePayment() {
            // 关闭当前弹窗
            closeModal('transitResultModal');
            
            // 显示支付中提示
            const loading = showLoading('正在处理支付...');
            
            setTimeout(function() {
                hideLoading(loading);
                showToast('支付成功！');
                
                // 更新状态
                const transitStatus = document.getElementById('transitStatus');
            }, 1500);
        }
function fetchRandomSite() {
    // 验证选中城市是否存在
    if (!selectedCity) {
        console.error('未选择城市，无法获取站点数据');
        return;
    }

    // 获取用户token
    let token = '';
    try {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        token = userData.token || '';

    } catch (error) {
        console.error('获取token失败:', error);
        return;
    }

    if (!token) {
        console.warn('未获取到token，无法请求站点数据');
        return;
    }

    // 对城市名称进行URL编码，处理中文参数
    const encodedCity = encodeURIComponent(selectedCity);

    // 调用接口（使用编码后的城市名称）
    fetch(`http://graywolf.top:6031/payment/transit/sites?city=${encodedCity}&type=SUBWAY`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
            'Accept': '*/*'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`接口请求失败: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        if (result.code !== 200 || !Array.isArray(result.data) || result.data.length === 0) {
            throw new Error(result.message || '未获取到站点数据');
        }

        // 从数据中随机选择一个站点
        const sites = result.data;
        const randomIndex = Math.floor(Math.random() * sites.length);
        const randomSite = sites[randomIndex];

        // 赋值给全局变量
        siteName = randomSite.siteName || "";
        type = randomSite.type || "";

        console.log(`随机选中的${selectedCity}站点:`, { siteName, type });
        // 此处可添加后续逻辑，如更新页面显示等
    })
    .catch(error => {
        console.error('获取站点数据失败:', error);
        // 错误处理：重置为空或使用默认值
        siteName = "金安桥";
        type = "SUBWAY";
    });
}
function submitTransitEntry() {
    // 验证必要参数
    if (!siteName) {
        console.error('未获取到进站站点信息，请先加载站点数据');
        showToast('站点信息异常，无法提交进站记录');
        return;
    }

    // 获取用户token
    let token = '';
    try {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        token = userData.token || '';

    } catch (error) {
        console.error('获取token失败:', error);
        showToast('登录状态异常，无法提交');
        return;
    }

    if (!token) {
        showToast('请先登录');
        return;
    }

    // 生成当前时间（格式：YYYY-MM-DD HH:mm:ss）
    const currentTime = new Date();
    const formattedTime = `${currentTime.getFullYear()}-${
        String(currentTime.getMonth() + 1).padStart(2, '0')
    }-${
        String(currentTime.getDate()).padStart(2, '0')
    } ${
        String(currentTime.getHours()).padStart(2, '0')
    }:${
        String(currentTime.getMinutes()).padStart(2, '0')
    }:${
        String(currentTime.getSeconds()).padStart(2, '0')
    }`;

console.log('入时间',formattedTime);
    // 构建请求参数
    const requestData = {
        entryStation: siteName,       // 使用之前获取的站点名称
        entryTime: formattedTime,     // 当前时间
        mode: "SUBWAY"                // 固定为地铁模式
    };

    // 显示加载状态
    showToast('提交进站记录中...', 0);

    // 调用接口
    fetch('http://graywolf.top:6031/payment/transit/entry', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
            'Content-Type': 'application/json',
            'Accept': '*/*'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`接口请求失败: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {

        if (result.code === 200) {
            showToast('进站记录提交成功');
            console.log('进站成功:', result.data);
            simulateTransitResult(true,  false,  '');
            // 可添加后续逻辑，如跳转到进站成功页面
        } else {
            throw new Error(result.message || '提交进站记录失败');
        }
    })
    .catch(error => {
        console.error('进站记录提交失败:', error);
        showToast(error.message || '提交失败，请重试');
    });
}
function submitTransitExit() {
    // 验证是否已获取出站站点（可重新获取或使用新的随机站点）
    if (!siteName) {
        console.error('未获取到出站站点信息，请先加载站点数据');
        showToast('站点信息异常，无法提交出站记录');
        return;
    }

    // 获取用户token
    let token = '';
    try {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        token = userData.token || '';

    } catch (error) {
        console.error('获取token失败:', error);
        showToast('登录状态异常，无法提交');
        return;
    }

    if (!token) {
        showToast('请先登录');
        return;
    }

    // 生成当前时间（格式：YYYY-MM-DD HH:mm:ss）
    const currentTime = new Date();

    currentTime.setHours(currentTime.getHours() + 1);
    const formattedTime = `${currentTime.getFullYear()}-${
        String(currentTime.getMonth() + 1).padStart(2, '0')
    }-${
        String(currentTime.getDate()).padStart(2, '0')
    } ${
        String(currentTime.getHours()).padStart(2, '0')
    }:${
        String(currentTime.getMinutes()).padStart(2, '0')
    }:${
        String(currentTime.getSeconds()).padStart(2, '0')
    }`;
console.log('出时间',formattedTime);
    // 构建请求参数
    const requestData = {
        exitStation: siteName,        // 使用获取的站点名称作为出站站点
        exitTime: formattedTime,      // 当前时间作为出站时间
        mode: "SUBWAY"                // 固定为地铁模式
    };

    // 显示加载状态
    showToast('提交出站记录中...', 0);

    // 调用出站接口
    fetch('http://graywolf.top:6031/payment/transit/exit', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
            'Content-Type': 'application/json',
            'Accept': '*/*'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`接口请求失败: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {

        if (result.code === 200) {
            showToast('出站记录提交成功');
            console.log('出站成功:', result.data);
            simulateTransitResult(false,  false,  '')
            // 可添加后续逻辑，如显示费用信息、跳转到首页等
        } else {

        console.log('出战失败',JSON.stringify(result));
        if(result.data.reason==='没有找到未完成的出行记录'){
         simulateTransitResult(false,true,'no_entry');
         }
            throw new Error(result.data.reason || '提交出站记录失败');
        }
    })
    .catch(error => {
        console.error('出站记录提交失败:', error);
        if(error.message === '余额不足'){
        simulateTransitResult(false,  true,  'payment_failed')
        }
        showToast(error.message || '提交失败，请重试');
    });
}
        // 页面卸载时清除定时器
        window.addEventListener('beforeunload', function () {
            if (transitQRTimer) {
                clearInterval(transitQRTimer);
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
        });
    </script>
</body>

</html>