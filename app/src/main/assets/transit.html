<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出行码 - 移动支付应用</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 城市徽章样式 */
        .city-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 10px 15px;
            margin: 0 auto;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .city-badge:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .transit-tip {
            margin-top: 10px;
        }

        #currentCity {
            font-size: 16px;
        }
        
        /* 城市选择网格样式 */
        .city-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .city-item {
            background-color: #f5f5f5;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .city-item.active {
            border-color: #4a90e2;
            background-color: rgba(74, 144, 226, 0.1);
        }
        
        .city-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .city-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .city-support {
            font-size: 12px;
            color: #666;
        }
        
        /* 模拟操作区域样式 */
        .simulation-section {
            margin: 25px 15px;
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .simulation-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .simulation-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .simulation-item {
            position: relative;
        }
        
        .simulation-item.full-width {
            grid-column: span 2;
        }
        
        .simulation-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px 10px;
            border: none;
            border-radius: 10px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .simulation-btn .btn-icon {
            margin-bottom: 8px;
        }
        
        .simulation-btn .btn-icon img {
            width: 28px;
            height: 28px;
        }
        
        .simulation-btn span {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* 不同类型按钮的样式 */
        .simulation-btn.entry {
            background-color: rgba(82, 196, 26, 0.1);
            color: #52c41a;
        }
        
        .simulation-btn.exit {
            background-color: rgba(24, 144, 255, 0.1);
            color: #1890ff;
        }
        
        .simulation-btn.warning {
            background-color: rgba(250, 173, 20, 0.1);
            color: #faad14;
        }
        
        .simulation-btn.error {
            background-color: rgba(245, 34, 45, 0.1);
            color: #f5222d;
        }
        
        .simulation-btn.timeout {
            background-color: rgba(114, 46, 209, 0.1);
            color: #722ed1;
        }
        
        .simulation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .simulation-btn.entry:hover {
            background-color: rgba(82, 196, 26, 0.2);
        }
        
        .simulation-btn.exit:hover {
            background-color: rgba(24, 144, 255, 0.2);
        }
        
        .simulation-btn.warning:hover {
            background-color: rgba(250, 173, 20, 0.2);
        }
        
        .simulation-btn.error:hover {
            background-color: rgba(245, 34, 45, 0.2);
        }
        
        .simulation-btn.timeout:hover {
            background-color: rgba(114, 46, 209, 0.2);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- 顶部状态栏 -->

        <!-- 城市切换页面 -->
        <div class="transit-setup-page" id="transitSetupPage" style="display: none;">
            <!-- 头部导航 -->
            <div class="page-header">
                <button class="back-btn" onclick="showTransitPage()">
                    <img src="icons/danjiantouzuo.png" alt="返回">
                </button>
                <h1>城市切换</h1>
                <div class="header-placeholder"></div>
            </div>

            <!-- 城市切换说明 -->
            <div class="setup-intro">
                <div class="intro-icon">
                    <img src="icons/quanyitubiaoV1.png" alt="出行码">
                </div>
                <h2>切换城市</h2>
                <p>支持全国多个城市的公交、地铁出行</p>
                <p>先乘车，后付费，出行更便捷</p>
            </div>

            <!-- 城市选择 -->
            <div class="city-selection">
                <h3>选择城市</h3>
                <div class="city-grid">
                <div class="city-item active" onclick="selectCity('北京', event)">
                    <div class="city-name">北京</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('上海', event)">
                    <div class="city-name">上海</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('广州', event)">
                    <div class="city-name">广州</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('深圳', event)">
                    <div class="city-name">深圳</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('杭州', event)">
                    <div class="city-name">杭州</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('成都', event)">
                    <div class="city-name">成都</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('南京', event)">
                    <div class="city-name">南京</div>
                    <div class="city-support">地铁 · 公交</div>
                </div>
                <div class="city-item" onclick="selectCity('武汉', event)">
                     <div class="city-name">武汉</div>
                     <div class="city-support">地铁 · 公交</div>
                 </div>
             </div>
            </div>

            <!-- 切换按钮 -->
            <div class="setup-actions">
                <button class="btn-primary full-width" onclick="switchCity()">
                    确认切换
                </button>
                <div class="setup-agreement">
                    <label>
                        <input type="checkbox" checked>
                        我已阅读并同意《出行码服务协议》
                    </label>
                </div>
            </div>
        </div>

        <!-- 出行码使用页面 -->
        <div class="transit-page" id="transitPage">
            <!-- 头部导航 -->
            <div class="page-header">
                <button class="back-btn" onclick="goBack()">
                    <img src="icons/danjiantouzuo.png" alt="返回">
                </button>
                <h1>出行码</h1>
                <div class="header-placeholder"></div>
            </div>

            <!-- 城市信息 -->
            <div class="transit-city-info">
                <div class="city-badge" onclick="showCitySetupPage()">
                    <span id="currentCity">北京</span>
                    <img src="icons/danjiantouxia.png" alt="切换城市" style="width: 16px; height: 16px; margin-left: 5px; filter: brightness(0) invert(1);">
                </div>
                <p class="transit-tip">请对准闸机扫码</p>
            </div>

            <!-- 出行码区域 -->
            <div class="transit-qr-container">
                <div class="transit-qr-code" id="transitQR">
                    <!-- 动态出行码 -->
                    <div class="qr-placeholder transit-qr">
                        <div class="qr-grid">
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                            <div class="qr-dot"></div>
                        </div>
                    </div>
                </div>
                <div class="qr-refresh-timer">
                    <span id="refreshCountdown">60</span>秒后自动刷新
                </div>
            </div>

            <!-- 出行记录入口 -->
            <div class="transit-records-entry">
                <button class="records-btn" onclick="goToTransitRecords()">
                    <img src="icons/a-27-lishishuju.png" alt="出行记录">
                    <span>出行记录</span>
                    <img src="icons/danjiantouyou.png" alt="查看">
                </button>
            </div>

            <div class="simulation-section">
                <h3 class="simulation-title">模拟操作</h3>
                
                <div class="simulation-grid">
                    <!-- 模拟进站按钮 -->
                    <div class="simulation-item">
                        <button class="simulation-btn entry" onclick="submitTransitEntry()">
                            <span>模拟进站</span>
                        </button>
                    </div>

                    <!-- 模拟出站按钮 -->
                    <div class="simulation-item">
                        <button class="simulation-btn exit" onclick="submitTransitExit()">
                            <span>模拟出站</span>
                        </button>
                    </div>


            </div>
        </div>

        <!-- 出行结果弹窗 -->
        <div class="modal" id="transitResultModal" style="display: none;">
            <div class="modal-content">
                <div class="transit-result-icon">
                    <img src="icons/chenggong.png" alt="成功">
                </div>
                <h2 style="text-align: center; margin-bottom: 5px;">出站成功</h2>
                <div class="transit-result-info">
                    <div class="result-item">
                        <span class="label">进站：</span>
                        <span class="value">天安门东站</span>
                    </div>
                    <div class="result-item">
                        <span class="label">出站：</span>
                        <span class="value">王府井站</span>
                    </div>
                    <div class="result-item">
                        <span class="label">时长：</span>
                        <span class="value">15分钟</span>
                    </div>
                    <div class="result-item">
                        <span class="label">费用：</span>
                        <span class="value amount">¥4.00</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeModal('transitResultModal')">返回</button>
                    <button class="btn-primary" onclick="goToTransitRecords()">查看记录</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script src="libs/qrcode.js"></script>
    <script src="script.js"></script>
    <script>
        // 出行码模块：统一封装城市选择、出行码生成、进出站记录等核心功能
 const TransitCodeModule = {
     // 1. 状态管理：存储模块核心状态、配置与DOM元素缓存
     state: {
         // 定时器状态
         transitQRTimer: null,       // 出行码自动刷新定时器
         countdownTimer: null,       // 倒计时定时器
         refreshCountdown: 60,       // 刷新倒计时（秒）

         // 城市相关状态
         selectedCity: "北京",       // 当前选中城市
         selectedCityId: "1100",     // 当前选中城市ID
         cityList: [],               // 城市列表缓存（ID与名称映射）

         // 支付相关状态
         selectedPayment: "balance", // 当前选中支付方式

         // 站点与出行状态
         siteName: "",               // 随机选中的站点名称
         siteType: "",               // 站点类型（如地铁）

         // API配置
         apiConfig: {
             transitPassListUrl: "http://graywolf.top:6031/payment/transit/pass/list",
             cityListUrl: "http://graywolf.top:6031/payment/transit/pass/cities",
             transitQRUrl: "http://graywolf.top:6031/payment/transit/pass/city/",
             transitSitesUrl: "http://graywolf.top:6031/payment/transit/sites",
             transitEntryUrl: "http://graywolf.top:6031/payment/transit/entry",
             transitExitUrl: "http://graywolf.top:6031/payment/transit/exit",
             headers: {
                 "User-Agent": "Apifox/1.0.0 (https://apifox.com)",
                 "Accept": "*/*",
                 "Content-Type": "application/json"
             }
         },

         // DOM元素缓存
         elements: {
             // 页面容器
             transitPage: null,
             transitSetupPage: null,
             // 城市相关
             cityGrid: null,
             currentCity: null,
             // 出行码相关
             transitQR: null,
             refreshCountdown: null,
             // 模态框相关
             transitResultModal: null,
             transitStatus: null
         }
     },

     // 2. 初始化：页面加载后执行配置、事件绑定与数据加载
     init() {
         document.addEventListener("DOMContentLoaded", () => {
             this.cacheDomElements();  // 缓存DOM元素
             this.bindGlobalEvents();  // 绑定全局事件
             this.initTransitModule(); // 初始化出行码核心流程
         });

         // 暴露全局方法（兼容HTML onclick调用）
         this.exposeGlobalMethods();
     },

     // 缓存DOM元素引用，减少重复查询
     cacheDomElements() {
         const elements = this.state.elements;

         // 页面容器
         elements.transitPage = document.getElementById("transitPage");
         elements.transitSetupPage = document.getElementById("transitSetupPage");

         // 城市相关
         elements.cityGrid = document.querySelector(".city-grid");
         elements.currentCity = document.getElementById("currentCity");

         // 出行码相关
         elements.transitQR = document.getElementById("transitQR");
         elements.refreshCountdown = document.getElementById("refreshCountdown");

         // 模态框相关
         elements.transitResultModal = document.getElementById("transitResultModal");
         elements.transitStatus = document.getElementById("transitStatus");
     },

     // 绑定全局事件（如页面卸载清除定时器）
     bindGlobalEvents() {
         // 页面卸载时清除所有定时器，避免内存泄漏
         window.addEventListener("beforeunload", () => {
             if (this.state.transitQRTimer) clearInterval(this.state.transitQRTimer);
             if (this.state.countdownTimer) clearInterval(this.state.countdownTimer);
         });
     },

     // 初始化出行码核心流程：加载城市列表→渲染城市选择→显示出行码
     initTransitModule() {
         // 先加载出行码列表（初始化接口）
         this.fetchTransitPassList();

         // 加载城市列表→渲染城市选择→初始化用户城市→显示出行码
         this.fetchCityList()
             .then(() => {
                 this.renderCityGrid();
                 this.initUserCity();
                 setTimeout(() => this.showTransitPage(), 100);
                 this.fetchTransitQRByCityId();
             })
             .catch(error => {
                 console.error("出行码模块初始化失败:", error);
                 this.showToast("出行码初始化失败，请重试");
             });
     },

     // 暴露全局方法到window对象
     exposeGlobalMethods() {
         // 城市相关
         window.selectCity = (cityName, event) => this.selectCity(cityName, event);
         window.showCitySetupPage = () => this.showCitySetupPage();
         window.switchCity = () => this.switchCity();

         // 出行码相关
         window.showTransitPage = () => this.showTransitPage();
         window.refreshTransitQR = () => this.refreshTransitQR();
         window.changePaymentMethod = () => this.changePaymentMethod();

         // 进出站相关
         window.simulateTransitResult = (isInStation, isError, errorType) =>
             this.simulateTransitResult(isInStation, isError, errorType);
         window.submitTransitEntry = () => this.submitTransitEntry();
         window.submitTransitExit = () => this.submitTransitExit();

         // 通用工具
         window.closeModal = (modalId) => this.closeModal(modalId);
         window.contactCustomerService = () => this.contactCustomerService();
         window.makePayment = () => this.makePayment();
         window.goToTransitRecords = () => this.goToTransitRecords();
     },

     // 3. 出行码基础接口调用
     /**
      * 加载出行码列表（初始化接口，无UI反馈）
      */
     fetchTransitPassList() {
         const token = this.getUserToken();
         if (!token) return;

         fetch(this.state.apiConfig.transitPassListUrl, {
             method: "GET",
             headers: {
                 ...this.state.apiConfig.headers,
                 "Authorization": `Bearer ${token}`,
                 "Host": "graywolf.top:6031",
                 "Connection": "keep-alive"
             }
         })
             .then(response => {
                 if (!response.ok) throw new Error(`HTTP状态码: ${response.status}`);
             })
             .catch(error => {
                 console.error("调用出行码列表接口失败:", error);
                 this.showToast("初始化出行码失败");
             });
     },

     /**
      * 获取城市列表（接口失败时使用默认数据）
      * @returns {Promise} 城市列表加载结果
      */
     fetchCityList() {
         return new Promise((resolve) => {
             const token = this.getUserToken();

             fetch(this.state.apiConfig.cityListUrl, {
                 method: "GET",
                 headers: {
                     ...this.state.apiConfig.headers,
                     "Authorization": `Bearer ${token || ""}`
                 }
             })
                 .then(response => response.ok ? response.json() : { code: -1 })
                 .then(result => {
                     if (result.code === 200 && Array.isArray(result.data)) {
                         this.state.cityList = result.data;
                         console.log("城市列表获取成功:", this.state.cityList);
                     } else {
                         console.warn("使用默认城市列表");
                         this.state.cityList = [
                             { id: 1, cityId: "1100", cityName: "北京" },
                             { id: 2, cityId: "3100", cityName: "上海" }
                         ];
                     }
                     resolve();
                 })
                 .catch(error => {
                     console.error("获取城市列表失败:", error);
                     this.state.cityList = [
                         { id: 1, cityId: "1100", cityName: "北京" },
                         { id: 2, cityId: "3100", cityName: "上海" }
                     ];
                     resolve();
                 });
         });
     },

     /**
      * 根据城市ID获取出行码并生成二维码
      */
     fetchTransitQRByCityId() {
         const { transitQR, refreshCountdown } = this.state.elements;
         if (!transitQR || !refreshCountdown) {
             console.error("未找到二维码容器或倒计时元素");
             return;
         }

         // 显示加载状态
         transitQR.innerHTML = '<div class="qr-loading">加载出行码中...</div>';

         // 验证城市ID与Token
         if (!this.state.selectedCityId) {
             this.showQRCodeError("未选择城市，请先选择城市");
             return;
         }
         const token = this.getUserToken();
         if (!token) {
             this.showQRCodeError("未检测到登录状态，请先登录");
             return;
         }

         // 调用出行码接口
         fetch(`${this.state.apiConfig.transitQRUrl}${this.state.selectedCityId}`, {
             method: "GET",
             headers: {
                 ...this.state.apiConfig.headers,
                 "Authorization": `Bearer ${token}`
             }
         })
             .then(response => {
                 if (!response.ok) throw new Error(`请求失败，状态码: ${response.status}`);
                 return response.json();
             })
             .then(result => {
                 if (result.code !== 200 || !result.data || !result.data.codeUrl) {
                     throw new Error(result.message || "获取出行码失败");
                 }
                 // 生成二维码并启动刷新倒计时
                 this.generateQRCode(result.data.codeUrl);
                 this.startTransitQRRefresh();
             })
             .catch(error => {
                 console.error("获取出行码出错:", error);
                 this.showQRCodeError(error.message || "加载出行码失败，请重试");
             });
     },

     // 4. 城市选择相关逻辑
     /**
      * 动态渲染城市选择网格
      */
     renderCityGrid() {
         const { cityGrid } = this.state.elements;
         if (!cityGrid) {
             console.error("未找到城市网格容器");
             return;
         }

         // 清空原有内容
         cityGrid.innerHTML = "";

         // 生成城市选项
         this.state.cityList.forEach((city, index) => {
             const cityItem = document.createElement("div");
             cityItem.className = `city-item ${index === 0 ? "active" : ""}`;
             cityItem.onclick = (event) => this.selectCity(city.cityName, event);
             cityItem.innerHTML = `
                 <div class="city-name">${city.cityName}</div>
                 <div class="city-support">地铁 · 公交</div>
             `;
             cityGrid.appendChild(cityItem);
         });
     },

     /**
      * 初始化用户所在城市（模拟定位，优先从会话存储读取）
      */
     initUserCity() {
         // 优先从会话存储读取历史选择
         const sessionCity = sessionStorage.getItem("transitCity");
         const sessionCityId = sessionStorage.getItem("transitCityId");

         if (sessionCity && sessionCityId) {
             this.state.selectedCity = sessionCity;
             this.state.selectedCityId = sessionCityId;
             return;
         }

         // 模拟定位获取用户城市
         const userLocation = this.getUserLocation();
         const matchedCity = this.state.cityList.find(
             city => city.cityName === userLocation
         );

         // 匹配成功则使用定位城市，否则使用默认城市
         if (matchedCity) {
             this.state.selectedCity = matchedCity.cityName;
             this.state.selectedCityId = matchedCity.cityId;
         } else {
             this.state.selectedCity = this.state.cityList[0]?.cityName || "北京";
             this.state.selectedCityId = this.state.cityList[0]?.cityId || "1100";
         }

         // 保存到会话存储
         sessionStorage.setItem("transitCity", this.state.selectedCity);
         sessionStorage.setItem("transitCityId", this.state.selectedCityId);
     },

     /**
      * 选择城市（更新选中状态与城市ID）
      * @param {string} cityName - 城市名称
      * @param {Event} event - 点击事件
      */
     selectCity(cityName, event) {
         if (!event) event = window.event;
         console.log("选择城市:", cityName);

         // 更新选中城市与ID
         this.state.selectedCity = cityName;
         const matchedCity = this.state.cityList.find(
             city => city.cityName === cityName
         );
         this.state.selectedCityId = matchedCity ? matchedCity.cityId : "";

         // 更新UI选中状态
         document.querySelectorAll(".city-item").forEach(item => {
             item.classList.remove("active");
         });
         const cityItem = event.target.closest(".city-item");
         if (cityItem) cityItem.classList.add("active");

         // 保存到会话存储
         sessionStorage.setItem("transitCity", cityName);
         sessionStorage.setItem("transitCityId", this.state.selectedCityId);
     },

     /**
      * 显示城市设置页面
      */
     showCitySetupPage() {
         const { transitPage, transitSetupPage } = this.state.elements;
         if (!transitPage || !transitSetupPage) {
             console.error("未找到页面容器元素");
             return;
         }

         // 切换页面显示状态
         transitPage.style.display = "none";
         transitSetupPage.style.display = "block";

         // 同步当前选中城市的UI状态
         const currentCity = sessionStorage.getItem("transitCity") || "北京";
         document.querySelectorAll(".city-item").forEach(item => {
             const cityName = item.querySelector(".city-name").textContent;
             item.classList.toggle("active", cityName === currentCity);
         });
     },

     /**
      * 切换城市（带加载状态）
      */
     switchCity() {
         const loading = this.showLoading("正在切换城市...");

         // 模拟切换延迟，实际项目可替换为接口请求
         setTimeout(() => {
             this.hideLoading(loading);
             sessionStorage.setItem("transitCity", this.state.selectedCity);
             this.showToast("城市切换成功！");
             this.showTransitPage();
         }, 1000);
     },

     // 5. 出行码显示与刷新逻辑
     /**
      * 显示出行码页面
      */
     showTransitPage() {
         const { transitPage, transitSetupPage, currentCity } = this.state.elements;
         if (!transitPage || !transitSetupPage || !currentCity) {
             console.error("未找到页面或城市显示元素");
             return;
         }

         // 切换页面显示状态
         transitSetupPage.style.display = "none";
         transitPage.style.display = "block";

         // 更新当前城市显示
         const city = sessionStorage.getItem("transitCity") || "北京";
         currentCity.textContent = city;

         // 启动出行码刷新
         this.startTransitQRRefresh();
     },

     /**
      * 生成二维码（优化URL，兼容二维码库）
      * @param {string} codeUrl - 接口返回的二维码内容URL
      */
     generateQRCode(codeUrl) {
         const { transitQR } = this.state.elements;
         if (!transitQR) return;

         // 清空容器
         transitQR.innerHTML = "";

         // 检查二维码库是否加载
         if (typeof QRCode === "undefined") {
             transitQR.innerHTML = '<div class="qr-error">二维码生成库未加载</div>';
             return;
         }

         // 优化URL（移除冗余参数，保留核心路径）
         let optimizedUrl = codeUrl;
         try {
             const urlObj = new URL(codeUrl);
             optimizedUrl = urlObj.origin + urlObj.pathname;
         } catch (e) {
             console.warn("URL优化失败，使用原始URL:", e);
         }

         // 获取随机站点（用于进出站模拟）
         this.fetchRandomSite();

         // 生成二维码
         new QRCode(transitQR, {
             text: optimizedUrl,
             width: 240,
             height: 240,
             colorDark: "#000000",
             colorLight: "#ffffff",
             correctLevel: QRCode.CorrectLevel.H,
             version: 20
         });
     },

     /**
      * 启动出行码自动刷新（60秒/次）
      */
     startTransitQRRefresh() {
         // 清除旧定时器
         if (this.state.transitQRTimer) {
             clearInterval(this.state.transitQRTimer);
         }

         // 立即刷新一次
         this.refreshTransitQR();

         // 启动自动刷新定时器
         this.state.transitQRTimer = setInterval(() => {
             this.refreshTransitQR();
         }, 60000);

         // 启动倒计时显示
         this.startCountdown();
     },

     /**
      * 刷新出行码
      */
     refreshTransitQR() {
         this.fetchTransitQRByCityId();
     },

     /**
      * 启动刷新倒计时显示
      */
     startCountdown() {
         const { refreshCountdown } = this.state.elements;
                if (!refreshCountdown) return;

        // 清除旧定时器
        if (this.state.countdownTimer) {
            clearInterval(this.state.countdownTimer);
        }

        // 重置倒计时
        this.state.refreshCountdown = 60;
        refreshCountdown.textContent = this.state.refreshCountdown;

        // 启动新定时器
        this.state.countdownTimer = setInterval(() => {
            this.state.refreshCountdown--;
            refreshCountdown.textContent = this.state.refreshCountdown;

            if (this.state.refreshCountdown <= 0) {
                clearInterval(this.state.countdownTimer);
                this.state.refreshCountdown = 60; // 重置为初始值
                this.startCountdown(); // 重新启动倒计时
            }
        }, 1000);
    },

    /**
     * 显示二维码错误提示
     * @param {string} message - 错误信息
     */
    showQRCodeError(message) {
        const { transitQR } = this.state.elements;
        if (!transitQR) return;

        transitQR.innerHTML = `
            <div class="qr-error">
                <div class="error-icon">⚠️</div>
                <div class="error-message">${message}</div>
                <button class="retry-btn" onclick="refreshTransitQR()">重试</button>
            </div>
        `;

        // 清除刷新定时器
        if (this.state.transitQRTimer) {
            clearInterval(this.state.transitQRTimer);
        }
    },

    // 6. 站点与进出站相关逻辑
    /**
     * 获取随机站点（用于进出站模拟）
     */
    fetchRandomSite() {
        if (!this.state.selectedCity) {
            console.error("未选择城市，无法获取站点数据");
            return;
        }

        const token = this.getUserToken();
        if (!token) {
            console.warn("未获取到token，使用默认站点");
            this.state.siteName = "金安桥";
            this.state.siteType = "SUBWAY";
            return;
        }

        // 编码城市名称（处理中文）
        const encodedCity = encodeURIComponent(this.state.selectedCity);

        fetch(`${this.state.apiConfig.transitSitesUrl}?city=${encodedCity}&type=SUBWAY`, {
            method: "GET",
            headers: {
                ...this.state.apiConfig.headers,
                "Authorization": `Bearer ${token}`
            }
        })
            .then(response => {
                if (!response.ok) throw new Error(`接口请求失败: ${response.status}`);
                return response.json();
            })
            .then(result => {
                if (result.code !== 200 || !Array.isArray(result.data) || result.data.length === 0) {
                    throw new Error(result.message || "未获取到站点数据");
                }

                // 随机选择一个站点
                const randomIndex = Math.floor(Math.random() * result.data.length);
                const randomSite = result.data[randomIndex];
                this.state.siteName = randomSite.siteName || "";
                this.state.siteType = randomSite.type || "";
                console.log(`随机选中的${this.state.selectedCity}站点:`, {
                    siteName: this.state.siteName,
                    type: this.state.siteType
                });
            })
            .catch(error => {
                console.error("获取站点数据失败:", error);
                // 错误时使用默认站点
                this.state.siteName = "金安桥";
                this.state.siteType = "SUBWAY";
            });
    },

    /**
     * 提交进站记录
     */
    submitTransitEntry() {
        // 验证站点信息
        if (!this.state.siteName) {
            this.showToast("站点信息异常，无法提交进站记录");
            return;
        }

        // 验证登录状态
        const token = this.getUserToken();
        if (!token) {
            this.showToast("请先登录");
            return;
        }

        // 生成当前时间（格式：YYYY-MM-DD HH:mm:ss）
        const formattedTime = this.getFormattedDateTime();

        // 构建请求参数
        const requestData = {
            entryStation: this.state.siteName,
            entryTime: formattedTime,
            mode: "SUBWAY"
        };

        // 显示提交状态
        this.showToast("提交进站记录中...", 0);

        // 调用进站接口
        fetch(this.state.apiConfig.transitEntryUrl, {
            method: "POST",
            headers: {
                ...this.state.apiConfig.headers,
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify(requestData)
        })
            .then(response => {
                if (!response.ok) throw new Error(`接口请求失败: ${response.status}`);
                return response.json();
            })
            .then(result => {
                if (result.code === 200) {
                    this.showToast("进站记录提交成功");
                    console.log("进站成功:", result.data);
                    this.simulateTransitResult(true, false, "");
                } else {
                    throw new Error(result.message || "提交进站记录失败");
                }
            })
            .catch(error => {
                console.error("进站记录提交失败:", error);
                this.showToast(error.message || "提交失败，请重试");
            });
    },

    /**
     * 提交出站记录
     */
    submitTransitExit() {
        // 验证站点信息
        if (!this.state.siteName) {
            this.showToast("站点信息异常，无法提交出站记录");
            return;
        }

        // 验证登录状态
        const token = this.getUserToken();
        if (!token) {
            this.showToast("请先登录");
            return;
        }

        // 生成当前时间（加1小时，模拟行程时间）
        const currentTime = new Date();
        currentTime.setHours(currentTime.getHours() + 1);
        const formattedTime = this.getFormattedDateTime(currentTime);

        // 构建请求参数
        const requestData = {
            exitStation: this.state.siteName,
            exitTime: formattedTime,
            mode: "SUBWAY"
        };

        // 显示提交状态
        this.showToast("提交出站记录中...", 0);

        // 调用出站接口
        fetch(this.state.apiConfig.transitExitUrl, {
            method: "POST",
            headers: {
                ...this.state.apiConfig.headers,
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify(requestData)
        })
            .then(response => {
                if (!response.ok) throw new Error(`接口请求失败: ${response.status}`);
                return response.json();
            })
            .then(result => {
                if (result.code === 200) {
                    this.showToast("出站记录提交成功");
                    console.log("出站成功:", result.data);
                    this.simulateTransitResult(false, false, "");
                } else {
                    console.log("出站失败:", JSON.stringify(result));
                    if (result.data?.reason === "没有找到未完成的出行记录") {
                        this.simulateTransitResult(false, true, "no_entry");
                    }
                    throw new Error(result.data?.reason || "提交出站记录失败");
                }
            })
            .catch(error => {
                console.error("出站记录提交失败:", error);
                if (error.message === "余额不足") {
                    this.simulateTransitResult(false, true, "payment_failed");
                }
                this.showToast(error.message || "提交失败，请重试");
            });
    },

    // 7. 出行结果模拟与弹窗
    /**
     * 模拟出行结果弹窗（进站/出站/异常）
     * @param {boolean} isInStation - 是否为进站
     * @param {boolean} isError - 是否为异常
     * @param {string} errorType - 异常类型
     */
    simulateTransitResult(isInStation = false, isError = false, errorType = "") {
        const { transitResultModal } = this.state.elements;
        if (!transitResultModal) {
            console.error("未找到结果弹窗元素");
            return;
        }

        // 获取弹窗内部元素
        const modalContent = transitResultModal.querySelector(".modal-content");
        const resultIcon = modalContent.querySelector(".transit-result-icon img");
        const resultTitle = modalContent.querySelector("h2");
        const resultInfo = modalContent.querySelector(".transit-result-info");
        const modalActions = modalContent.querySelector(".modal-actions");

        if (!resultIcon || !resultTitle || !resultInfo || !modalActions) {
            console.error("弹窗内部元素不完整");
            return;
        }

        // 处理异常情况
        if (isError) {
            resultIcon.src = "icons/shibai.png";
            resultIcon.parentElement.style.background = "red";
            resultTitle.style.color = "#FF3B30";

            // 根据异常类型显示不同内容
            switch (errorType) {
                case "payment_failed":
                    resultTitle.textContent = "支付异常";
                    resultInfo.innerHTML = `
                        <div class="result-item">
                            <span class="label">异常类型：</span>
                            <span class="value" style="color: #FF3B30">支付失败</span>
                        </div>
                        <div class="result-item">
                            <span class="label">出站：</span>
                            <span class="value">${this.state.siteName}</span>
                        </div>
                        <div class="result-item">
                            <span class="label">费用：</span>
                            <span class="value amount">¥4.00</span>
                        </div>
                        <div class="result-item">
                            <span class="label">处理方式：</span>
                            <span class="value">请立即补缴或联系客服</span>
                        </div>
                    `;
                    modalActions.innerHTML = `
                        <button class="btn-secondary" onclick="contactCustomerService()">联系客服</button>
                        <button class="btn-primary" onclick="makePayment()">立即补缴</button>
                    `;
                    break;

                case "no_entry":
                    resultTitle.textContent = "出行异常";
                    resultInfo.innerHTML = `
                        <div class="result-item">
                            <span class="label">异常类型：</span>
                            <span class="value" style="color: #FF3B30">无入站记录出站</span>
                        </div>
                        <div class="result-item">
                            <span class="label">出站：</span>
                            <span class="value">王府井站</span>
                        </div>
                        <div class="result-item">
                            <span class="label">时间：</span>
                            <span class="value">${this.getCurrentTime()}</span>
                        </div>
                        <div class="result-item">
                            <span class="label">处理方式：</span>
                            <span class="value">请联系客服</span>
                        </div>
                    `;
                    modalActions.innerHTML = `
                        <button class="btn-secondary" onclick="closeModal('transitResultModal')">关闭</button>
                        <button class="btn-primary" onclick="contactCustomerService()">联系客服</button>
                    `;
                    break;

                case "24h_no_exit":
                    resultTitle.textContent = "出行异常";
                    resultInfo.innerHTML = `
                        <div class="result-item">
                            <span class="label">异常类型：</span>
                            <span class="value" style="color: #FF3B30">24小时未出站</span>
                        </div>
                        <div class="result-item">
                            <span class="label">进站：</span>
                            <span class="value">${this.state.siteName}</span>
                        </div>
                        <div class="result-item">
                            <span class="label">时间：</span>
                            <span class="value">${this.getCurrentTime()}</span>
                        </div>
                        <div class="result-item">
                            <span class="label">处理方式：</span>
                            <span class="value">请联系客服</span>
                        </div>
                    `;
                    modalActions.innerHTML = `
                        <button class="btn-secondary" onclick="closeModal('transitResultModal')">关闭</button>
                        <button class="btn-primary" onclick="contactCustomerService()">联系客服</button>
                    `;
                    break;

                default:
                    resultTitle.textContent = "出行异常";
                    resultInfo.innerHTML = `
                        <div class="result-item">
                            <span class="label">异常类型：</span>
                            <span class="value" style="color: #FF3B30">未知异常</span>
                        </div>
                        <div class="result-item">
                            <span class="label">时间：</span>
                            <span class="value">${this.getCurrentTime()}</span>
                        </div>
                        <div class="result-item">
                            <span class="label">处理方式：</span>
                            <span class="value">请联系客服</span>
                        </div>
                    `;
                    modalActions.innerHTML = `
                        <button class="btn-secondary" onclick="closeModal('transitResultModal')">关闭</button>
                        <button class="btn-primary" onclick="contactCustomerService()">联系客服</button>
                    `;
            }
        }
        // 处理进站成功
        else if (isInStation) {
            resultIcon.src = "icons/chenggong.png";
            resultIcon.parentElement.style.background = "#52c41a";
            resultTitle.textContent = "进站成功";
            resultTitle.style.color = "#333";

            resultInfo.innerHTML = `
                <div class="result-item">
                    <span class="label">进站：</span>
                    <span class="value">${this.state.siteName}</span>
                </div>
                <div class="result-item">
                    <span class="label">时间：</span>
                    <span class="value">${this.getCurrentTime()}</span>
                </div>
            `;

            modalActions.innerHTML = `
                <button class="btn-secondary" onclick="closeModal('transitResultModal')">返回</button>
                <button class="btn-primary" onclick="goToTransitRecords()">查看记录</button>
            `;
        }
        // 处理出站成功
        else {
            resultIcon.src = "icons/chenggong.png";
            resultIcon.parentElement.style.background = "#52c41a";
            resultTitle.textContent = "出站成功";
            resultTitle.style.color = "#333";

            resultInfo.innerHTML = `
                <div class="result-item">
                    <span class="label">出站：</span>
                    <span class="value">${this.state.siteName}</span>
                </div>
                <div class="result-item">
                    <span class="label">时间：</span>
                    <span class="value">${this.getCurrentTime()}</span>
                </div>
                <div class="result-item">
                    <span class="label">费用：</span>
                    <span class="value amount">¥4.00</span>
                </div>
            `;

            modalActions.innerHTML = `
                <button class="btn-secondary" onclick="closeModal('transitResultModal')">返回</button>
                <button class="btn-primary" onclick="goToTransitRecords()">查看记录</button>
            `;
        }

        // 显示弹窗
        transitResultModal.style.display = "flex";
    },

    // 8. 支付方式与异常处理
    /**
     * 选择支付方式
     * @param {string} payment - 支付方式标识
     */
    selectPayment(payment) {
        this.state.selectedPayment = payment;

        // 更新UI选中状态
        document.querySelectorAll(".payment-item").forEach(item => {
            item.classList.remove("active");
            item.querySelector(".payment-check").textContent = "";
        });

        const selectedItem = event.target.closest(".payment-item");
        if (selectedItem) {
            selectedItem.classList.add("active");
            selectedItem.querySelector(".payment-check").textContent = "✓";
        }
    },

    /**
     * 更换支付方式
     */
    changePaymentMethod() {
        this.showToast("支付方式更换功能");
    },

    /**
     * 联系客服
     */
    contactCustomerService() {
        this.closeModal("transitResultModal");
        const loading = this.showLoading("正在连接客服...");

        setTimeout(() => {
            this.hideLoading(loading);
            this.showToast("已为您转接至客服，请稍候...");
            // 实际项目中可添加跳转客服页面逻辑
        }, 1500);
    },

    /**
     * 立即补缴
     */
    makePayment() {
        this.closeModal("transitResultModal");
        const loading = this.showLoading("正在处理支付...");

        setTimeout(() => {
            this.hideLoading(loading);
            this.showToast("支付成功！");
            // 实际项目中可添加支付成功后的状态更新逻辑
        }, 1500);
    },

    // 9. 通用工具方法
    /**
     * 获取用户Token（从本地存储）
     * @returns {string} 用户Token（空字符串表示获取失败）
     */
    getUserToken() {
        try {
            const userData = JSON.parse(localStorage.getItem("userData") || "{}");
            return userData.token || "";
        } catch (error) {
            console.error("解析用户token失败:", error);
            return "";
        }
    },

    /**
     * 获取用户所在城市（模拟定位）
     * @returns {string} 城市名称
     */
    getUserLocation() {
        // 实际项目中可通过定位API获取
        return "北京";
    },

    /**
     * 获取当前时间（格式：HH:MM）
     * @returns {string} 格式化后的时间字符串
     */
    getCurrentTime() {
        const now = new Date();
        return `${now.getHours()}:${now.getMinutes().toString().padStart(2, "0")}`;
    },

    /**
     * 获取格式化的日期时间（格式：YYYY-MM-DD HH:mm:ss）
     * @param {Date} [date] - 可选日期对象，默认当前时间
     * @returns {string} 格式化后的日期时间字符串
     */
    getFormattedDateTime(date = new Date()) {
        return `${date.getFullYear()}-${
            String(date.getMonth() + 1).padStart(2, "0")
        }-${
            String(date.getDate()).padStart(2, "0")
        } ${
            String(date.getHours()).padStart(2, "0")
        }:${
            String(date.getMinutes()).padStart(2, "0")
        }:${
            String(date.getSeconds()).padStart(2, "0")
        }`;
    },

    /**
     * 关闭模态框
     * @param {string} modalId - 模态框ID
     */
    closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = "none";
    },

    /**
     * 显示加载提示
     * @param {string} message - 加载提示内容
     * @returns {HTMLElement} 加载提示元素
     */
    showLoading(message) {
        // 实际项目中可实现自定义加载组件
        const loading = document.createElement("div");
        loading.className = "loading";
        loading.textContent = message;
        document.body.appendChild(loading);
        return loading;
    },

    /**
     * 隐藏加载提示
     * @param {HTMLElement} loading - 加载提示元素
     */
    hideLoading(loading) {
        if (loading && loading.parentNode) {
            loading.parentNode.removeChild(loading);
        }
    },

    /**
     * 显示提示信息
     * @param {string} message - 提示内容
     * @param {number} duration - 显示时长（毫秒，0表示手动关闭）
     */
    showToast(message, duration = 2000) {
        // 优先使用Android原生提示，否则使用浏览器alert
        if (window.AndroidInterface && typeof window.AndroidInterface.showToast === "function") {
            window.AndroidInterface.showToast(message);
        } else {
            alert(message);
        }
    },

    /**
     * 跳转到出行记录页面
     */
    goToTransitRecords() {
        this.closeModal("transitResultModal");
        // 实际项目中可添加跳转逻辑
        this.showToast("跳转到出行记录页面");
    }
};

// 初始化出行码模块
TransitCodeModule.init();
    </script>
</body>

</html>