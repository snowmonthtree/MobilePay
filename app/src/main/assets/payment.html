<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>确认支付</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .payment-page {
            padding: 20px;
            padding-top: 0;
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }
        
        .page-header {
            display: flex;
            align-items: center;
            padding: 15px 0;
            position: relative;
        }
        
        .back-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
        }
        
        .back-btn img {
            width: 20px;
            height: 20px;
        }
        
        .page-header h1 {
            flex: 1;
            text-align: center;
            font-size: 18px;
            margin: 0;
            font-weight: 600;
        }
        
        .merchant-info {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .merchant-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .merchant-id {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .payment-amount {
            display: flex;
            align-items: baseline;
            margin-top: 20px;
        }
        
        .amount-label {
            font-size: 16px;
            color: #333;
            margin-right: 10px;
        }
        
        .amount-value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }
        
        .payment-methods {
            background: #fff;
            border-radius: 12px;
            padding: 5px 0;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .section-title {
            padding: 15px 20px 10px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .method-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .method-item:last-child {
            border-bottom: none;
        }
        
        .method-item:active {
            background-color: #f9f9f9;
        }
        
        .method-icon {
            width: 28px;
            height: 28px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .method-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .method-details {
            flex: 1;
        }
        
        .method-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        
        .method-description {
            font-size: 13px;
            color: #666;
        }
        
        .method-selected {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .method-selected.active {
            border-color: #667eea;
            background: #667eea;
        }
        
        .method-selected.active::after {
            content: '';
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
        }
        
        .payment-summary {
            background: #fff;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            color: #666;
        }
        
        .summary-item.total {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            border-top: 1px solid #f5f5f5;
            margin-top: 5px;
            padding-top: 12px;
        }
        
        .payment-action {
            margin-top: auto;
            padding: 20px 0;
        }
        
        .pay-button {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pay-button:hover {
            background: #5a6eea;
        }
        
        .pay-button:active {
            background: #4a5eea;
        }
        
        .pay-button img {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            filter: brightness(0) invert(1);
        }
        
        .payment-notice {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-top: 15px;
        }
        
        /* 添加动画效果 */
        @keyframes toastFadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes toastFadeOut {
            from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 状态栏 -->

        <!-- 支付页面 -->
        <div class="payment-page">
            <!-- 页面头部 -->
            <div class="page-header">
                <button class="back-btn" onclick="goBack()">
                    <img src="icons/danjiantouzuo.png" alt="返回">
                </button>
                <h1>确认支付</h1>
                <div class="header-placeholder"></div>
            </div>

            <!-- 商户信息 -->
            <div class="merchant-info">
                <div class="merchant-name" id="merchantName">星巴克咖啡</div>
                <div class="merchant-id">商户ID: 10086753421</div>
                <div class="payment-amount">
                    <span class="amount-label">¥</span>
                    <span class="amount-value" id="paymentAmount">35.80</span>
                </div>
            </div>

            <!-- 支付方式 -->
            <div class="payment-methods">
                <div class="section-title">支付方式</div>
                
                <div class="method-item" onclick="selectPaymentMethod('balance')">
                    <div class="method-icon">
                        <img src="icons/a-28-zhanghuzhongxin.png" alt="钱包余额">
                    </div>
                    <div class="method-details">
                        <div class="method-name">钱包余额</div>
                        <div class="method-description" id="balances">可用余额 ¥1,280.50</div>
                    </div>
                    <div class="method-selected active" id="balanceSelected"></div>
                </div>
                
                <div class="method-item" onclick="selectPaymentMethod('bankcard')">
                    <div class="method-icon">
                        <img src="icons/a-30-zhanghuxinxi.png" alt="银行卡">
                    </div>
                    <div class="method-details">
                        <div class="method-name">招商银行(1234)</div>
                        <div class="method-description">储蓄卡</div>
                    </div>
                    <div class="method-selected" id="bankcardSelected"></div>
                </div>
                
                <div class="method-item" onclick="selectPaymentMethod('wechat')">
                    <div class="method-icon">
                        <img src="icons/weixinbangding.png" alt="微信支付">
                    </div>
                    <div class="method-details">
                        <div class="method-name">微信支付</div>
                        <div class="method-description">微信账号: wei***@qq.com</div>
                    </div>
                    <div class="method-selected" id="wechatSelected"></div>
                </div>
            </div>

            <!-- 支付摘要 -->
            <div class="payment-summary">
                <div class="summary-item">
                    <span>商品金额</span>
                    <span>¥35.80</span>
                </div>
                <div class="summary-item">
                    <span>优惠券</span>
                    <span>-¥0.00</span>
                </div>
                <div class="summary-item total">
                    <span>实付金额</span>
                    <span>¥35.80</span>
                </div>
            </div>

            <!-- 支付按钮 -->
            <div class="payment-action">
                <button class="pay-button" onclick="confirmPayment()">
                    <img src="icons/tijiaofukuan.png" alt="确认支付">
                    <span>确认支付</span>
                </button>
                <div class="payment-notice">
                    支付即表示您同意《支付服务协议》
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedMethod = 'balance';
        
        // 获取URL参数
        function initPage() {
    const params = getUrlParams();

    // 1. 填充商户信息
    document.getElementById('merchantName').textContent = params.merchant || '未知商户';
    document.querySelector('.merchant-id').textContent = `商户ID: ${params.targetId || '未知'}`;

    // 2. 填充金额信息（格式化金额为两位小数）
    const amountEl = document.getElementById('paymentAmount');
    const summaryAmountEls = document.querySelectorAll('.payment-summary .summary-item span:last-child');

    // 处理金额格式化
    const formatAmount = (amount) => {
        return parseFloat(amount || 0).toFixed(2);
    };

    const actualAmount = formatAmount(params.actualAmount);
    const originalAmount = formatAmount(params.amount);
    const discountAmount = formatAmount(params.discount || 0);

    // 填充支付金额
    amountEl.textContent = actualAmount;

    // 填充支付摘要
    if (summaryAmountEls.length >= 3) {
        summaryAmountEls[0].textContent = `¥${originalAmount}`;       // 商品金额
        summaryAmountEls[1].textContent = `-¥${discountAmount}`;      // 优惠券折扣
        summaryAmountEls[2].textContent = `¥${actualAmount}`;         // 实付金额
    }

    // 3. 初始化支付方式选中状态（默认选中余额支付）
    selectPaymentMethod('balance');
}

// 获取URL参数：支持所有传递的参数
function getUrlParams() {
    const params = {};
    const queryString = window.location.search.substring(1);
    const pairs = queryString.split('&');

    for (const pair of pairs) {
        const [key, value] = pair.split('=');
        if (key && value) {
            params[key] = decodeURIComponent(value);
        }
    }

    // 返回所有参数，添加默认值
    return {
        merchant: params.merchant || '未知商户',
        amount: params.amount || '0.00',
        actualAmount: params.actualAmount || params.amount || '0.00',
        discount: params.discount || '0.00',
        targetId: params.targetId || '',
        targetType: params.targetType || '',
        bizCategory: params.bizCategory || '',
        userId: params.userId || ''
    };
}

        // 选择支付方式
        function selectPaymentMethod(method) {
            selectedMethod = method;
            
            // 重置所有选择状态
            document.getElementById('balanceSelected').classList.remove('active');
            document.getElementById('bankcardSelected').classList.remove('active');
            document.getElementById('wechatSelected').classList.remove('active');
            
            // 设置当前选择
            document.getElementById(method + 'Selected').classList.add('active');
        }

        // 确认支付
        function confirmPayment() {
    // 显示支付中状态
    showToast('支付处理中...', 0); // 0表示不自动关闭，直到接口返回结果

    // 获取页面参数和选中的支付方式
    const params = getUrlParams();
    const selectedMethod = window.selectedPaymentMethod || 'balance';

    // 1. 获取用户token
    let token = '';
    try {
        const userDataStr = localStorage.getItem('userData');
        if (userDataStr) {
            const userData = JSON.parse(userDataStr);
            token = userData.token || '';

        }
    } catch (error) {
        console.error('获取token失败:', error);
        showToast('登录状态异常，支付失败', 2000);
        return;
    }

    if (!token) {
        showToast('请先登录', 2000);
        return;
    }

    // 2. 构建支付接口请求参数
    const paymentParams = {
        targetId: params.targetId || '', // 从URL参数获取目标ID
        targetName: params.merchant || '', // 商户名对应targetName
        targetType: params.targetType || '', // 从URL参数获取目标类型
        actualAmount: params.actualAmount || '', // 实付金额
        type: 66, // 接口要求的固定类型值
        bizCategory: params.bizCategory || '' // 从URL参数获取业务分类
    };

    // 3. 调用支付确认接口
    fetch('http://graywolf.top:6031/payment/payment/confirm', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
            'Content-Type': 'application/json',
            'Accept': '*/*'
        },
        body: JSON.stringify(paymentParams)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`支付请求失败: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        // 关闭支付中提示

        // 4. 处理接口返回结果
        const urlParams = new URLSearchParams();
        // 公共参数
        urlParams.append('amount', params.actualAmount || '0.00');
        urlParams.append('merchant', params.merchant || '未知商户');
        urlParams.append('method', getMethodName(selectedMethod));
        urlParams.append('time', new Date().toLocaleString('zh-CN'));

        if (result.code === 200 && result.data) {
            // 支付成功：携带接口返回的交易信息
            urlParams.append('status', 'success');
            urlParams.append('transaction', result.data.transactionId); // 接口返回的交易号
            urlParams.append('balanceAfter', result.data.balanceAfter); // 支付后余额
        } else {
            // 支付失败：携带错误信息
            urlParams.append('status', 'fail');
            urlParams.append('reason', result.message || '支付失败，请重试');
        }

        // 5. 跳转到支付结果页面
        window.location.href = `payment-result.html?${urlParams.toString()}`;
    })
    .catch(error => {
        // 处理接口调用异常
        console.error('支付过程出错:', error);
        // 跳转到失败页面
        const urlParams = new URLSearchParams({
            status: 'fail',
            amount: params.actualAmount || '0.00',
            merchant: params.merchant || '未知商户',
            method: getMethodName(selectedMethod),
            time: new Date().toLocaleString('zh-CN'),
            reason: error.message || '网络异常，支付失败'
        });
        window.location.href = `payment-result.html?${urlParams.toString()}`;
    });
}
        // 获取支付方式名称
        function getMethodName(method) {
            switch(method) {
                case 'balance': return '钱包余额';
                case 'bankcard': return '招商银行(1234)';
                case 'wechat': return '微信支付';
                default: return '钱包余额';
            }
        }

        // 获取失败原因
        function getFailureReason(method) {
            const reasons = {
                'balance': '余额不足，请充值后重试',
                'bankcard': '银行卡交易失败，请联系发卡行',
                'wechat': '微信支付失败，请重试'
            };
            return reasons[method] || '支付失败，请稍后重试';
        }

        // 返回上一页
        function goBack() {
            window.history.back();
        }

        // 显示提示信息
        function showToast(message, duration = 2000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                animation: toastFadeIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastFadeOut 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, duration);
        }
function fetchWalletBalance() {
    // 获取用户token
    let token = '';
    try {
        const userDataStr = localStorage.getItem('userData');
        if (userDataStr) {
            const userData = JSON.parse(userDataStr);
            token = userData.token || '';
                        token = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjUiLCJyb2xlIjoidXNlciIsInRva2VuVHlwZSI6ImFjY2Vzc190b2tlbiIsImV4cCI6MTc1NjE5NjE4NywidXNlcklkIjoxMjUsImlhdCI6MTc1MzYwNDE4N30.ezambcSTE6ZeQvDcpvax02paU7VtmUJrGivVPL_KzdU';
        }
    } catch (error) {
        console.error('获取token失败:', error);
        showBalanceError();
        return;
    }

    if (!token) {
        console.warn('未获取到token，无法查询余额');
        showBalanceError();
        return;
    }

    // 调用余额查询接口
    fetch('http://graywolf.top:6031/payment/user/balance', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
            'Content-Type': 'application/json',
            'Accept': '*/*'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP错误: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        // 验证接口返回格式
        if (result.code !== 200 || !result.data || result.data.balance === undefined) {
            throw new Error(`接口返回异常: ${result.message || '未知错误'}`);
        }

        // 格式化余额（保留两位小数并添加千位分隔符）
        const formatBalance = (balanceStr) => {
            // 将字符串转换为数字并处理
            const balance = parseFloat(balanceStr);
            if (isNaN(balance)) {
                throw new Error('余额格式不正确');
            }
            // 保留两位小数
            const fixedBalance = balance.toFixed(2);
            // 添加千位分隔符
            return fixedBalance
        };

        // 获取余额元素（使用id选择器，更精准）
        const balanceEl = document.getElementById('balances');
        if (!balanceEl) {
            throw new Error('未找到余额显示元素');
        }

        // 格式化并更新显示
        const formattedBalance = formatBalance(result.data.balance);
        balanceEl.textContent = `可用余额 ¥${formattedBalance}`;
        console.log('余额更新成功:', formattedBalance);
    })
    .catch(error => {
        console.error('余额查询失败:', error);
        showBalanceError();
    });
}

// 显示余额错误状态
function showBalanceError() {
    const balanceEl = document.getElementById('balances');
    if (balanceEl) {
        balanceEl.textContent = '可用余额 查询失败';
        // 可添加错误样式
        balanceEl.style.color = '#ff4d4f';
    }
}
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
    initPage();
    // 确保在页面初始化后调用余额查询
    fetchWalletBalance();
});
    </script>
</body>
</html>