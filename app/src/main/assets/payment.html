<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>确认支付</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .payment-page {
            padding: 20px;
            padding-top: 0;
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }
        
        .page-header {
            display: flex;
            align-items: center;
            padding: 15px 0;
            position: relative;
        }
        
        .back-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
        }
        
        .back-btn img {
            width: 20px;
            height: 20px;
        }
        
        .page-header h1 {
            flex: 1;
            text-align: center;
            font-size: 18px;
            margin: 0;
            font-weight: 600;
        }
        
        .merchant-info {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .merchant-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .merchant-id {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .payment-amount {
            display: flex;
            align-items: baseline;
            margin-top: 20px;
        }
        
        .amount-label {
            font-size: 16px;
            color: #333;
            margin-right: 10px;
        }
        
        .amount-value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }
        
        .payment-methods {
            background: #fff;
            border-radius: 12px;
            padding: 5px 0;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .section-title {
            padding: 15px 20px 10px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .method-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .method-item:last-child {
            border-bottom: none;
        }
        
        .method-item:active {
            background-color: #f9f9f9;
        }
        
        .method-icon {
            width: 28px;
            height: 28px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .method-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .method-details {
            flex: 1;
        }
        
        .method-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        
        .method-description {
            font-size: 13px;
            color: #666;
        }
        
        .method-selected {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .method-selected.active {
            border-color: #667eea;
            background: #667eea;
        }
        
        .method-selected.active::after {
            content: '';
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
        }
        
        .payment-summary {
            background: #fff;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            color: #666;
        }
        
        .summary-item.total {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            border-top: 1px solid #f5f5f5;
            margin-top: 5px;
            padding-top: 12px;
        }
        
        .payment-action {
            margin-top: auto;
            padding: 20px 0;
        }
        
        .pay-button {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pay-button:hover {
            background: #5a6eea;
        }
        
        .pay-button:active {
            background: #4a5eea;
        }
        
        .pay-button img {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            filter: brightness(0) invert(1);
        }
        
        .payment-notice {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-top: 15px;
        }
        
        /* 添加动画效果 */
        @keyframes toastFadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes toastFadeOut {
            from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 状态栏 -->

        <!-- 支付页面 -->
        <div class="payment-page">
            <!-- 页面头部 -->
            <div class="page-header">
                <button class="back-btn" onclick="goBack()">
                    <img src="icons/danjiantouzuo.png" alt="返回">
                </button>
                <h1>确认支付</h1>
                <div class="header-placeholder"></div>
            </div>

            <!-- 商户信息 -->
            <div class="merchant-info">
                <div class="merchant-name" id="merchantName">星巴克咖啡</div>
                <div class="merchant-id">商户ID: 10086753421</div>
                <div class="payment-amount">
                    <span class="amount-label">¥</span>
                    <span class="amount-value" id="paymentAmount">35.80</span>
                </div>
            </div>

            <!-- 支付方式 -->
            <div class="payment-methods">
                <div class="section-title">支付方式</div>
                
                <div class="method-item" onclick="selectPaymentMethod('balance')">
                    <div class="method-icon">
                        <img src="icons/a-28-zhanghuzhongxin.png" alt="钱包余额">
                    </div>
                    <div class="method-details">
                        <div class="method-name">余额</div>
                        <div class="method-description" id="balances">可用余额 ¥1,280.50</div>
                    </div>
                    <div class="method-selected active" id="balanceSelected"></div>
                </div>

                <div class="method-item" onclick="selectPaymentMethod('bankcard')" style="display:none">
                    <div class="method-icon">
                        <img src="icons/a-30-zhanghuxinxi.png" alt="银行卡">
                    </div>
                    <div class="method-details">
                        <div class="method-name">招商银行(1234)</div>
                        <div class="method-description">储蓄卡</div>
                    </div>
                    <div class="method-selected" id="bankcardSelected"></div>
                </div>

                <div class="method-item" onclick="selectPaymentMethod('wechat')" style="display:none">
                    <div class="method-icon">
                        <img src="icons/weixinbangding.png" alt="微信支付">
                    </div>
                    <div class="method-details">
                        <div class="method-name">微信支付</div>
                        <div class="method-description">微信账号: wei***@qq.com</div>
                    </div>
                    <div class="method-selected" id="wechatSelected"></div>
                </div>
            </div>

            <!-- 支付摘要 -->
            <div class="payment-summary">
                <div class="summary-item">
                    <span>商品金额</span>
                    <span>¥35.80</span>
                </div>
                <div class="summary-item">
                    <span>优惠券</span>
                    <span>-¥0.00</span>
                </div>
                <div class="summary-item total">
                    <span>实付金额</span>
                    <span>¥35.80</span>
                </div>
            </div>

            <!-- 支付按钮 -->
            <div class="payment-action">
                <button class="pay-button" onclick="confirmPayment()">
                    <img src="icons/tijiaofukuan.png" alt="确认支付">
                    <span>确认支付</span>
                </button>
                <div class="payment-notice">
                    支付即表示您同意《支付服务协议》
                </div>
            </div>
        </div>
    </div>

    <script>
        // 支付模块：统一封装支付相关功能，消除全局变量，集中管理状态与逻辑
const PaymentModule = {
    // 1. 状态管理：存储模块核心配置与状态
    state: {
        apiConfig: {
            baseUrl: "http://graywolf.top:6031/payment",
            paymentConfirmUrl: "/payment/confirm",
            balanceQueryUrl: "/user/balance",
            headers: {
                "User-Agent": "Apifox/1.0.0 (https://apifox.com)",
                "Content-Type": "application/json",
                "Accept": "*/*"
            }
        },
        selectedMethod: "balance", // 当前选中的支付方式（默认余额支付）
        urlParams: {} // 存储URL参数，避免重复解析
    },

    // 2. 初始化：页面加载后执行所有初始化逻辑
    init() {
        document.addEventListener("DOMContentLoaded", () => {
            this.state.urlParams = this.getUrlParams(); // 解析并缓存URL参数
            this.initPage(); // 初始化页面数据（商户、金额等）
            this.fetchWalletBalance(); // 查询钱包余额
        });

        // 暴露全局方法：兼容HTML中的onclick调用
        this.exposeGlobalMethods();
    },

    // 暴露全局方法：确保外部可调用模块内功能
    exposeGlobalMethods() {
        window.selectPaymentMethod = (method) => this.selectPaymentMethod(method);
        window.confirmPayment = () => this.confirmPayment();
        window.goBack = () => this.goBack();
        window.showToast = (msg, duration) => this.showToast(msg, duration);
    },

    // 3. URL参数处理
    /**
     * 解析URL参数并添加默认值
     * @returns {Object} 格式化后的URL参数对象
     */
    getUrlParams() {
        const params = {};
        const queryString = window.location.search.substring(1);
        const pairs = queryString.split("&");

        // 解析URL参数
        pairs.forEach(pair => {
            const [key, value] = pair.split("=");
            if (key && value) {
                params[key] = decodeURIComponent(value);
            }
        });

        // 设置默认值，避免后续使用时出现undefined
        return {
            merchant: params.merchant || "未知商户",
            amount: params.amount || "0.00",
            actualAmount: params.actualAmount || params.amount || "0.00",
            discount: params.discount || "0.00",
            targetId: params.targetId || "",
            targetType: params.targetType || "",
            bizCategory: params.bizCategory || "",
            userId: params.userId || ""
        };
    },

    // 4. 页面初始化（填充商户、金额等数据）
    /**
     * 初始化页面核心数据：商户信息、金额信息、支付方式选中状态
     */
    initPage() {
        const { merchant, targetId, actualAmount, amount, discount } = this.state.urlParams;

        // 1. 填充商户信息
        const merchantNameEl = document.getElementById("merchantName");
        const merchantIdEl = document.querySelector(".merchant-id");
        if (merchantNameEl) merchantNameEl.textContent = merchant;
        if (merchantIdEl) merchantIdEl.textContent = `商户ID: ${targetId || "未知"}`;

        // 2. 格式化金额（统一保留两位小数）
        const formattedActualAmount = this.formatAmount(actualAmount);
        const formattedOriginalAmount = this.formatAmount(amount);
        const formattedDiscount = this.formatAmount(discount);

        // 3. 填充金额信息
        const amountEl = document.getElementById("paymentAmount");
        const summaryAmountEls = document.querySelectorAll(".payment-summary .summary-item span:last-child");
        if (amountEl) amountEl.textContent = formattedActualAmount;

        // 填充支付摘要（商品金额、折扣、实付金额）
        if (summaryAmountEls.length >= 3) {
            summaryAmountEls[0].textContent = `¥${formattedOriginalAmount}`;
            summaryAmountEls[1].textContent = `-¥${formattedDiscount}`;
            summaryAmountEls[2].textContent = `¥${formattedActualAmount}`;
        }

        // 4. 初始化支付方式选中状态
        this.selectPaymentMethod(this.state.selectedMethod);
    },

    // 5. 支付方式选择
    /**
     * 切换选中的支付方式
     * @param {string} method - 支付方式（balance/bankcard/wechat）
     */
    selectPaymentMethod(method) {
        // 验证支付方式合法性
        const validMethods = ["balance", "bankcard", "wechat"];
        if (!validMethods.includes(method)) {
            console.warn(`不支持的支付方式: ${method}，默认使用余额支付`);
            method = "balance";
        }

        // 更新选中状态（先重置所有，再激活当前）
        validMethods.forEach(m => {
            const el = document.getElementById(`${m}Selected`);
            if (el) el.classList.remove("active");
        });
        const currentEl = document.getElementById(`${method}Selected`);
        if (currentEl) currentEl.classList.add("active");

        // 保存当前选中的支付方式
        this.state.selectedMethod = method;
    },

    // 6. 支付确认（核心功能）
    /**
     * 确认支付：验证登录状态、构建请求参数、调用接口、跳转结果页
     */
    confirmPayment() {
        const toast = this.showToast("支付处理中...", 0); // 显示不自动关闭的加载提示

        try {
            // 1. 获取并验证用户Token
            const token = this.getAuthToken();
            if (!token) {
                this.showToast("请先登录", 2000);
                toast.remove(); // 关闭加载提示
                return;
            }

            // 2. 构建支付请求参数
            const paymentParams = this.buildPaymentParams();

            // 3. 调用支付接口
            this.callPaymentApi(token, paymentParams, toast);

        } catch (error) {
            console.error("支付初始化失败:", error);
            this.showToast(error.message || "支付异常，请重试", 2000);
            toast.remove(); // 关闭加载提示
        }
    },

    /**
     * 获取用户Token（统一封装，便于错误处理）
     * @returns {string} 用户Token或空字符串
     * @throws {Error} Token获取失败时抛出异常
     */
    getAuthToken() {
        try {
            const userDataStr = localStorage.getItem("userData");
            if (!userDataStr) throw new Error("未找到用户登录数据");

            const userData = JSON.parse(userDataStr);
            const token = userData.token || "";
            if (!token) throw new Error("登录状态异常");

            return token;
        } catch (error) {
            console.error("获取Token失败:", error);
            throw new Error("登录状态异常，支付失败");
        }
    },

    /**
     * 构建支付接口请求参数
     * @returns {Object} 格式化后的支付请求参数
     */
    buildPaymentParams() {
        const { targetId, merchant, targetType, actualAmount, bizCategory } = this.state.urlParams;

        return {
            targetId: targetId,
            targetName: merchant,
            targetType: targetType,
            actualAmount: actualAmount,
            type: 66, // 接口要求的固定类型值
            bizCategory: bizCategory
        };
    },

    /**
     * 调用支付确认接口
     * @param {string} token - 用户Token
     * @param {Object} params - 支付请求参数
     * @param {HTMLElement} toast - 加载提示元素（用于后续关闭）
     */
    callPaymentApi(token, params, toast) {
        fetch(`${this.state.apiConfig.baseUrl}${this.state.apiConfig.paymentConfirmUrl}`, {
            method: "POST",
            headers: {
                ...this.state.apiConfig.headers,
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify(params)
        })
            .then(response => {
                if (!response.ok) throw new Error(`支付请求失败 (${response.status})`);
                return response.json();
            })
            .then(result => {
                toast.remove(); // 关闭加载提示
                this.handlePaymentResult(result); // 处理支付结果
            })
            .catch(error => {
                toast.remove(); // 关闭加载提示
                console.error("支付接口调用失败:", error);
                // 跳转到支付失败页
                this.redirectToResultPage("fail", error.message || "网络异常，支付失败");
            });
    },

    /**
     * 处理支付接口返回结果
     * @param {Object} result - 接口返回的支付结果
     */
    handlePaymentResult(result) {
        const { actualAmount, merchant } = this.state.urlParams;
        const paymentMethodName = this.getMethodName(this.state.selectedMethod);

        if (result.code === 200 && result.data) {
            // 支付成功：携带交易号、余额等信息
            this.redirectToResultPage("success", "支付成功", {
                transactionId: result.data.transactionId,
                balanceAfter: result.data.balanceAfter
            });
        } else {
            // 支付失败：携带错误信息
            const errorMsg = result.message || "支付失败，请重试";
            this.redirectToResultPage("fail", errorMsg);
        }
    },

    /**
     * 跳转到支付结果页
     * @param {string} status - 支付状态（success/fail）
     * @param {string} reason - 结果描述（成功提示/失败原因）
     * @param {Object} extraData - 额外参数（交易号、余额等）
     */
    redirectToResultPage(status, reason, extraData = {}) {
        const { actualAmount, merchant } = this.state.urlParams;
        const paymentMethodName = this.getMethodName(this.state.selectedMethod);
        const currentTime = new Date().toLocaleString("zh-CN");

        // 构建结果页参数
        const urlParams = new URLSearchParams({
            status: status,
            amount: actualAmount,
            merchant: merchant,
            method: paymentMethodName,
            time: currentTime,
            reason: reason,
            ...extraData // 合并额外参数（交易号、余额等）
        });

        // 跳转到结果页
        window.location.href = `payment-result.html?${urlParams.toString()}`;
    },

    // 7. 钱包余额查询
    /**
     * 查询用户钱包余额并更新页面显示
     */
    fetchWalletBalance() {
        try {
            const token = this.getAuthToken();
            if (!token) {
                this.showBalanceError();
                return;
            }

            // 调用余额查询接口
            fetch(`${this.state.apiConfig.baseUrl}${this.state.apiConfig.balanceQueryUrl}`, {
                method: "GET",
                headers: {
                    ...this.state.apiConfig.headers,
                    "Authorization": `Bearer ${token}`
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error(`余额查询失败 (${response.status})`);
                    return response.json();
                })
                .then(result => {
                    this.handleBalanceResult(result);
                })
                .catch(error => {
                    console.error("余额查询接口调用失败:", error);
                    this.showBalanceError();
                });

        } catch (error) {
            console.error("余额查询初始化失败:", error);
            this.showBalanceError();
        }
    },

    /**
     * 处理余额查询结果
     * @param {Object} result - 接口返回的余额数据
     */
    handleBalanceResult(result) {
        const balanceEl = document.getElementById("balances");
        if (!balanceEl) return;

        // 验证接口返回格式
        if (result.code !== 200 || !result.data || result.data.balance === undefined) {
            throw new Error(`余额数据异常: ${result.message || "未知错误"}`);
        }

        // 格式化余额（保留两位小数，添加千位分隔符）
        const formattedBalance = this.formatAmount(result.data.balance, true);
        balanceEl.textContent = `可用余额 ¥${formattedBalance}`;
        balanceEl.style.color = ""; // 清除错误状态颜色
    },

    /**
     * 显示余额查询错误状态
     */
    showBalanceError() {
        const balanceEl = document.getElementById("balances");
        if (balanceEl) {
            balanceEl.textContent = "可用余额 查询失败";
            balanceEl.style.color = "#ff4d4f"; // 错误状态颜色
        }
    },

    // 8. 工具方法
    /**
     * 格式化金额（保留两位小数，可选添加千位分隔符）
     * @param {string|number} amount - 待格式化的金额
     * @param {boolean} needThousandSep - 是否需要千位分隔符
     * @returns {string} 格式化后的金额字符串
     */
    formatAmount(amount, needThousandSep = false) {
        try {
            const num = parseFloat(amount);
            if (isNaN(num)) return "0.00";

            // 保留两位小数
            const fixedAmount = num.toFixed(2);

            // 如需千位分隔符，进一步处理
            if (needThousandSep) {
                return fixedAmount.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            return fixedAmount;
        } catch (error) {
            console.error("金额格式化失败:", error);
            return "0.00";
        }
    },

    /**
     * 根据支付方式标识获取中文名称
     * @param {string} method - 支付方式标识（balance/bankcard/wechat）
     * @returns {string} 支付方式中文名称
     */
    getMethodName(method) {
        const methodMap = {
            balance: "钱包余额",
            bankcard: "招商银行(1234)",
            wechat: "微信支付"
        };
        return methodMap[method] || "钱包余额";
    },

    /**
     * 显示提示信息（Toast）
     * @param {string} message - 提示内容
     * @param {number} duration - 显示时长（毫秒，0表示不自动关闭）
     * @returns {HTMLElement} Toast元素（便于后续手动关闭）
     */
    showToast(message, duration = 2000) {
        // 移除现有Toast，避免叠加
        const existingToast = document.querySelector(".toast");
        if (existingToast) existingToast.remove();

        // 创建新Toast
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            animation: toastFadeIn 0.3s ease;
        `;

        document.body.appendChild(toast);

        // 自动关闭（duration为0时不自动关闭）
        if (duration > 0) {
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    toast.style.animation = "toastFadeOut 0.3s ease";
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }

        return toast;
    },

    /**
     * 返回上一页
     */
    goBack() {
        window.history.back();
    }
};

// 初始化支付模块
PaymentModule.init();
    </script>
</body>
</html>