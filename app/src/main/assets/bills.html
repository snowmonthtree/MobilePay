<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>账单中心 - 移动支付应用</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 模态框整体样式 */

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        /* 账单分类标签样式 */
        .bill-category {
            display: inline-block;
            padding: 2px 8px;
            background-color: #f0f2f5;
            color: #666;
            border-radius: 10px;
            font-size: 12px;
            margin-top: 4px;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 100%;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* 模态框头部样式 */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f2f5;
            background-color: #f9fafc;
        }

        .modal-header h3 {
            color: #1d2129;
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* 模态框主体样式 */
        .modal-body {
            max-height: 70vh;
            /* 设置最大高度，防止内容溢出 */
            overflow-y: auto;
            /* 允许内容溢出时显示滚动条 */
        }

        /* 支出分类选择器样式 */
        .category-selector {
            width: 100%;
        }

        .category-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            color: #333;
            background-color: #fff;
            appearance: none;
            background-image: url('icons/danjiantouxia.png');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px;
        }

        /* 模态框底部样式 */
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            padding: 15px 20px;
            border-top: 1px solid #f0f2f5;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .modal-body {
                padding: 20px;
            }

            .year-title h2 {
                font-size: 2rem;
            }

            .annual-stats {
                flex-direction: column;
            }

            .stat-card {
                flex: 1 1 auto;
            }

            .category-list {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .modal-header {
                padding: 15px 20px;
            }

            .modal-header h3 {
                font-size: 1.25rem;
            }

            .modal-body {
                padding: 15px;
            }

            .year-title h2 {
                font-size: 1.75rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .monthly-trend h4,
            .category-analysis h4,
            .annual-insights h4,
            .annual-goals h4 {
                font-size: 1.1rem;
            }
        }

        .action-btn {
            display: flex;
            align-items: center;
            flex-direction: row;
            gap: 8px;
            width: 100%;
            padding: 12px;
            background: #fff2e8;
            border: 1px solid #ffd591;
            border-radius: 8px;
            color: #fa8c16;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #ffe7ba;
        }

        .action-btn img {
            width: 16px;
            height: 16px;
        }

        .btn-secondary {
            background-color: #f0f2f5;
            color: #1d2129;
            margin-right: 15px;
        }

        .btn-secondary:hover {
            background-color: #e5e6eb;
        }

        .search-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #f8f9fa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #e9ecef;
            transform: scale(1.05);
        }

        .search-btn img {
            width: 20px;
            height: 20px;
        }

        /* 年度账单页面样式 */
        #annualBillPage {
            padding: 0 15px;
            margin-bottom: 50px;
            overflow-y: auto;
            height: calc(100% - 120px);
        }

        .annual-summary {
            padding: 15px 0;
        }

        .year-title {
            text-align: center;
            margin-bottom: 20px;
        }

        .year-title h2 {
            font-size: 2.5rem;
            color: #1890ff;
            margin-bottom: 5px;
        }

        .year-title p {
            color: #666;
            font-size: 1rem;
        }

        .annual-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-card {
            flex: 1 1 30%;
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .stat-card.primary {
            border-left: 4px solid #ff6b6b;
        }

        .stat-card.success {
            border-left: 4px solid #4ecdc4;
        }

        .stat-card.info {
            border-left: 4px solid #45b7d1;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }

        .stat-icon img {
            width: 24px;
            height: 24px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1d2129;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .monthly-trend,
        .category-analysis,
        .annual-insights,
        .annual-goals {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .monthly-trend h4,
        .category-analysis h4,
        .annual-insights h4,
        .annual-goals h4 {
            font-size: 1.2rem;
            color: #1d2129;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .trend-chart {
            width: 100%;
            height: 180px;
            margin-top: 10px;
        }

        .category-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .category-item {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: #f9fafc;
            border-radius: 8px;
        }

        .category-info {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .category-info img {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }

        .category-name {
            font-size: 0.9rem;
            color: #1d2129;
        }

        .category-amount {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1d2129;
            margin-bottom: 4px;
        }

        .category-percent {
            font-size: 0.85rem;
            color: #666;
        }

        .insight-list,
        .goal-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            background: #f9fafc;
            padding: 12px;
            border-radius: 8px;
        }

        .insight-icon {
            font-size: 1.5rem;
            margin-right: 12px;
            line-height: 1;
        }

        .insight-text {
            flex: 1;
        }

        .insight-title {
            font-weight: 600;
            color: #1d2129;
            margin-bottom: 4px;
        }

        .insight-desc {
            font-size: 0.9rem;
            color: #666;
        }

        .goal-item {
            display: flex;
            align-items: center;
            background: #f0f7ff;
            padding: 12px;
            border-radius: 8px;
        }

        .goal-icon {
            font-size: 1.5rem;
            margin-right: 12px;
        }

        .goal-text {
            font-size: 0.95rem;
            color: #1d2129;
        }

        .action-buttons {
            padding: 0 15px 20px;
        }
    </style>
</head>

<body>
<div class="app-container">
    <!-- 顶部状态栏 -->

    <!-- 账单中心页面 -->
    <div class="bills-page" id="billsPage" style="display: block;">
        <!-- 头部 -->
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">
                <img src="icons/danjiantouzuo.png" alt="返回">
            </button>
            <h1>账单中心</h1>
            <button class="search-btn" onclick="goToSearch()">
                <img src="icons/sousuo.png" alt="搜索">
            </button>
        </div>

        <!-- 月份切换 -->
        <div class="month-selector">
            <button class="month-nav" onclick="changeMonth(-1)">
                <img src="icons/danjiantouzuo.png" alt="上月">
            </button>
            <div class="current-month" style="position: relative;">
                <div style="position: relative;z-index: 1;">
                    <span id="currentMonth">2024年10月</span>
                    <img src="icons/danjiantouxia.png" alt="选择">
                </div>
                <!-- 透明覆盖的select（视觉不可见，但可点击） -->
                <select id="hiddenMonthSelector" onchange="handleMonthSelect(this)"
                        style=" position: absolute;top: 0;left: 0;width: 100%;height: 100%;opacity: 0;z-index: 2;border: none;background: none;">
                    <!-- 选项通过JS生成 -->
                </select>
            </div>
            <button class="month-nav" onclick="changeMonth(1)">
                <img src="icons/danjiantouyou.png" alt="下月">
            </button>
        </div>

        <!-- 账单总览 -->
        <div class="bill-summary">
            <div class="summary-card">
                <div class="summary-item">
                    <span class="label">总收入</span>
                    <span class="amount income">¥8,000.00</span>
                </div>
                <div class="summary-item">
                    <span class="label">总支出</span>
                    <span class="amount expense">¥2,456.78</span>
                </div>
                <div class="summary-item">
                    <span class="label">结余</span>
                    <span class="amount balance">¥5,543.22</span>
                </div>
            </div>

            <div class="chart-section">
                <h3>支出分类</h3>
                <div class="expense-chart">
                    <div class="chart-item">
                        <div class="chart-color" style="background: #ff6b6b;"></div>
                        <span class="chart-label">餐饮</span>
                        <span class="chart-amount">¥982.34</span>
                        <span class="chart-percent">40%</span>
                    </div>
                    <div class="chart-item">
                        <div class="chart-color" style="background: #4ecdc4;"></div>
                        <span class="chart-label">出行</span>
                        <span class="chart-amount">¥614.20</span>
                        <span class="chart-percent">25%</span>
                    </div>
                    <div class="chart-item">
                        <div class="chart-color" style="background: #45b7d1;"></div>
                        <span class="chart-label">购物</span>
                        <span class="chart-amount">¥491.36</span>
                        <span class="chart-percent">20%</span>
                    </div>
                    <div class="chart-item">
                        <div class="chart-color" style="background: #f9ca24;"></div>
                        <span class="chart-label">其他</span>
                        <span class="chart-amount">¥368.88</span>
                        <span class="chart-percent">15%</span>
                    </div>
                </div>

                <button class="year-bill-btn" onclick="showAnnualBillPage()">
                    <img src="icons/rili.png" alt="年度账单">
                    <span>查看年度账单</span>
                </button>
            </div>
        </div>

        <!-- 筛选器 -->
        <div class="filter-section">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterBills('all')">全部</button>
                <button class="filter-tab" onclick="filterBills('income')">收入</button>
                <button class="filter-tab" onclick="filterBills('expense')">支出</button>
            </div>
            <button class="date-filter-btn" onclick="showDateFilter()">
                <img src="icons/rili.png" alt="日期筛选">
                <span>日期筛选</span>
            </button>
        </div>

        <!-- 账单列表 -->
        <div class="bills-list" id="billsList">
            <!-- 今天 -->
            <div class="date-group">
                <div class="date-header">今天</div>

                <div class="bill-item expense" data-type="expense" data-category="餐饮"
                     onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/canyin.png" alt="餐饮">
                    </div>
                    <div class="bill-info">
                        <h4>星巴克咖啡</h4>
                        <p>支付宝支付 • 2025-7-29 15:30</p>
                        <span class="bill-category">餐饮</span>
                    </div>
                    <div class="bill-amount expense">-¥32.00</div>
                </div>

                <div class="bill-item expense" data-type="expense" data-category="出行"
                     onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/zhiyin.png" alt="出行">
                    </div>
                    <div class="bill-info">
                        <h4>地铁出行</h4>
                        <p>出行码支付 • 2025-7-29 08:45</p>
                        <span class="bill-category">出行</span>
                    </div>
                    <div class="bill-amount expense">-¥6.00</div>
                </div>
            </div>

            <!-- 昨天 -->
            <div class="date-group">
                <div class="date-header">昨天</div>

                <div class="bill-item income" data-type="income" data-category="其他" onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/shoukuanjiekou.png" alt="收款">
                    </div>
                    <div class="bill-info">
                        <h4>朋友转账</h4>
                        <p>收款码收款 • 2025-7-28 19:20</p>
                        <span class="bill-category">其他</span>
                    </div>
                    <div class="bill-amount income">+¥200.00</div>
                </div>

                <div class="bill-item expense" data-type="expense" data-category="餐饮"
                     onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/canyin.png" alt="支付">
                    </div>
                    <div class="bill-info">
                        <h4>美团外卖</h4>
                        <p>银行卡支付 • 2025-7-28 12:15</p>
                        <span class="bill-category">餐饮</span>
                    </div>
                    <div class="bill-amount expense">-¥45.80</div>
                </div>
            </div>

            <!-- 更早之前 -->
            <div class="date-group">
                <div class="date-header">更早之前</div>

                <div class="bill-item expense" data-type="expense" data-category="购物"
                     onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/gouwu.png" alt="支付">
                    </div>
                    <div class="bill-info">
                        <h4>超市购物</h4>
                        <p>扫码支付 • 2024-10-20 10:25</p>
                        <span class="bill-category">购物</span>
                    </div>
                    <div class="bill-amount expense">-¥128.50</div>
                </div>

                <div class="bill-item expense" data-type="expense" data-category="购物"
                     onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/gouwu.png" alt="支付">
                    </div>
                    <div class="bill-info">
                        <h4>便利店</h4>
                        <p>银行卡支付 • 2024-10-19 08:15</p>
                        <span class="bill-category">购物</span>
                    </div>
                    <div class="bill-amount expense">-¥35.50</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 年度账单页面 -->
    <div class="bills-page" id="annualBillPage" style="display: none;">
        <!-- 头部 -->
        <div class="page-header">
            <button class="back-btn" onclick="showBillsPage()">
                <img src="icons/danjiantouzuo.png" alt="返回">
            </button>
            <h1>2025年度账单</h1>
            <div style="width: 40px;"></div> <!-- 占位元素，保持头部对称 -->
        </div>

        <div class="annual-summary">
            <div class="year-title">
                <h2>2025</h2>
                <p>您的数字生活足迹</p>
            </div>

            <div class="annual-stats">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <img src="icons/feiyongchaxun.png" alt="总支出">
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">¥45,680.50</div>
                        <div class="stat-label">全年总支出</div>
                    </div>
                </div>

                <div class="stat-card success">
                    <div class="stat-icon">
                        <img src="icons/shuangjiantoushang.png" alt="总收入">
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">¥52,300.00</div>
                        <div class="stat-label">全年总收入</div>
                    </div>
                </div>

                <div class="stat-card info">
                    <div class="stat-icon">
                        <img src="icons/a-27-lishishuju.png" alt="交易次数">
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">1,248</div>
                        <div class="stat-label">交易笔数</div>
                    </div>
                </div>
            </div>

            <div class="monthly-trend">
                <h4>月度支出趋势</h4>
                <div class="trend-chart">
                    <canvas id="annualTrendChart" width="300" height="150"></canvas>
                </div>
            </div>

            <div class="category-analysis">
                <h4>支出分类统计</h4>
                <div class="category-list">
                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/canyin.png" alt="餐饮">
                            <span class="category-name">餐饮美食</span>
                        </div>
                        <div class="category-amount">¥12,580.50</div>
                        <div class="category-percent">27.5%</div>
                    </div>

                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/gouwu.png" alt="购物">
                            <span class="category-name">购物消费</span>
                        </div>
                        <div class="category-amount">¥9,240.80</div>
                        <div class="category-percent">20.2%</div>
                    </div>

                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/zhiyin.png" alt="交通">
                            <span class="category-name">交通出行</span>
                        </div>
                        <div class="category-amount">¥6,890.20</div>
                        <div class="category-percent">15.1%</div>
                    </div>

                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/xiuxianyule.png" alt="娱乐">
                            <span class="category-name">娱乐休闲</span>
                        </div>
                        <div class="category-amount">¥5,420.30</div>
                        <div class="category-percent">11.9%</div>
                    </div>

                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/shenghuofuwu.png" alt="生活">
                            <span class="category-name">生活服务</span>
                        </div>
                        <div class="category-amount">¥4,680.90</div>
                        <div class="category-percent">10.2%</div>
                    </div>

                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/shoukuanjiekou.png" alt="其他">
                            <span class="category-name">其他</span>
                        </div>
                        <div class="category-amount">¥6,867.80</div>
                        <div class="category-percent">15.1%</div>
                    </div>
                </div>
            </div>

            <div class="annual-insights">
                <h4>年度洞察</h4>
                <div class="insight-list">
                    <div class="insight-item">
                        <div class="insight-icon">📊</div>
                        <div class="insight-text">
                            <div class="insight-title">消费习惯</div>
                            <div class="insight-desc">您最爱在周末消费，餐饮是最大支出项</div>
                        </div>
                    </div>

                    <div class="insight-item">
                        <div class="insight-icon">💰</div>
                        <div class="insight-text">
                            <div class="insight-title">理财成果</div>
                            <div class="insight-desc">全年结余¥6,619.50，理财意识不错</div>
                        </div>
                    </div>

                    <div class="insight-item">
                        <div class="insight-icon">📈</div>
                        <div class="insight-text">
                            <div class="insight-title">消费趋势</div>
                            <div class="insight-desc">下半年支出增长15%，建议合理规划</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="annual-goals">
                <h4>新年目标</h4>
                <div class="goal-list">
                    <div class="goal-item">
                        <div class="goal-icon">🎯</div>
                        <div class="goal-text">控制餐饮支出，目标减少20%</div>
                    </div>
                    <div class="goal-item">
                        <div class="goal-icon">💎</div>
                        <div class="goal-text">增加理财投资，目标收益8%</div>
                    </div>
                    <div class="goal-item">
                        <div class="goal-icon">📱</div>
                        <div class="goal-text">使用数字支付，享受更多优惠</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons" style="display: flex; justify-content: space-between; margin: 20px 0;">
                <button class="btn-secondary" onclick="shareAnnualBill()">分享账单</button>
                <button class="btn-primary" onclick="downloadAnnualBill()">下载报告</button>
            </div>
        </div>
    </div>

    <!-- 日期筛选弹窗 (底部弹出) -->
    <div class="modal bottom-modal" id="dateFilterModal">
        <div class="modal-content bottom-modal-content">
            <div class="modal-header">
                <h3>选择日期范围</h3>
                <button class="close-btn" onclick="closeModal('dateFilterModal')">
                    <img src="icons/shibai.png" alt="关闭">
                </button>
            </div>
            <div class="modal-body">
                <div class="date-range">
                    <div class="date-input-group">
                        <label>开始日期</label>
                        <input type="date" id="startDate" value="2025-07-01" class="mobile-date-input">
                    </div>
                    <div class="date-input-group">
                        <label>结束日期</label>
                        <input type="date" id="endDate" value="2025-07-31" class="mobile-date-input">
                    </div>
                </div>
                <div class="quick-date-options">
                    <button class="quick-date-btn" onclick="setQuickDate(7)">最近7天</button>
                    <button class="quick-date-btn" onclick="setQuickDate(30)">最近30天</button>
                    <button class="quick-date-btn" onclick="setQuickDate(90)">最近3个月</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeModal('dateFilterModal')">取消</button>
                <button class="confirm-btn" onclick="applyDateFilter()">确定</button>
            </div>
        </div>
    </div>

    <!-- 年度账单已移至页面形式显示 -->

    <!-- 底部导航 -->


</div>

<script src="script.js"></script>
<script>
    // 账单中心模块：统一封装，避免全局变量污染
const BillCenterModule = {
    // 1. 状态管理：集中管理全局状态，避免散定义
    state: {
        currentMonthIndex: 7,    // 当前月份索引（1-12）
        currentYear: 2025,       // 当前年份
        yearRange: {             // 年份选择范围
            start: 2025 - 5,
            end: 2025 + 1
        }
    },

    // 2. 初始化：页面加载后执行所有初始化逻辑
    init() {
        // 绑定DOM加载完成事件
        document.addEventListener('DOMContentLoaded', () => {
            this.initDomRelated();  // DOM相关初始化
            this.initBillData();    // 账单数据初始化
        });

        // 暴露全局方法：确保原有HTML onclick可调用
        this.exposeGlobalMethods();
    },

    // DOM相关初始化（选择器、事件绑定等）
    initDomRelated() {
        this.state.hiddenMonthSelector = document.getElementById('hiddenMonthSelector');
        this.initHiddenSelector();  // 初始化月份选择器
    },

    // 账单数据初始化（列表、总览等）
    initBillData() {
        initBillsList();        // 初始化账单列表
        updateMonthDisplay();   // 更新月份显示（触发账单总览加载）
    },

    // 暴露全局方法：兼容原有HTML中的onclick调用
    exposeGlobalMethods() {
        window.changeMonth = (direction) => this.changeMonth(direction);
        window.handleMonthSelect = (selector) => this.handleMonthSelect(selector);
        window.filterBills = (type) => this.filterBills(type);
        window.goToSearch = () => this.goToSearch();
        window.showDateFilter = () => this.showDateFilter();
        window.showAnnualBillPage = () => this.showAnnualBillPage();
        window.showBillsPage = () => this.showBillsPage();
        window.shareAnnualBill = () => this.shareAnnualBill();
        window.downloadAnnualBill = () => this.downloadAnnualBill();
        window.viewBillDetail = (billItem) => this.viewBillDetail(billItem);
        window.performSearch = () => this.performSearch();
        window.handleSearchKeyPress = (event) => this.handleSearchKeyPress(event);
        window.setQuickDate = (days) => this.setQuickDate(days);
        window.applyDateFilter = () => this.applyDateFilter();
        window.reportProblem = () => this.reportProblem();
        window.closeModal = (modalId) => this.closeModal(modalId);
        window.goBack = () => this.goBack();
        window.goToPage = (page) => this.goToPage(page);
    },

    // 3. 月份切换逻辑
    changeMonth(direction) {
        this.state.currentMonthIndex += direction;
        // 月份越界处理（12月→1月/1月→12月）
        if (this.state.currentMonthIndex > 12) {
            this.state.currentMonthIndex = 1;
            this.state.currentYear++;
        } else if (this.state.currentMonthIndex < 1) {
            this.state.currentMonthIndex = 12;
            this.state.currentYear--;
        }
        // 更新月份显示与账单数据
        updateMonthDisplay();
    },

    // 初始化隐藏的月份选择器
    initHiddenSelector() {
        const selector = this.state.hiddenMonthSelector;
        if (!selector) return;

        // 清空现有选项
        selector.innerHTML = '';

        // 生成年份-月份选项（格式：YYYY年MM月）
        for (let year = this.state.yearRange.start; year <= this.state.yearRange.end; year++) {
            for (let month = 1; month <= 12; month++) {
                const option = document.createElement('option');
                const monthText = String(month).padStart(2, '0'); // 月份补零（01-12）
                option.value = `${year}-${monthText}`; // 存储值：YYYY-MM
                option.textContent = `${year}年${monthText}月`; // 显示文本

                // 设置当前年月为默认选中
                if (year === this.state.currentYear && month === this.state.currentMonthIndex) {
                    option.selected = true;
                }

                selector.appendChild(option);
            }
        }
    },

    // 处理月份选择器变更（同步状态与显示）
    handleMonthSelect(selector) {
        const selectedValue = selector.value;
        if (!selectedValue) return;

        // 解析选中的年月（YYYY-MM → 年/月）
        const [year, month] = selectedValue.split('-').map(Number);
        this.state.currentYear = year;
        this.state.currentMonthIndex = month;

        // 更新显示与账单数据
        updateMonthDisplay();
    },

    // 4. 账单筛选逻辑
    filterBills(type) {
        // 修复原代码event未定义问题：通过事件对象获取目标
        const event = window.event;
        if (!event) return;

        // 切换筛选标签激活状态
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');

        // 筛选账单条目显示/隐藏
        document.querySelectorAll('.bill-item').forEach(item => {
            if (type === 'all' || item.dataset.type === type) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    },

    // 5. 页面跳转逻辑
    goToSearch() {
        window.location.href = 'bill_search.html';
    },

    showDateFilter() {
        const modal = document.getElementById('dateFilterModal');
        if (modal) modal.style.display = 'flex';
    },

    showAnnualBillPage() {
        // 切换页面显示状态
        document.getElementById('billsPage').style.display = 'none';
        const annualPage = document.getElementById('annualBillPage');
        if (annualPage) {
            annualPage.style.display = 'block';
            initAnnualBill(); // 初始化年度账单数据
            // 延迟绘制图表，确保页面已渲染
            setTimeout(drawAnnualTrendChart, 100);
        }

        // 更新历史记录
        history.pushState({ page: 'annual' }, '年度账单', 'bills.html#annual');
    },

    showBillsPage() {
        // 切换页面显示状态
        document.getElementById('annualBillPage').style.display = 'none';
        const billsPage = document.getElementById('billsPage');
        if (billsPage) billsPage.style.display = 'block';

        // 更新历史记录
        history.replaceState({ page: 'bills' }, '账单中心', 'bills.html');
    },

    goBack() {
        window.history.back();
    },

    goToPage(page) {
        window.location.href = page;
    },

    // 6. 年度账单功能
    shareAnnualBill() {
        alert('分享年度账单功能');
    },

    downloadAnnualBill() {
        alert('下载年度账单报告功能');
    },

    // 7. 账单详情查看
    async viewBillDetail(billItem) {
        // 1. 校验账单ID是否存在
        const billId = billItem?.dataset.billId;
        if (!billId) {
            showToast('未获取到账单ID');
            return;
        }

        // 2. 显示加载提示
        showToast('加载账单详情中...');

        // 3. 获取用户Token（统一封装，避免重复代码）
        const token = this.getAuthToken();
        if (!token) return;

        try {
            // 4. 调用账单详情接口
            const response = await fetch(
                `http://graywolf.top:6031/appassets/assets/bills/detail?id=${billId}`,
                {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
                        'Accept': '*/*'
                    }
                }
            );

            // 处理HTTP错误
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || '获取账单详情失败');
            }

            const result = await response.json();
            if (result.code === 200 && result.data) {
                const bill = result.data;
                // 5. 格式化详情数据（适配详情页字段）
                const detailData = {
                    id: bill.id,
                    merchant: bill.targetName || '未知账户',
                    amount: `${bill.type === 1 ? '+' : '-'}¥${bill.amount}`,
                    type: bill.typeName || '未知类型',
                    category: bill.bizCategoryName || '其他',
                    payment: `${bill.targetTypeName || '未知方式'} ${bill.type === 1 ? '收款' : '支付'}`,
                    time: formatBillTime(bill.completeTime),
                    orderNo: bill.transferNumber || '无交易单号',
                    note: bill.remark || '无备注信息'
                };

                // 6. 保存数据到sessionStorage
                sessionStorage.setItem('currentBillData', JSON.stringify(detailData));

                // 7. 跳转到详情页
                window.location.href = 'bill_detail.html';
            } else {
                throw new Error(result.message || '获取详情数据失败');
            }
        } catch (error) {
            console.error('账单详情加载失败:', error);
            showToast(error.message || '网络异常，详情加载失败');
        }
    },

    // 8. 搜索相关功能
    performSearch() {
        const searchInput = document.getElementById('searchInput');
        if (!searchInput) return;

        const keyword = searchInput.value.trim();
        if (!keyword) return;

        // 模拟搜索结果（保留原有DOM结构与样式）
        const searchResults = document.getElementById('searchResults');
        if (searchResults) {
            searchResults.innerHTML = `
                <div class="bill-item expense" data-type="expense" data-category="餐饮" onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/a-2-lijifukuan.png" alt="支付">
                    </div>
                    <div class="bill-info">
                        <h4>星巴克咖啡</h4>
                        <p>支付宝支付 • 2024-10-22 15:30</p>
                        <span class="bill-category">餐饮</span>
                    </div>
                    <div class="bill-amount expense">-¥32.00</div>
                </div>
                <div class="no-more-results">没有更多结果了</div>
            `;
        }
    },

    handleSearchKeyPress(event) {
        if (event.key === 'Enter') {
            this.performSearch();
        }
    },

    // 9. 日期筛选功能
    setQuickDate(days) {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - days);

        // 格式化日期为YYYY-MM-DD
        const formatDate = (date) => date.toISOString().split('T')[0];
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        if (startDateInput) startDateInput.value = formatDate(startDate);
        if (endDateInput) endDateInput.value = formatDate(endDate);
    },

    applyDateFilter() {
        // 1. 获取日期输入
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        if (!startDateInput || !endDateInput) return;

        const startDate = startDateInput.value;
        const endDate = endDateInput.value;

        // 2. 验证日期完整性
        if (!startDate || !endDate) {
            showToast('请选择完整的日期范围');
            return;
        }

        // 3. 格式化日期参数（拼接时间）
        const startTime = `${startDate} 00:00:00`;
        const endTime = `${endDate} 23:59:59`;

        // 4. 获取用户Token
        const token = this.getAuthToken();
        if (!token) return;

        // 5. 构建请求URL（编码特殊字符）
        const encodedStartTime = encodeURIComponent(startTime);
        const encodedEndTime = encodeURIComponent(endTime);
        const url = `http://graywolf.top:6031/appassets/assets/bills/list/condition?startTime=${encodedStartTime}&endTime=${encodedEndTime}&type=&scene=bills`;

        // 6. 显示加载状态
        showToast('正在筛选账单...');
        const billsList = document.getElementById('billsList');
        if (billsList) billsList.innerHTML = '';

        // 7. 发送筛选请求
        fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
                'Accept': '*/*'
            }
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200 && Array.isArray(data.data)) {
                    updateBillsList(data.data); // 更新账单列表
                    showToast('日期筛选已应用');
                } else {
                    showToast(data.message || '筛选账单失败');
                    if (billsList) billsList.innerHTML = '<div class="no-bills">筛选失败，请重试</div>';
                }
            })
            .catch(error => {
                console.error('筛选账单失败:', error);
                showToast('网络异常，筛选失败');
                if (billsList) billsList.innerHTML = '<div class="no-bills">网络异常，请稍后重试</div>';
            })
            .finally(() => {
                this.closeModal('dateFilterModal'); // 关闭筛选弹窗
            });
    },

    // 10. 通用工具方法
    reportProblem() {
        alert('问题反馈功能开发中，请联系客服处理');
    },

    closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'none';
    },

    // 获取用户Token（统一封装，避免重复代码）
    getAuthToken() {
        let token = '';
        try {
            const userDataStr = localStorage.getItem('userData') || '{}';
            const userData = JSON.parse(userDataStr);
            token = userData.token || '';
        } catch (error) {
            console.error('获取token失败:', error);
            showToast('登录状态异常，请重新登录');
            return '';
        }

        if (!token) {
            showToast('请先登录');
            return '';
        }

        return token;
    }
};

// 11. 外部依赖方法（保留原有逻辑，修复语法问题）
/**
 * 更新月份显示文本（与原有样式保持一致）
 */
function updateMonthDisplay() {
    const monthText = String(BillCenterModule.state.currentMonthIndex).padStart(2, '0');
    const currentMonthEl = document.getElementById('currentMonth');
    if (currentMonthEl) {
        currentMonthEl.textContent = `${BillCenterModule.state.currentYear}年${monthText}月`;
    }
    initBillSummary(); // 触发账单总览更新
}

/**
 * 加载对应月份的账单数据（保留原有日志）
 */
function loadBillsForMonth() {
    const { currentYear, currentMonthIndex } = BillCenterModule.state;
    console.log(`加载 ${currentYear}年${currentMonthIndex}月 的账单`);
}

/**
 * 初始化年度账单数据
 */
function initAnnualBill() {
    // 1. 获取当前年度（从页面标题提取）
    const yearTitleEl = document.querySelector('#annualBillPage .page-header h1');
    if (!yearTitleEl) return;

    const yearTitle = yearTitleEl.textContent;
    const yearMatch = yearTitle.match(/\d+/);
    if (!yearMatch) {
        console.error('未获取到年度信息');
        showToast('数据加载失败');
        return;
    }
    const year = yearMatch[0];

    // 2. 获取用户Token
    const token = BillCenterModule.getAuthToken();
    if (!token) return;

    // 3. 调用年度账单接口
    showToast('加载年度账单中...');
    fetch(`http://graywolf.top:6031/appassets/assets/bills/yearSummary?year=${year}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
            'Accept': '*/*'
        }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            if (data.code === 200 && data.data) {
                const annualData = data.data;
                updateAnnualStats(annualData);          // 更新年度统计数据
                updateAnnualCategories(annualData.expenseVos || []); // 更新支出分类
                drawAnnualTrendChart(annualData.expenseChartVos || []); // 绘制趋势图
                showToast('年度账单加载成功');
            } else {
                showToast(data.message || '获取年度账单失败');
            }
        })
        .catch(error => {
            console.error('年度账单初始化失败:', error);
            showToast(error.message || '网络异常，加载失败');
        });
}

/**
 * 更新年度统计数据（总支出、总收入、交易笔数）
 * @param {Object} data - 年度账单数据
 */
function updateAnnualStats(data) {
    // 金额格式化工具（保留两位小数+千分位）
    const formatAmount = (value) => {
        const num = parseFloat(value);
        return isNaN(num) ? '0.00' : num.toLocaleString('zh-CN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    };

    // 数字格式化工具（千分位，无小数）
    const formatNumber = (value) => {
        const num = parseInt(value);
        return isNaN(num) ? '0' : num.toLocaleString('zh-CN');
    };

    // 更新总支出（primary卡片）
    const expenseEl = document.querySelector('.annual-stats .primary .stat-value');
    if (expenseEl) {
        expenseEl.textContent = `¥${formatAmount(data.totalExpense)}`;
    }

    // 更新总收入（success卡片）
    const incomeEl = document.querySelector('.annual-stats .success .stat-value');
    if (incomeEl) {
        incomeEl.textContent = `¥${formatAmount(data.totalIncome)}`;
    }

    // 更新交易笔数（info卡片）
    const countEl = document.querySelector('.annual-stats .info .stat-value');
    if (countEl) {
        countEl.textContent = formatNumber(data.totalCount);
    }

    // 更新页面标题年份（如"2025年度账单"）
    const yearTitleEl = document.querySelector('#annualBillPage .page-header h1');
    if (yearTitleEl) {
        yearTitleEl.textContent = `${data.id || new Date().getFullYear()}年度账单`;
    }
}

/**
 * 更新支出分类统计列表
 * @param {Array} categories - 支出分类数据
 */
function updateAnnualCategories(categories) {
    const categoryList = document.querySelector('.category-analysis .category-list');
    if (!categoryList) return;

    // 清空现有分类
    categoryList.innerHTML = '';

    // 分类图标映射（与原有逻辑一致）
    const iconMap = {
        '餐饮美食': 'canyin.png',
        '购物消费': 'gouwu.png',
        '交通出行': 'zhiyin.png',
        '娱乐休闲': 'xiuxianyule.png',
        '生活服务': 'shenghuofuwu.png',
        '其他': 'shoukuanjiekou.png'
    };

    // 动态生成分类项（保留原有DOM结构与样式）
    categories.forEach(item => {
        const categoryItem = document.createElement('div');
        categoryItem.className = 'category-item';

        // 匹配图标（默认用"其他"图标）
        const iconSrc = iconMap[item.bizCategoryName] || iconMap['其他'];
        // 格式化金额和百分比（百分比取整）
        const formattedAmount = parseFloat(item.amount).toLocaleString('zh-CN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        const percentage = Math.round(parseFloat(item.percentage)) + '%';

        categoryItem.innerHTML = `
            <div class="category-info">
                <img src="icons/${iconSrc}" alt="${item.bizCategoryName}">
                <span class="category-name">${item.bizCategoryName}</span>
            </div>
            <div class="category-amount">¥${formattedAmount}</div>
            <div class="category-percent">${percentage}</div>
        `;
        categoryList.appendChild(categoryItem);
    });
}

/**
 * 绘制月度支出趋势图（保留原有绘图逻辑）
 * @param {Array} chartData - 月度支出数据（expenseChartVos）
 */
function drawAnnualTrendChart(chartData = []) {
    const canvas = document.getElementById('annualTrendChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    // 初始化12个月数据（默认0）
    const monthlyData = Array(12).fill(0);
    // 从接口数据填充对应月份支出
    chartData.forEach(item => {
        const monthIndex = item.month - 1; // 转换为0-11索引
        if (monthIndex >= 0 && monthIndex < 12) {
            monthlyData[monthIndex] = parseFloat(item.totalExpense) || 0;
        }
    });
    const months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];

    // 清空画布
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 基础样式配置
    const padding = 30;
    const chartWidth = canvas.width - padding * 2;
    const chartHeight = canvas.height - padding * 2;
    const stepX = chartWidth / (monthlyData.length - 1);
    const minValue = Math.min(...monthlyData);
    const maxValue = Math.max(...monthlyData);
    const valueRange = maxValue - minValue || 1; // 避免除数为0

    // 绘制网格线（灰色细线条）
    ctx.strokeStyle = '#f0f0f0';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = padding + (chartHeight / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(padding + chartWidth, y);
        ctx.stroke();
    }

    // 绘制数据线（蓝色粗线条）
    ctx.strokeStyle = '#2196F3';
    ctx.lineWidth = 3;
    ctx.beginPath();
    monthlyData.forEach((value, index) => {
        const x = padding + index * stepX;
        const y = padding + chartHeight - ((value - minValue) / valueRange) * chartHeight;
        index === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();

    // 绘制数据点（蓝色圆点）
    ctx.fillStyle = '#2196F3';
    monthlyData.forEach((value, index) => {
        const x = padding + index * stepX;
        const y = padding + chartHeight - ((value - minValue) / valueRange) * chartHeight;
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();
    });

    // 绘制填充区域（蓝色半透明）
    ctx.fillStyle = 'rgba(33, 150, 243, 0.1)';
    ctx.beginPath();
    monthlyData.forEach((value, index) => {
        const x = padding + index * stepX;
        const y = padding + chartHeight - ((value - minValue) / valueRange) * chartHeight;
        index === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.lineTo(padding + (monthlyData.length - 1) * stepX, padding + chartHeight);
    ctx.lineTo(padding, padding + chartHeight);
    ctx.closePath();
    ctx.fill();
}

/**
 * 格式化账单时间（YYYY-MM-DD HH:MM:SS）
 * @param {string} isoTime - ISO格式时间字符串
 * @returns {string} 格式化后的时间
 */
function formatBillTime(isoTime) {
    if (!isoTime) return '未知时间';
    const date = new Date(isoTime);
    if (isNaN(date.getTime())) return '未知时间'; // 无效时间兜底

    // 补零处理（确保两位数）
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

/**
 * 根据日期筛选结果更新账单列表
 * @param {Array} bills - 筛选后的账单数据
 */
function updateBillsList(bills) {
    const billsList = document.getElementById('billsList');
    if (!billsList) return;

    // 清空列表
    billsList.innerHTML = '';

    // 处理空数据
    if (bills.length === 0) {
        billsList.innerHTML = '<div class="no-bills">该日期范围内无账单记录</div>';
        return;
    }

    // 按日期分组（今天/昨天/更早之前）
    const groupedBills = groupBillsByDate(bills);

    // 生成日期组HTML（保留原有样式）
    Object.keys(groupedBills).forEach(dateKey => {
        const dateGroup = document.createElement('div');
        dateGroup.className = 'date-group';
        dateGroup.innerHTML = `<div class="date-header">${dateKey}</div>`;

        // 添加该组下所有账单
        groupedBills[dateKey].forEach(bill => {
            dateGroup.appendChild(createBillItem(bill));
        });

        billsList.appendChild(dateGroup);
    });
}

/**
 * 初始化账单列表（页面加载时调用）
 */
function initBillsList() {
    const container = document.getElementById('billsList');
    if (!container) {
        console.error('未找到账单列表容器');
        return;
    }

    // 清空容器并显示加载状态
    container.innerHTML = '';

    // 获取用户Token
    const token = BillCenterModule.getAuthToken();
    if (!token) {
        container.innerHTML = '<div class="no-bills">请先登录查看账单</div>';
        return;
    }

    // 调用账单列表接口
    fetch('http://graywolf.top:6031/appassets/assets/bills/list', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
            'Accept': '*/*'
        }
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            if (data.code === 200 && Array.isArray(data.data)) {
                const bills = data.data;
                if (bills.length === 0) {
                    container.innerHTML = '<div class="no-bills">暂无账单记录</div>';
                    return;
                }

                // 按日期分组并渲染
                const groupedBills = groupBillsByDate(bills);
                Object.keys(groupedBills).forEach(dateKey => {
                    const dateGroup = document.createElement('div');
                    dateGroup.className = 'date-group';
                    dateGroup.innerHTML = `<div class="date-header">${dateKey}</div>`;

                    // 渲染该组账单
                    groupedBills[dateKey].forEach(bill => {
                        dateGroup.appendChild(createBillItem(bill));
                    });

                    container.appendChild(dateGroup);
                });
            } else {
                showToast(data.message || '获取账单列表失败');
                container.innerHTML = '<div class="no-bills">获取账单失败，请重试</div>';
            }
        })
        .catch(error => {
            console.error('更新账单列表失败:', error);
            showToast(error.message || '网络异常，获取账单失败');
            container.innerHTML = '<div class="no-bills">网络异常，请稍后重试</div>';
        });
}

/**
 * 将账单按日期分组（今天/昨天/更早之前）
 * @param {Array} bills - 原始账单数据
 * @returns {Object} 分组后的账单 { '今天': [], '昨天': [], '更早之前': [] }
 */
function groupBillsByDate(bills) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    return bills.reduce((groups, bill) => {
        const billDate = new Date(bill.completeTime);
        let dateKey = '更早之前';

        // 判断日期归属
        if (isSameDay(billDate, today)) {
            dateKey = '今天';
        } else if (isSameDay(billDate, yesterday)) {
            dateKey = '昨天';
        }

        // 初始化分组数组并添加账单
        if (!groups[dateKey]) {
            groups[dateKey] = [];
        }
        groups[dateKey].push(bill);

        return groups;
    }, {});
}

/**
 * 判断两个日期是否为同一天
 * @param {Date} date1 - 日期1
 * @param {Date} date2 - 日期2
 * @returns {boolean} 是否为同一天
 */
function isSameDay(date1, date2) {
    return date1.getFullYear() === date2.getFullYear() &&
        date1.getMonth() === date2.getMonth() &&
        date1.getDate() === date2.getDate();
}

/**
 * 创建单个账单条目元素（保留原有DOM结构与样式）
 * @param {Object} bill - 账单数据
 * @returns {HTMLElement} 账单条目DOM
 */
function createBillItem(bill) {
    const billItem = document.createElement('div');
    const isExpense = bill.type !== 1; // 业务规则：type=1为收入，其他为支出

    // 设置类名与数据属性（供筛选和详情使用）
    billItem.className = `bill-item ${isExpense ? 'expense' : 'income'}`;
    billItem.dataset.type = isExpense ? 'expense' : 'income';
    billItem.dataset.category = bill.bizCategoryName || '其他';
    billItem.dataset.billId = bill.id || '';
    billItem.setAttribute('onclick', 'viewBillDetail(this)');

    // 格式化时间（YYYY-MM-DD HH:MM）
    const billTime = new Date(bill.completeTime);
    const formattedTime = isNaN(billTime.getTime())
        ? '未知时间'
        : `${billTime.getFullYear()}-${String(billTime.getMonth() + 1).padStart(2, '0')}-${String(billTime.getDate()).padStart(2, '0')} ${String(billTime.getHours()).padStart(2, '0')}:${String(billTime.getMinutes()).padStart(2, '0')}`;

    // 金额符号（收入+，支出-）
    const amountSign = isExpense ? '-' : '+';
    // 格式化金额（保留两位小数）
    const formattedAmount = parseFloat(bill.amount).toFixed(2);

    // 分类图标映射（与原有逻辑一致）
    const iconMap = {
        '餐饮': 'canyin.png',
        '出行': 'zhiyin.png',
        '购物': 'gouwu.png',
        '其他': 'shoukuanjiekou.png'
    };
    const iconSrc = iconMap[bill.bizCategoryName] || 'shoukuanjiekou.png';

    // 填充账单内容（完全保留原有HTML结构）
    billItem.innerHTML = `
        <div class="bill-icon">
            <img src="icons/${iconSrc}" alt="${bill.bizCategoryName || '账单图标'}">
        </div>
        <div class="bill-info">
            <h4>${bill.remark || bill.targetName || '未知账单'}</h4>
            <p>${bill.targetTypeName || '未知方式'} ${isExpense ? '支付' : '收款'} • ${formattedTime}</p>
            <span class="bill-category">${bill.bizCategoryName || '其他'}</span>
        </div>
        <div class="bill-amount ${isExpense ? 'expense' : 'income'}">
            ${amountSign}¥${formattedAmount}
        </div>
    `;

    return billItem;
}

/**
 * 初始化账单总览（月度收支统计）
 */
    function initBillSummary() {
    // 1. 获取当前选中的年月（从显示文本提取）
    const currentMonthEl = document.getElementById('currentMonth');
    if (!currentMonthEl) return;

    const currentMonthText = currentMonthEl.textContent.trim();
    const year = currentMonthText.split('年')[0]; // 提取年份（如"2025"）
    const month = currentMonthText.split('年')[1]?.replace('月', '') || ''; // 提取月份（如"07"）

    if (!year || !month) {
        console.error('无法解析当前年月信息');
        return;
    }

    // 2. 获取用户Token
    const token = BillCenterModule.getAuthToken();
    if (!token) return;

    // 3. 调用账单总览接口
    showToast('加载账单总览数据中...');
    fetch(`http://graywolf.top:6031/appassets/assets/bills/summary?year=${year}&month=${month}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
            'Accept': '*/*'
        }
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            if (data.code === 200 && data.data) {
                const summaryData = data.data;
                updateSummaryNumbers(summaryData); // 更新收支数字
                updateExpenseCategories(summaryData.expenseV0 || []); // 更新支出分类
                showToast('账单总览加载成功');
            } else {
                showToast(data.message || '获取账单数据失败');
            }
        })
        .catch(error => {
            console.error('账单总览初始化失败:', error);
            showToast(error.message || '网络异常，加载失败');
        });
}

/**
 * 更新收支总览数字（修复原代码语法问题）
 * @param {Object} data - 总览数据（收入/支出/结余）
 */
function updateSummaryNumbers(data) {
    // 金额格式化（保留两位小数+千分位）
    const formatAmount = (value) => {
        const num = parseFloat(value);
        return isNaN(num) ? '0.00' : num.toLocaleString('zh-CN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    };

    // 更新总收入
    const incomeEl = document.querySelector('.summary-item .income');
    if (incomeEl) {
        incomeEl.textContent = `¥${formatAmount(data.totalIncome || 0)}`;
    }

    // 更新总支出
    const expenseEl = document.querySelector('.summary-item .expense');
    if (expenseEl) {
        expenseEl.textContent = `¥${formatAmount(data.totalExpense || 0)}`;
    }

    // 更新结余（收入-支出）
    const balanceEl = document.querySelector('.summary-item .balance');
    if (balanceEl) {
        const balance = (parseFloat(data.totalIncome || 0) - parseFloat(data.totalExpense || 0)).toFixed(2);
        balanceEl.textContent = `¥${formatAmount(balance)}`;
    }
}

/**
 * 更新支出分类图表（保留原有样式与逻辑）
 * @param {Array} expenseList - 支出分类数据
 */
function updateExpenseCategories(expenseList) {
    const chartContainer = document.querySelector('.expense-chart');
    if (!chartContainer) return;

    // 固定分类配置（与UI样式匹配）
    const fixedCategories = [
        { name: '餐饮', color: '#ff6b6b' },
        { name: '出行', color: '#4ecdc4' },
        { name: '购物', color: '#45b7d1' },
        { name: '其他', color: '#f9ca24' }
    ];

    // 转换接口数据为Map（按分类名称映射）
    const expenseMap = new Map();
    expenseList.forEach(item => {
        expenseMap.set(item.bizCategoryName, {
            amount: item.amount || '0',
            percentage: item.percentage || '0.00'
        });
    });

    // 生成完整分类数据（缺失分类填充0）
    const fullCategories = fixedCategories.map(cat => {
        const matched = expenseMap.get(cat.name) || { amount: '0', percentage: '0.00' };
        return {
            ...cat,
            amount: matched.amount,
            percentage: Math.round(parseFloat(matched.percentage)).toString()
        };
    });

    // 清空并重新渲染图表
    chartContainer.innerHTML = '';
    fullCategories.forEach(item => {
        const chartItem = document.createElement('div');
        chartItem.className = 'chart-item';
        // 格式化金额（保留两位小数）
        const formattedAmount = parseFloat(item.amount).toLocaleString('zh-CN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        chartItem.innerHTML = `
            <div class="chart-color" style="background: ${item.color};"></div>
            <span class="chart-label">${item.name}</span>
            <span class="chart-amount">¥${formattedAmount}</span>
            <span class="chart-percent">${item.percentage}%</span>
        `;
        chartContainer.appendChild(chartItem);
    });
}

/**
 * Toast提示功能（保留原有样式与逻辑）
 * @param {string} message - 提示内容
 */
function showToast(message) {
    // 避免重复创建多个toast
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        document.body.removeChild(existingToast);
    }

    // 创建toast元素
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    // 保留原有内联样式（确保视觉一致）
    toast.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 14px;
    `;

    // 添加到页面并自动移除
    document.body.appendChild(toast);
    setTimeout(() => {
        document.body.removeChild(toast);
    }, 2000);
}

// 初始化账单中心模块（页面加载时执行）
BillCenterModule.init();
</script>
</body>

</html>