<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦å•ä¸­å¿ƒ - ç§»åŠ¨æ”¯ä»˜åº”ç”¨</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* æ¨¡æ€æ¡†æ•´ä½“æ ·å¼ */

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        /* è´¦å•åˆ†ç±»æ ‡ç­¾æ ·å¼ */
        .bill-category {
            display: inline-block;
            padding: 2px 8px;
            background-color: #f0f2f5;
            color: #666;
            border-radius: 10px;
            font-size: 12px;
            margin-top: 4px;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 100%;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* æ¨¡æ€æ¡†å¤´éƒ¨æ ·å¼ */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f2f5;
            background-color: #f9fafc;
        }

        .modal-header h3 {
            color: #1d2129;
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* æ¨¡æ€æ¡†ä¸»ä½“æ ·å¼ */
        .modal-body {
            max-height: 70vh;
            /* è®¾ç½®æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢å†…å®¹æº¢å‡º */
            overflow-y: auto;
            /* å…è®¸å†…å®¹æº¢å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        }

        /* æ”¯å‡ºåˆ†ç±»é€‰æ‹©å™¨æ ·å¼ */
        .category-selector {
            width: 100%;
        }

        .category-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            color: #333;
            background-color: #fff;
            appearance: none;
            background-image: url('icons/danjiantouxia.png');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px;
        }

        /* æ¨¡æ€æ¡†åº•éƒ¨æ ·å¼ */
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            padding: 15px 20px;
            border-top: 1px solid #f0f2f5;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .modal-body {
                padding: 20px;
            }

            .year-title h2 {
                font-size: 2rem;
            }

            .annual-stats {
                flex-direction: column;
            }

            .stat-card {
                flex: 1 1 auto;
            }

            .category-list {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .modal-header {
                padding: 15px 20px;
            }

            .modal-header h3 {
                font-size: 1.25rem;
            }

            .modal-body {
                padding: 15px;
            }

            .year-title h2 {
                font-size: 1.75rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .monthly-trend h4,
            .category-analysis h4,
            .annual-insights h4,
            .annual-goals h4 {
                font-size: 1.1rem;
            }
        }

        .action-btn {
            display: flex;
            align-items: center;
            flex-direction: row;
            gap: 8px;
            width: 100%;
            padding: 12px;
            background: #fff2e8;
            border: 1px solid #ffd591;
            border-radius: 8px;
            color: #fa8c16;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #ffe7ba;
        }

        .action-btn img {
            width: 16px;
            height: 16px;
        }

        .btn-secondary {
            background-color: #f0f2f5;
            color: #1d2129;
            margin-right: 15px;
        }

        .btn-secondary:hover {
            background-color: #e5e6eb;
        }

        .search-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #f8f9fa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #e9ecef;
            transform: scale(1.05);
        }

        .search-btn img {
            width: 20px;
            height: 20px;
        }

        /* å¹´åº¦è´¦å•é¡µé¢æ ·å¼ */
        #annualBillPage {
            padding: 0 15px;
            margin-bottom: 50px;
            overflow-y: auto;
            height: calc(100% - 120px);
        }

        .annual-summary {
            padding: 15px 0;
        }

        .year-title {
            text-align: center;
            margin-bottom: 20px;
        }

        .year-title h2 {
            font-size: 2.5rem;
            color: #1890ff;
            margin-bottom: 5px;
        }

        .year-title p {
            color: #666;
            font-size: 1rem;
        }

        .annual-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-card {
            flex: 1 1 30%;
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .stat-card.primary {
            border-left: 4px solid #ff6b6b;
        }

        .stat-card.success {
            border-left: 4px solid #4ecdc4;
        }

        .stat-card.info {
            border-left: 4px solid #45b7d1;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }

        .stat-icon img {
            width: 24px;
            height: 24px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1d2129;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .monthly-trend,
        .category-analysis,
        .annual-insights,
        .annual-goals {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .monthly-trend h4,
        .category-analysis h4,
        .annual-insights h4,
        .annual-goals h4 {
            font-size: 1.2rem;
            color: #1d2129;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .trend-chart {
            width: 100%;
            height: 180px;
            margin-top: 10px;
        }

        .category-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .category-item {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: #f9fafc;
            border-radius: 8px;
        }

        .category-info {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .category-info img {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }

        .category-name {
            font-size: 0.9rem;
            color: #1d2129;
        }

        .category-amount {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1d2129;
            margin-bottom: 4px;
        }

        .category-percent {
            font-size: 0.85rem;
            color: #666;
        }

        .insight-list,
        .goal-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            background: #f9fafc;
            padding: 12px;
            border-radius: 8px;
        }

        .insight-icon {
            font-size: 1.5rem;
            margin-right: 12px;
            line-height: 1;
        }

        .insight-text {
            flex: 1;
        }

        .insight-title {
            font-weight: 600;
            color: #1d2129;
            margin-bottom: 4px;
        }

        .insight-desc {
            font-size: 0.9rem;
            color: #666;
        }

        .goal-item {
            display: flex;
            align-items: center;
            background: #f0f7ff;
            padding: 12px;
            border-radius: 8px;
        }

        .goal-icon {
            font-size: 1.5rem;
            margin-right: 12px;
        }

        .goal-text {
            font-size: 0.95rem;
            color: #1d2129;
        }

        .action-buttons {
            padding: 0 15px 20px;
        }
    </style>
</head>

<body>
<div class="app-container">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->

    <!-- è´¦å•ä¸­å¿ƒé¡µé¢ -->
    <div class="bills-page" id="billsPage" style="display: block;">
        <!-- å¤´éƒ¨ -->
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">
                <img src="icons/danjiantouzuo.png" alt="è¿”å›">
            </button>
            <h1>è´¦å•ä¸­å¿ƒ</h1>
            <button class="search-btn" onclick="goToSearch()">
                <img src="icons/sousuo.png" alt="æœç´¢">
            </button>
        </div>

        <!-- æœˆä»½åˆ‡æ¢ -->
        <div class="month-selector">
            <button class="month-nav" onclick="changeMonth(-1)">
                <img src="icons/danjiantouzuo.png" alt="ä¸Šæœˆ">
            </button>
            <div class="current-month" style="position: relative;">
                <div style="position: relative;z-index: 1;">
                    <span id="currentMonth">2024å¹´10æœˆ</span>
                    <img src="icons/danjiantouxia.png" alt="é€‰æ‹©">
                </div>
                <!-- é€æ˜è¦†ç›–çš„selectï¼ˆè§†è§‰ä¸å¯è§ï¼Œä½†å¯ç‚¹å‡»ï¼‰ -->
                <select id="hiddenMonthSelector" onchange="handleMonthSelect(this)"
                        style=" position: absolute;top: 0;left: 0;width: 100%;height: 100%;opacity: 0;z-index: 2;border: none;background: none;">
                    <!-- é€‰é¡¹é€šè¿‡JSç”Ÿæˆ -->
                </select>
            </div>
            <button class="month-nav" onclick="changeMonth(1)">
                <img src="icons/danjiantouyou.png" alt="ä¸‹æœˆ">
            </button>
        </div>

        <!-- è´¦å•æ€»è§ˆ -->
        <div class="bill-summary">
            <div class="summary-card">
                <div class="summary-item">
                    <span class="label">æ€»æ”¶å…¥</span>
                    <span class="amount income">Â¥8,000.00</span>
                </div>
                <div class="summary-item">
                    <span class="label">æ€»æ”¯å‡º</span>
                    <span class="amount expense">Â¥2,456.78</span>
                </div>
                <div class="summary-item">
                    <span class="label">ç»“ä½™</span>
                    <span class="amount balance">Â¥5,543.22</span>
                </div>
            </div>

            <div class="chart-section">
                <h3>æ”¯å‡ºåˆ†ç±»</h3>
                <div class="expense-chart">
                    <div class="chart-item">
                        <div class="chart-color" style="background: #ff6b6b;"></div>
                        <span class="chart-label">é¤é¥®</span>
                        <span class="chart-amount">Â¥982.34</span>
                        <span class="chart-percent">40%</span>
                    </div>
                    <div class="chart-item">
                        <div class="chart-color" style="background: #4ecdc4;"></div>
                        <span class="chart-label">å‡ºè¡Œ</span>
                        <span class="chart-amount">Â¥614.20</span>
                        <span class="chart-percent">25%</span>
                    </div>
                    <div class="chart-item">
                        <div class="chart-color" style="background: #45b7d1;"></div>
                        <span class="chart-label">è´­ç‰©</span>
                        <span class="chart-amount">Â¥491.36</span>
                        <span class="chart-percent">20%</span>
                    </div>
                    <div class="chart-item">
                        <div class="chart-color" style="background: #f9ca24;"></div>
                        <span class="chart-label">å…¶ä»–</span>
                        <span class="chart-amount">Â¥368.88</span>
                        <span class="chart-percent">15%</span>
                    </div>
                </div>

                <button class="year-bill-btn" onclick="showAnnualBillPage()">
                    <img src="icons/rili.png" alt="å¹´åº¦è´¦å•">
                    <span>æŸ¥çœ‹å¹´åº¦è´¦å•</span>
                </button>
            </div>
        </div>

        <!-- ç­›é€‰å™¨ -->
        <div class="filter-section">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterBills('all')">å…¨éƒ¨</button>
                <button class="filter-tab" onclick="filterBills('income')">æ”¶å…¥</button>
                <button class="filter-tab" onclick="filterBills('expense')">æ”¯å‡º</button>
            </div>
            <button class="date-filter-btn" onclick="showDateFilter()">
                <img src="icons/rili.png" alt="æ—¥æœŸç­›é€‰">
                <span>æ—¥æœŸç­›é€‰</span>
            </button>
        </div>

        <!-- è´¦å•åˆ—è¡¨ -->
        <div class="bills-list" id="billsList">
            <!-- ä»Šå¤© -->
            <div class="date-group">
                <div class="date-header">ä»Šå¤©</div>

                <div class="bill-item expense" data-type="expense" data-category="é¤é¥®"
                     onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/canyin.png" alt="é¤é¥®">
                    </div>
                    <div class="bill-info">
                        <h4>æ˜Ÿå·´å…‹å’–å•¡</h4>
                        <p>æ”¯ä»˜å®æ”¯ä»˜ â€¢ 2025-7-29 15:30</p>
                        <span class="bill-category">é¤é¥®</span>
                    </div>
                    <div class="bill-amount expense">-Â¥32.00</div>
                </div>

                <div class="bill-item expense" data-type="expense" data-category="å‡ºè¡Œ"
                     onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/zhiyin.png" alt="å‡ºè¡Œ">
                    </div>
                    <div class="bill-info">
                        <h4>åœ°é“å‡ºè¡Œ</h4>
                        <p>å‡ºè¡Œç æ”¯ä»˜ â€¢ 2025-7-29 08:45</p>
                        <span class="bill-category">å‡ºè¡Œ</span>
                    </div>
                    <div class="bill-amount expense">-Â¥6.00</div>
                </div>
            </div>

            <!-- æ˜¨å¤© -->
            <div class="date-group">
                <div class="date-header">æ˜¨å¤©</div>

                <div class="bill-item income" data-type="income" data-category="å…¶ä»–" onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/shoukuanjiekou.png" alt="æ”¶æ¬¾">
                    </div>
                    <div class="bill-info">
                        <h4>æœ‹å‹è½¬è´¦</h4>
                        <p>æ”¶æ¬¾ç æ”¶æ¬¾ â€¢ 2025-7-28 19:20</p>
                        <span class="bill-category">å…¶ä»–</span>
                    </div>
                    <div class="bill-amount income">+Â¥200.00</div>
                </div>

                <div class="bill-item expense" data-type="expense" data-category="é¤é¥®"
                     onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/canyin.png" alt="æ”¯ä»˜">
                    </div>
                    <div class="bill-info">
                        <h4>ç¾å›¢å¤–å–</h4>
                        <p>é“¶è¡Œå¡æ”¯ä»˜ â€¢ 2025-7-28 12:15</p>
                        <span class="bill-category">é¤é¥®</span>
                    </div>
                    <div class="bill-amount expense">-Â¥45.80</div>
                </div>
            </div>

            <!-- æ›´æ—©ä¹‹å‰ -->
            <div class="date-group">
                <div class="date-header">æ›´æ—©ä¹‹å‰</div>

                <div class="bill-item expense" data-type="expense" data-category="è´­ç‰©"
                     onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/gouwu.png" alt="æ”¯ä»˜">
                    </div>
                    <div class="bill-info">
                        <h4>è¶…å¸‚è´­ç‰©</h4>
                        <p>æ‰«ç æ”¯ä»˜ â€¢ 2024-10-20 10:25</p>
                        <span class="bill-category">è´­ç‰©</span>
                    </div>
                    <div class="bill-amount expense">-Â¥128.50</div>
                </div>

                <div class="bill-item expense" data-type="expense" data-category="è´­ç‰©"
                     onclick="viewBillDetail(this)">
                    <div class="bill-icon">
                        <img src="icons/gouwu.png" alt="æ”¯ä»˜">
                    </div>
                    <div class="bill-info">
                        <h4>ä¾¿åˆ©åº—</h4>
                        <p>é“¶è¡Œå¡æ”¯ä»˜ â€¢ 2024-10-19 08:15</p>
                        <span class="bill-category">è´­ç‰©</span>
                    </div>
                    <div class="bill-amount expense">-Â¥35.50</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¹´åº¦è´¦å•é¡µé¢ -->
    <div class="bills-page" id="annualBillPage" style="display: none;">
        <!-- å¤´éƒ¨ -->
        <div class="page-header">
            <button class="back-btn" onclick="showBillsPage()">
                <img src="icons/danjiantouzuo.png" alt="è¿”å›">
            </button>
            <h1>2025å¹´åº¦è´¦å•</h1>
            <div style="width: 40px;"></div> <!-- å ä½å…ƒç´ ï¼Œä¿æŒå¤´éƒ¨å¯¹ç§° -->
        </div>

        <div class="annual-summary">
            <div class="year-title">
                <h2>2025</h2>
                <p>æ‚¨çš„æ•°å­—ç”Ÿæ´»è¶³è¿¹</p>
            </div>

            <div class="annual-stats">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <img src="icons/feiyongchaxun.png" alt="æ€»æ”¯å‡º">
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">Â¥45,680.50</div>
                        <div class="stat-label">å…¨å¹´æ€»æ”¯å‡º</div>
                    </div>
                </div>

                <div class="stat-card success">
                    <div class="stat-icon">
                        <img src="icons/shuangjiantoushang.png" alt="æ€»æ”¶å…¥">
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">Â¥52,300.00</div>
                        <div class="stat-label">å…¨å¹´æ€»æ”¶å…¥</div>
                    </div>
                </div>

                <div class="stat-card info">
                    <div class="stat-icon">
                        <img src="icons/a-27-lishishuju.png" alt="äº¤æ˜“æ¬¡æ•°">
                    </div>
                    <div class="stat-info">
                        <div class="stat-value">1,248</div>
                        <div class="stat-label">äº¤æ˜“ç¬”æ•°</div>
                    </div>
                </div>
            </div>

            <div class="monthly-trend">
                <h4>æœˆåº¦æ”¯å‡ºè¶‹åŠ¿</h4>
                <div class="trend-chart">
                    <canvas id="annualTrendChart" width="300" height="150"></canvas>
                </div>
            </div>

            <div class="category-analysis">
                <h4>æ”¯å‡ºåˆ†ç±»ç»Ÿè®¡</h4>
                <div class="category-list">
                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/canyin.png" alt="é¤é¥®">
                            <span class="category-name">é¤é¥®ç¾é£Ÿ</span>
                        </div>
                        <div class="category-amount">Â¥12,580.50</div>
                        <div class="category-percent">27.5%</div>
                    </div>

                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/gouwu.png" alt="è´­ç‰©">
                            <span class="category-name">è´­ç‰©æ¶ˆè´¹</span>
                        </div>
                        <div class="category-amount">Â¥9,240.80</div>
                        <div class="category-percent">20.2%</div>
                    </div>

                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/zhiyin.png" alt="äº¤é€š">
                            <span class="category-name">äº¤é€šå‡ºè¡Œ</span>
                        </div>
                        <div class="category-amount">Â¥6,890.20</div>
                        <div class="category-percent">15.1%</div>
                    </div>

                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/xiuxianyule.png" alt="å¨±ä¹">
                            <span class="category-name">å¨±ä¹ä¼‘é—²</span>
                        </div>
                        <div class="category-amount">Â¥5,420.30</div>
                        <div class="category-percent">11.9%</div>
                    </div>

                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/shenghuofuwu.png" alt="ç”Ÿæ´»">
                            <span class="category-name">ç”Ÿæ´»æœåŠ¡</span>
                        </div>
                        <div class="category-amount">Â¥4,680.90</div>
                        <div class="category-percent">10.2%</div>
                    </div>

                    <div class="category-item">
                        <div class="category-info">
                            <img src="icons/shoukuanjiekou.png" alt="å…¶ä»–">
                            <span class="category-name">å…¶ä»–</span>
                        </div>
                        <div class="category-amount">Â¥6,867.80</div>
                        <div class="category-percent">15.1%</div>
                    </div>
                </div>
            </div>

            <div class="annual-insights">
                <h4>å¹´åº¦æ´å¯Ÿ</h4>
                <div class="insight-list">
                    <div class="insight-item">
                        <div class="insight-icon">ğŸ“Š</div>
                        <div class="insight-text">
                            <div class="insight-title">æ¶ˆè´¹ä¹ æƒ¯</div>
                            <div class="insight-desc">æ‚¨æœ€çˆ±åœ¨å‘¨æœ«æ¶ˆè´¹ï¼Œé¤é¥®æ˜¯æœ€å¤§æ”¯å‡ºé¡¹</div>
                        </div>
                    </div>

                    <div class="insight-item">
                        <div class="insight-icon">ğŸ’°</div>
                        <div class="insight-text">
                            <div class="insight-title">ç†è´¢æˆæœ</div>
                            <div class="insight-desc">å…¨å¹´ç»“ä½™Â¥6,619.50ï¼Œç†è´¢æ„è¯†ä¸é”™</div>
                        </div>
                    </div>

                    <div class="insight-item">
                        <div class="insight-icon">ğŸ“ˆ</div>
                        <div class="insight-text">
                            <div class="insight-title">æ¶ˆè´¹è¶‹åŠ¿</div>
                            <div class="insight-desc">ä¸‹åŠå¹´æ”¯å‡ºå¢é•¿15%ï¼Œå»ºè®®åˆç†è§„åˆ’</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="annual-goals">
                <h4>æ–°å¹´ç›®æ ‡</h4>
                <div class="goal-list">
                    <div class="goal-item">
                        <div class="goal-icon">ğŸ¯</div>
                        <div class="goal-text">æ§åˆ¶é¤é¥®æ”¯å‡ºï¼Œç›®æ ‡å‡å°‘20%</div>
                    </div>
                    <div class="goal-item">
                        <div class="goal-icon">ğŸ’</div>
                        <div class="goal-text">å¢åŠ ç†è´¢æŠ•èµ„ï¼Œç›®æ ‡æ”¶ç›Š8%</div>
                    </div>
                    <div class="goal-item">
                        <div class="goal-icon">ğŸ“±</div>
                        <div class="goal-text">ä½¿ç”¨æ•°å­—æ”¯ä»˜ï¼Œäº«å—æ›´å¤šä¼˜æƒ </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons" style="display: flex; justify-content: space-between; margin: 20px 0;">
                <button class="btn-secondary" onclick="shareAnnualBill()">åˆ†äº«è´¦å•</button>
                <button class="btn-primary" onclick="downloadAnnualBill()">ä¸‹è½½æŠ¥å‘Š</button>
            </div>
        </div>
    </div>

    <!-- æ—¥æœŸç­›é€‰å¼¹çª— (åº•éƒ¨å¼¹å‡º) -->
    <div class="modal bottom-modal" id="dateFilterModal">
        <div class="modal-content bottom-modal-content">
            <div class="modal-header">
                <h3>é€‰æ‹©æ—¥æœŸèŒƒå›´</h3>
                <button class="close-btn" onclick="closeModal('dateFilterModal')">
                    <img src="icons/shibai.png" alt="å…³é—­">
                </button>
            </div>
            <div class="modal-body">
                <div class="date-range">
                    <div class="date-input-group">
                        <label>å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="startDate" value="2025-07-01" class="mobile-date-input">
                    </div>
                    <div class="date-input-group">
                        <label>ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="endDate" value="2025-07-31" class="mobile-date-input">
                    </div>
                </div>
                <div class="quick-date-options">
                    <button class="quick-date-btn" onclick="setQuickDate(7)">æœ€è¿‘7å¤©</button>
                    <button class="quick-date-btn" onclick="setQuickDate(30)">æœ€è¿‘30å¤©</button>
                    <button class="quick-date-btn" onclick="setQuickDate(90)">æœ€è¿‘3ä¸ªæœˆ</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeModal('dateFilterModal')">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="applyDateFilter()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- å¹´åº¦è´¦å•å·²ç§»è‡³é¡µé¢å½¢å¼æ˜¾ç¤º -->

    <!-- åº•éƒ¨å¯¼èˆª -->

    <div class="bottom-nav">
        <div class="nav-item" onclick="goToIndex()">
            <img src="icons/a-1-gongzuotai.png" alt="é¦–é¡µ">
            <span>é¦–é¡µ</span>
        </div>
        <div class="nav-item" onclick="goToScan()">
            <img src="icons/saoma.png" alt="æ‰«ä¸€æ‰«">
            <span>æ‰«ä¸€æ‰«</span>
        </div>
        <div class="nav-item" onclick="goToAssistant()">
            <div class="floating-assistant" onclick=";">
                <div class="voice-wave"></div>
                <img src="icons/kefu.png" alt="æ™ºèƒ½åŠ©æ‰‹">
            </div>
        </div>
        <div class="nav-item active" onclick="goToBills()">
            <img src="icons/a-21-jiaoyizhongxin.png" alt="è´¦å•">
            <span>è´¦å•</span>
        </div>
        <div class="nav-item" onclick="goToProfile()">
            <img src="icons/a-29-gerenxinxi.png" alt="æˆ‘çš„">
            <span>æˆ‘çš„</span>
        </div>
    </div>
</div>

<script src="script.js"></script>
<script>
    // è´¦å•ä¸­å¿ƒç›¸å…³åŠŸèƒ½
    let currentMonthIndex = 7; // å½“å‰æœˆä»½ç´¢å¼•
    let currentYear = 2025;
    const YEAR_RANGE = { start: currentYear - 5, end: currentYear + 1 };

    function changeMonth(direction) {
        currentMonthIndex += direction;
        if (currentMonthIndex > 12) {
            currentMonthIndex = 1;
            currentYear++;
        } else if (currentMonthIndex < 1) {
            currentMonthIndex = 12;
            currentYear--;
        }

        updateMonthDisplay();
    }

    function initHiddenSelector() {
        const selector = document.getElementById('hiddenMonthSelector');
        if (!selector) return;

        // æ¸…ç©ºé€‰é¡¹
        selector.innerHTML = '';

        // ç”Ÿæˆå¹´ä»½å’Œæœˆä»½é€‰é¡¹ï¼ˆæ ¼å¼ï¼šYYYYå¹´MMæœˆï¼‰
        for (let year = YEAR_RANGE.start; year <= YEAR_RANGE.end; year++) {
            for (let month = 1; month <= 12; month++) {
                const option = document.createElement('option');
                const monthText = month.toString().padStart(2, '0'); // è¡¥é›¶ä¸ºä¸¤ä½ï¼ˆ01-12ï¼‰
                option.value = `${year}-${monthText}`; // å­˜å‚¨å€¼ï¼šYYYY-MM
                option.textContent = `${year}å¹´${monthText}æœˆ`; // æ˜¾ç¤ºæ–‡æœ¬

                // è®¾ç½®å½“å‰å¹´æœˆä¸ºé»˜è®¤é€‰ä¸­
                if (year === currentYear && month === currentMonthIndex) {
                    option.selected = true;
                }

                selector.appendChild(option);
            }
        }
    }

    /**
     * å¤„ç†ä¸‹æ‹‰é€‰æ‹©äº‹ä»¶ï¼ˆåŒæ­¥åˆ°æ˜¾ç¤ºå’Œæ•°æ®ï¼‰
     * @param {HTMLSelectElement} selector - éšè—çš„selectå…ƒç´ 
     */
    function handleMonthSelect(selector) {
        const selectedValue = selector.value; // æ ¼å¼ï¼šYYYY-MM
        if (!selectedValue) return;

        // è§£æé€‰ä¸­çš„å¹´æœˆ
        const [year, month] = selectedValue.split('-').map(Number);
        // æ›´æ–°å½“å‰å¹´æœˆ
        currentYear = year;
        currentMonthIndex = month;
        // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬ï¼ˆä¿æŒåŸæœ‰æ ·å¼ï¼‰
        updateMonthDisplay();
        // è§¦å‘æ•°æ®æ›´æ–°ï¼ˆå¦‚è´¦å•æ€»è§ˆï¼‰

    }

    /**
     * æ›´æ–°æœˆä»½æ˜¾ç¤ºæ–‡æœ¬ï¼ˆä¸åŸæœ‰æ ·å¼ä¿æŒä¸€è‡´ï¼‰
     */
    function updateMonthDisplay() {
        const monthText = currentMonthIndex.toString().padStart(2, '0'); // è¡¥é›¶ä¸ºä¸¤ä½
        document.getElementById('currentMonth').textContent = `${currentYear}å¹´${monthText}æœˆ`;

        initBillSummary();
    }

    function loadBillsForMonth() {
        // æ¨¡æ‹ŸåŠ è½½å¯¹åº”æœˆä»½çš„è´¦å•æ•°æ®
        console.log(`åŠ è½½ ${currentYear}å¹´${currentMonthIndex}æœˆ çš„è´¦å•`);
    }

    function filterBills(type) {
        document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        const billItems = document.querySelectorAll('.bill-item');
        billItems.forEach(item => {
            if (type === 'all' || item.dataset.type === type) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function goToSearch() {
        window.location.href = 'bill_search.html';
    }

    function showDateFilter() {
        document.getElementById('dateFilterModal').style.display = 'flex';
    }

    // æ˜¾ç¤ºå¹´åº¦è´¦å•é¡µé¢
    function showAnnualBillPage() {
        document.getElementById('billsPage').style.display = 'none';
        document.getElementById('annualBillPage').style.display = 'block';
        initAnnualBill();
        // å»¶è¿Ÿç»˜åˆ¶å›¾è¡¨ï¼Œç¡®ä¿é¡µé¢å·²æ˜¾ç¤º
        setTimeout(() => {
            drawAnnualTrendChart();
        }, 100);
    }

    history.pushState({ page: 'annual' }, 'å¹´åº¦è´¦å•', 'bills.html#annual');

    // è¿”å›è´¦å•ä¸­å¿ƒé¡µé¢
    function showBillsPage() {
        document.getElementById('annualBillPage').style.display = 'none';
        document.getElementById('billsPage').style.display = 'block';
        history.replaceState({ page: 'bills' }, 'è´¦å•ä¸­å¿ƒ', 'bills.html');
    }

    function initAnnualBill() {
        // 1. è·å–å½“å‰å¹´åº¦ï¼ˆä»é¡µé¢æ ‡é¢˜æå–ï¼Œå¦‚"2025å¹´åº¦è´¦å•"ï¼‰
        const yearTitle = document.querySelector('#annualBillPage .page-header h1').textContent;
        const year = yearTitle.match(/\d+/)[0]; // æå–å¹´ä»½æ•°å­—ï¼ˆå¦‚2025ï¼‰
        if (!year) {
            console.error('æœªè·å–åˆ°å¹´åº¦ä¿¡æ¯');
            showToast('æ•°æ®åŠ è½½å¤±è´¥');
            return;
        }

        // 2. è·å–token
        let token = '';
        try {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            token = userData.token || '';

        } catch (error) {
            console.error('è·å–tokenå¤±è´¥:', error);
            showToast('ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
            return;
        }
        if (!token) {
            showToast('è¯·å…ˆç™»å½•');
            return;
        }

        // 3. è°ƒç”¨å¹´åº¦è´¦å•æ¥å£
        showToast('åŠ è½½å¹´åº¦è´¦å•ä¸­...');
        fetch(`http://graywolf.top:6031/appassets/assets/bills/yearSummary?year=${year}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
                'Accept': '*/*'
            }
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200 && data.data) {
                    const annualData = data.data;
                    // æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼ˆæ€»æ”¯å‡ºã€æ€»æ”¶å…¥ã€äº¤æ˜“ç¬”æ•°ï¼‰
                    updateAnnualStats(annualData);
                    // æ›´æ–°æ”¯å‡ºåˆ†ç±»åˆ—è¡¨
                    updateAnnualCategories(annualData.expenseVos || []);
                    // ç»˜åˆ¶æœˆåº¦æ”¯å‡ºè¶‹åŠ¿å›¾
                    drawAnnualTrendChart(annualData.expenseChartVos || []);
                    showToast('å¹´åº¦è´¦å•åŠ è½½æˆåŠŸ');
                } else {
                    showToast(data.message || 'è·å–å¹´åº¦è´¦å•å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('å¹´åº¦è´¦å•åˆå§‹åŒ–å¤±è´¥:', error);
                showToast(error.message || 'ç½‘ç»œå¼‚å¸¸ï¼ŒåŠ è½½å¤±è´¥');
            });
    }

    /**
     * æ›´æ–°å¹´åº¦ç»Ÿè®¡æ•°æ®ï¼ˆæ€»æ”¯å‡ºã€æ€»æ”¶å…¥ã€äº¤æ˜“ç¬”æ•°ï¼‰
     * @param {Object} data - å¹´åº¦è´¦å•æ•°æ®
     */
    function updateAnnualStats(data) {
        // æ ¼å¼åŒ–é‡‘é¢ï¼ˆä¿ç•™ä¸¤ä½å°æ•°ï¼Œæ·»åŠ åƒåˆ†ä½ï¼‰
        const formatAmount = (value) => {
            return parseFloat(value).toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };

        // æ ¼å¼åŒ–æ•°å­—ï¼ˆæ·»åŠ åƒåˆ†ä½ï¼Œæ— å°æ•°ï¼‰
        const formatNumber = (value) => {
            return parseInt(value).toLocaleString('zh-CN');
        };

        // æ›´æ–°æ€»æ”¯å‡ºï¼ˆprimaryå¡ç‰‡ï¼‰
        const expenseEl = document.querySelector('.annual-stats .primary .stat-value');
        if (expenseEl) {
            expenseEl.textContent = `Â¥${formatAmount(data.totalExpense)}`;
        }

        // æ›´æ–°æ€»æ”¶å…¥ï¼ˆsuccesså¡ç‰‡ï¼‰
        const incomeEl = document.querySelector('.annual-stats .success .stat-value');
        if (incomeEl) {
            incomeEl.textContent = `Â¥${formatAmount(data.totalIncome)}`;
        }

        // æ›´æ–°äº¤æ˜“ç¬”æ•°ï¼ˆinfoå¡ç‰‡ï¼‰
        const countEl = document.querySelector('.annual-stats .info .stat-value');
        if (countEl) {
            countEl.textContent = formatNumber(data.totalCount);
        }

        // æ›´æ–°é¡µé¢æ ‡é¢˜å¹´ä»½ï¼ˆå¦‚"2025å¹´åº¦è´¦å•"ï¼‰
        document.querySelector('#annualBillPage .page-header h1').textContent = `${data.id || year}å¹´åº¦è´¦å•`;
    }

    /**
     * æ›´æ–°æ”¯å‡ºåˆ†ç±»ç»Ÿè®¡åˆ—è¡¨
     * @param {Array} categories - æ”¯å‡ºåˆ†ç±»æ•°æ®
     */
    function updateAnnualCategories(categories) {
        const categoryList = document.querySelector('.category-analysis .category-list');
        if (!categoryList) return;

        // æ¸…ç©ºç°æœ‰åˆ†ç±»
        categoryList.innerHTML = '';

        // å®šä¹‰åˆ†ç±»å›¾æ ‡æ˜ å°„ï¼ˆæ ¹æ®ä¸šåŠ¡è¡¥å……ï¼‰
        const iconMap = {
            'é¤é¥®ç¾é£Ÿ': 'canyin.png',
            'è´­ç‰©æ¶ˆè´¹': 'gouwu.png',
            'äº¤é€šå‡ºè¡Œ': 'zhiyin.png',
            'å¨±ä¹ä¼‘é—²': 'xiuxianyule.png',
            'ç”Ÿæ´»æœåŠ¡': 'shenghuofuwu.png',
            'å…¶ä»–': 'shoukuanjiekou.png'
        };

        // åŠ¨æ€ç”Ÿæˆåˆ†ç±»é¡¹
        categories.forEach(item => {
            const categoryItem = document.createElement('div');
            categoryItem.className = 'category-item';

            // åŒ¹é…å›¾æ ‡ï¼ˆé»˜è®¤ç”¨"å…¶ä»–"å›¾æ ‡ï¼‰
            const iconSrc = iconMap[item.bizCategoryName] || iconMap['å…¶ä»–'];
            // æ ¼å¼åŒ–é‡‘é¢å’Œç™¾åˆ†æ¯”ï¼ˆç™¾åˆ†æ¯”å»å°æ•°ï¼‰
            const formattedAmount = parseFloat(item.amount).toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            const percentage = Math.round(parseFloat(item.percentage)) + '%';

            categoryItem.innerHTML = `
        <div class="category-info">
            <img src="icons/${iconSrc}" alt="${item.bizCategoryName}">
            <span class="category-name">${item.bizCategoryName}</span>
        </div>
        <div class="category-amount">Â¥${formattedAmount}</div>
        <div class="category-percent">${percentage}</div>
    `;
            categoryList.appendChild(categoryItem);
        });
    }

    /**
     * ç»˜åˆ¶æœˆåº¦æ”¯å‡ºè¶‹åŠ¿å›¾ï¼ˆé‡å†™åŸå‡½æ•°ï¼Œä½¿ç”¨æ¥å£æ•°æ®ï¼‰
     * @param {Array} chartData - æœˆåº¦æ”¯å‡ºæ•°æ®ï¼ˆexpenseChartVosï¼‰
     */
    function drawAnnualTrendChart(chartData) {
        const canvas = document.getElementById('annualTrendChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        // ä»æ¥å£æ•°æ®æå–12ä¸ªæœˆçš„æ”¯å‡ºï¼ˆæŒ‰æœˆä»½1-12æ’åºï¼‰
        const monthlyData = Array(12).fill(0); // åˆå§‹åŒ–12ä¸ªæœˆæ•°æ®
        chartData.forEach(item => {
            const monthIndex = item.month - 1; // è½¬æ¢ä¸º0-11ç´¢å¼•
            if (monthIndex >= 0 && monthIndex < 12) {
                monthlyData[monthIndex] = parseFloat(item.totalExpense) || 0;
            }
        });
        const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];

        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // è®¾ç½®æ ·å¼
        ctx.strokeStyle = '#2196F3';
        ctx.lineWidth = 3;
        ctx.fillStyle = 'rgba(33, 150, 243, 0.1)';

        // è®¡ç®—åæ ‡ï¼ˆå¤„ç†æ•°æ®å…¨ä¸º0çš„æƒ…å†µï¼‰
        const padding = 30;
        const chartWidth = canvas.width - padding * 2;
        const chartHeight = canvas.height - padding * 2;
        const stepX = chartWidth / (monthlyData.length - 1);
        const minValue = Math.min(...monthlyData);
        const maxValue = Math.max(...monthlyData);
        // é¿å…é™¤æ•°ä¸º0ï¼ˆæ‰€æœ‰æ•°æ®ä¸º0æ—¶ï¼‰
        const valueRange = maxValue - minValue || 1;

        // ç»˜åˆ¶ç½‘æ ¼çº¿
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 4; i++) {
            const y = padding + (chartHeight / 4) * i;
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(padding + chartWidth, y);
            ctx.stroke();
        }

        // ç»˜åˆ¶æ•°æ®çº¿
        ctx.strokeStyle = '#2196F3';
        ctx.lineWidth = 3;
        ctx.beginPath();
        monthlyData.forEach((value, index) => {
            const x = padding + index * stepX;
            // è®¡ç®—Yè½´åæ ‡ï¼ˆæ•°æ®ä¸º0æ—¶ç‰¹æ®Šå¤„ç†ï¼‰
            const y = padding + chartHeight - ((value - minValue) / valueRange) * chartHeight;

            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        ctx.stroke();

        // ç»˜åˆ¶æ•°æ®ç‚¹
        ctx.fillStyle = '#2196F3';
        monthlyData.forEach((value, index) => {
            const x = padding + index * stepX;
            const y = padding + chartHeight - ((value - minValue) / valueRange) * chartHeight;

            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        });

        // ç»˜åˆ¶å¡«å……åŒºåŸŸ
        ctx.fillStyle = 'rgba(33, 150, 243, 0.1)';
        ctx.beginPath();
        monthlyData.forEach((value, index) => {
            const x = padding + index * stepX;
            const y = padding + chartHeight - ((value - minValue) / valueRange) * chartHeight;

            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        ctx.lineTo(padding + (monthlyData.length - 1) * stepX, padding + chartHeight);
        ctx.lineTo(padding, padding + chartHeight);
        ctx.closePath();
        ctx.fill();
    }




    // åˆ†äº«å¹´åº¦è´¦å•
    function shareAnnualBill() {
        alert('åˆ†äº«å¹´åº¦è´¦å•åŠŸèƒ½');
    }

    // ä¸‹è½½å¹´åº¦è´¦å•
    function downloadAnnualBill() {
        alert('ä¸‹è½½å¹´åº¦è´¦å•æŠ¥å‘ŠåŠŸèƒ½');
    }

    async function viewBillDetail(billItem) {
        // 1. ä»ç‚¹å‡»çš„è´¦å•æ¡ç›®è·å–billId
        const billId = billItem.dataset.billId;
        if (!billId) {
            showToast('æœªè·å–åˆ°è´¦å•ID');
            return;
        }

        // 2. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showToast('åŠ è½½è´¦å•è¯¦æƒ…ä¸­...');

        // 3. è·å–token
        let token = '';
        try {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            token = userData.token || '';
        } catch (error) {
            console.error('è·å–tokenå¤±è´¥:', error);
            showToast('ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
            return;
        }
        if (!token) {
            showToast('è¯·å…ˆç™»å½•');
            return;
        }

        try {
            // 4. è°ƒç”¨è´¦å•è¯¦æƒ…æ¥å£
            const response = await fetch(`http://graywolf.top:6031/appassets/assets/bills/detail?id=${billId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
                    'Accept': '*/*'
                }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || 'è·å–è´¦å•è¯¦æƒ…å¤±è´¥');
            }

            const result = await response.json();
            if (result.code === 200 && result.data) {
                const bill = result.data;
                // 5. æ ¼å¼åŒ–è¯¦æƒ…æ•°æ®ï¼ˆé€‚é…è¯¦æƒ…é¡µéœ€è¦çš„å­—æ®µï¼‰
                const detailData = {
                    id: bill.id,
                    merchant: bill.targetName || 'æœªçŸ¥è´¦æˆ·', // æ”¶æ¬¾/ä»˜æ¬¾æ–¹åç§°
                    amount: `${bill.type === 1 ? '+' : '-'}Â¥${bill.amount}`, // æ”¶å…¥+ï¼Œæ”¯å‡º-
                    type: bill.typeName, // äº¤æ˜“ç±»å‹ï¼ˆæ”¶å…¥/è½¬å‡ºç­‰ï¼‰
                    category: bill.bizCategoryName || 'å…¶ä»–', // äº¤æ˜“åˆ†ç±»
                    payment: `${bill.targetTypeName} ${bill.type === 1 ? 'æ”¶æ¬¾' : 'æ”¯ä»˜'}`, // æ”¯ä»˜æ–¹å¼æè¿°
                    time: formatBillTime(bill.completeTime), // æ ¼å¼åŒ–æ—¶é—´
                    orderNo: bill.transferNumber || 'æ— äº¤æ˜“å•å·', // äº¤æ˜“å•å·
                    note: bill.remark || 'æ— å¤‡æ³¨ä¿¡æ¯' // å¤‡æ³¨å†…å®¹
                };

                // 6. ä¿å­˜æ•°æ®åˆ°sessionStorageä¾›è¯¦æƒ…é¡µä½¿ç”¨
                sessionStorage.setItem('currentBillData', JSON.stringify(detailData));

                // 7. è·³è½¬åˆ°è¯¦æƒ…é¡µ
                window.location.href = 'bill_detail.html';
            } else {
                throw new Error(result.message || 'è·å–è¯¦æƒ…æ•°æ®å¤±è´¥');
            }
        } catch (error) {
            console.error('è´¦å•è¯¦æƒ…åŠ è½½å¤±è´¥:', error);
            showToast(error.message || 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯¦æƒ…åŠ è½½å¤±è´¥');
        }
    }
    function formatBillTime(isoTime) {
        if (!isoTime) return 'æœªçŸ¥æ—¶é—´';
        const date = new Date(isoTime);
        // è¡¥é›¶å¤„ç†ï¼ˆç¡®ä¿æœˆä»½ã€æ—¥æœŸç­‰ä¸ºä¸¤ä½æ•°ï¼‰
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // æœˆä»½ä»0å¼€å§‹ï¼Œéœ€+1
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
    function performSearch() {
        const keyword = document.getElementById('searchInput').value.trim();
        if (!keyword) return;

        // æ¨¡æ‹Ÿæœç´¢ç»“æœ
        const searchResults = document.getElementById('searchResults');
        searchResults.innerHTML = `
            <div class="bill-item expense" data-type="expense" data-category="é¤é¥®" onclick="viewBillDetail(this)">
                <div class="bill-icon">
                    <img src="icons/a-2-lijifukuan.png" alt="æ”¯ä»˜">
                </div>
                <div class="bill-info">
                    <h4>æ˜Ÿå·´å…‹å’–å•¡</h4>
                    <p>æ”¯ä»˜å®æ”¯ä»˜ â€¢ 2024-10-22 15:30</p>
                    <span class="bill-category">é¤é¥®</span>
                </div>
                <div class="bill-amount expense">-Â¥32.00</div>
            </div>
            <div class="no-more-results">æ²¡æœ‰æ›´å¤šç»“æœäº†</div>
        `;
    }

    function handleSearchKeyPress(event) {
        if (event.key === 'Enter') {
            performSearch();
        }
    }

    function setQuickDate(days) {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - days);

        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
    }

    function applyDateFilter() {
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;

        // éªŒè¯æ—¥æœŸè¾“å…¥
        if (!startDate || !endDate) {
            showToast('è¯·é€‰æ‹©å®Œæ•´çš„æ—¥æœŸèŒƒå›´');
            return;
        }

        // æ ¼å¼åŒ–æ—¥æœŸå‚æ•°ï¼ˆæ‹¼æ¥æ—¶é—´ï¼‰
        const startTime = `${startDate} 00:00:00`;
        const endTime = `${endDate} 23:59:59`;

        // è·å–token
        let token = '';
        try {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            token = userData.token || '';

        } catch (error) {
            console.error('è·å–tokenå¤±è´¥:', error);
            showToast('ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
            return;
        }
        if (!token) {
            showToast('è¯·å…ˆç™»å½•');
            return;
        }

        // æ„å»ºè¯·æ±‚URLï¼ˆç¼–ç ç‰¹æ®Šå­—ç¬¦ï¼‰
        const encodedStartTime = encodeURIComponent(startTime);
        const encodedEndTime = encodeURIComponent(endTime);
        const url = `http://graywolf.top:6031/appassets/assets/bills/list/condition?startTime=${encodedStartTime}&endTime=${encodedEndTime}&type=&scene=bills`;

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showToast('æ­£åœ¨ç­›é€‰è´¦å•...');
        const billsList = document.getElementById('billsList');
        billsList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

        // å‘é€è¯·æ±‚
        fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
                'Accept': '*/*'
            }
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200 && Array.isArray(data.data)) {
                    // ç­›é€‰æˆåŠŸï¼Œæ›´æ–°è´¦å•åˆ—è¡¨
                    console.log("æ¥å£è¿”å›å®Œæ•´æ•°æ®ï¼š", JSON.stringify(data, null, 2));
                    updateBillsList(data.data);
                    showToast('æ—¥æœŸç­›é€‰å·²åº”ç”¨');
                } else {
                    showToast(data.message || 'ç­›é€‰è´¦å•å¤±è´¥');
                    billsList.innerHTML = '<div class="no-bills">ç­›é€‰å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                }
            })
            .catch(error => {
                console.error('ç­›é€‰è´¦å•å¤±è´¥:', error);
                showToast('ç½‘ç»œå¼‚å¸¸ï¼Œç­›é€‰å¤±è´¥');
                billsList.innerHTML = '<div class="no-bills">ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•</div>';
            })
            .finally(() => {
                closeModal('dateFilterModal');
            });
    }

    /**
     * æ ¹æ®æ¥å£è¿”å›æ•°æ®æ›´æ–°è´¦å•åˆ—è¡¨
     * @param {Array} bills - ç­›é€‰åçš„è´¦å•æ•°æ®
     */
    function updateBillsList(bills) {
        const billsList = document.getElementById('billsList');
        if (!billsList) return;

        // æ¸…ç©ºåˆ—è¡¨
        billsList.innerHTML = '';

        // å¤„ç†ç©ºæ•°æ®
        if (bills.length === 0) {
            billsList.innerHTML = '<div class="no-bills">è¯¥æ—¥æœŸèŒƒå›´å†…æ— è´¦å•è®°å½•</div>';
            return;
        }

        // æŒ‰æ—¥æœŸåˆ†ç»„ï¼ˆä»Šå¤©/æ˜¨å¤©/æ›´æ—©ä¹‹å‰ï¼‰
        const groupedBills = groupBillsByDate(bills);

        // ç”ŸæˆHTML
        Object.keys(groupedBills).forEach(dateKey => {
            // åˆ›å»ºæ—¥æœŸç»„å®¹å™¨
            const dateGroup = document.createElement('div');
            dateGroup.className = 'date-group';
            dateGroup.innerHTML = `<div class="date-header">${dateKey}</div>`;

            // æ·»åŠ è¯¥æ—¥æœŸç»„ä¸‹çš„æ‰€æœ‰è´¦å•
            groupedBills[dateKey].forEach(bill => {
                dateGroup.appendChild(createBillItem(bill));
            });

            billsList.appendChild(dateGroup);
        });
    }

    function reportProblem() {
        alert('é—®é¢˜åé¦ˆåŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·è”ç³»å®¢æœå¤„ç†');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function goBack() {
        window.history.back();
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 14px;
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 2000);
    }

    // é¡µé¢è·³è½¬å‡½æ•°
    function goToPage(page) {
        window.location.href = page;
    }
    function initBillsList() {
        const container = document.getElementById('billsList');
        if (!container) {
            console.error('æœªæ‰¾åˆ°è´¦å•åˆ—è¡¨å®¹å™¨');
            return;
        }

        // æ¸…ç©ºå®¹å™¨
        container.innerHTML = '';

        // è·å–token
        let token = '';
        try {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            token = userData.token || '';

        } catch (error) {
            console.error('è·å–tokenå¤±è´¥:', error);
            showToast('ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
            return;
        }

        if (!token) {
            showToast('è¯·å…ˆç™»å½•');
            return;
        }

        // è°ƒç”¨æ¥å£è·å–è´¦å•æ•°æ®
        fetch('http://graywolf.top:6031/appassets/assets/bills/list', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
                'Accept': '*/*'
            }
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200 && Array.isArray(data.data)) {
                    const bills = data.data;
                    if (bills.length === 0) {
                        container.innerHTML = '<div class="no-bills">æš‚æ— è´¦å•è®°å½•</div>';
                        return;
                    }

                    // æŒ‰æ—¥æœŸåˆ†ç»„ï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€æ›´æ—©ä¹‹å‰ï¼‰
                    const groupedBills = groupBillsByDate(bills);

                    // æ¸²æŸ“æ¯ä¸ªæ—¥æœŸç»„
                    Object.keys(groupedBills).forEach(dateKey => {
                        const dateGroup = document.createElement('div');
                        dateGroup.className = 'date-group';

                        // æ·»åŠ æ—¥æœŸæ ‡é¢˜ï¼ˆä»Šå¤©/æ˜¨å¤©/æ›´æ—©ä¹‹å‰ï¼‰
                        dateGroup.innerHTML = `<div class="date-header">${dateKey}</div>`;

                        // æ¸²æŸ“è¯¥ç»„ä¸‹çš„æ‰€æœ‰è´¦å•
                        groupedBills[dateKey].forEach(bill => {
                            dateGroup.appendChild(createBillItem(bill));
                        });

                        container.appendChild(dateGroup);
                    });
                } else {
                    showToast(data.message || 'è·å–è´¦å•åˆ—è¡¨å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('æ›´æ–°è´¦å•åˆ—è¡¨å¤±è´¥:', error);
                showToast(error.message || 'ç½‘ç»œå¼‚å¸¸ï¼Œè·å–è´¦å•å¤±è´¥');
            });
    }

    /**
     * å°†è´¦å•æŒ‰æ—¥æœŸåˆ†ç»„ï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€æ›´æ—©ä¹‹å‰ï¼‰
     * @param {Array} bills - åŸå§‹è´¦å•æ•°æ®
     * @returns {Object} åˆ†ç»„åçš„è´¦å• { 'ä»Šå¤©': [], 'æ˜¨å¤©': [], 'æ›´æ—©ä¹‹å‰': [] }
     */
    function groupBillsByDate(bills) {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        return bills.reduce((groups, bill) => {
            const billDate = new Date(bill.completeTime);
            let dateKey = 'æ›´æ—©ä¹‹å‰';

            // åˆ¤æ–­å±äºä»Šå¤©ã€æ˜¨å¤©è¿˜æ˜¯æ›´æ—©
            if (isSameDay(billDate, today)) {
                dateKey = 'ä»Šå¤©';
            } else if (isSameDay(billDate, yesterday)) {
                dateKey = 'æ˜¨å¤©';
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„ï¼ŒåŒæ—¶æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            if (!groups[dateKey]) {
                groups[dateKey] = [];
            }
            groups[dateKey].push(bill);

            return groups;
        }, {});
    }

    /**
     * åˆ¤æ–­ä¸¤ä¸ªæ—¥æœŸæ˜¯å¦ä¸ºåŒä¸€å¤©
     * @param {Date} date1 - æ—¥æœŸ1
     * @param {Date} date2 - æ—¥æœŸ2
     * @returns {boolean} æ˜¯å¦ä¸ºåŒä¸€å¤©
     */
    function isSameDay(date1, date2) {
        return date1.getFullYear() === date2.getFullYear() &&
            date1.getMonth() === date2.getMonth() &&
            date1.getDate() === date2.getDate();
    }

    /**
     * åˆ›å»ºå•ä¸ªè´¦å•æ¡ç›®å…ƒç´ 
     * @param {Object} bill - è´¦å•æ•°æ®
     * @returns {HTMLElement} è´¦å•å…ƒç´ 
     */
    function createBillItem(bill) {
        const billItem = document.createElement('div');
        const isExpense = bill.type !== 1; // å‡è®¾type=1ä¸ºæ”¶å…¥ï¼Œå…¶ä»–ä¸ºæ”¯å‡ºï¼ˆæ ¹æ®å®é™…ä¸šåŠ¡è°ƒæ•´ï¼‰

        // è®¾ç½®åŸºç¡€ç±»åå’Œæ•°æ®å±æ€§ï¼ˆä¿å­˜idä¾›æŸ¥çœ‹è¯¦æƒ…ï¼‰
        billItem.className = `bill-item ${isExpense ? 'expense' : 'income'}`;
        billItem.dataset.type = isExpense ? 'expense' : 'income';
        billItem.dataset.category = bill.bizCategoryName;
        billItem.dataset.billId = bill.id; // ä¿å­˜è´¦å•id
        billItem.setAttribute('onclick', 'viewBillDetail(this)');

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆYYYY-MM-DD HH:MMï¼‰
        const billTime = new Date(bill.completeTime);
        const formattedTime = `${billTime.getFullYear()}-${String(billTime.getMonth() + 1).padStart(2, '0')}-${String(billTime.getDate()).padStart(2, '0')} ${String(billTime.getHours()).padStart(2, '0')}:${String(billTime.getMinutes()).padStart(2, '0')}`;

        // é‡‘é¢ç¬¦å·ï¼ˆæ”¶å…¥+ï¼Œæ”¯å‡º-ï¼‰
        const amountSign = isExpense ? '-' : '+';

        // è®¾ç½®å›¾æ ‡ï¼ˆæ ¹æ®åˆ†ç±»åŒ¹é…ï¼Œè¿™é‡Œä½¿ç”¨ç¤ºä¾‹å›¾æ ‡ï¼Œå¯æ ¹æ®å®é™…éœ€æ±‚æ‰©å±•ï¼‰
        const iconMap = {
            'é¤é¥®': 'canyin.png',
            'å‡ºè¡Œ': 'zhiyin.png',
            'è´­ç‰©': 'gouwu.png',
            'å…¶ä»–': 'shoukuanjiekou.png' // é»˜è®¤ä½¿ç”¨æ”¶æ¬¾å›¾æ ‡
        };
        const iconSrc = iconMap[bill.bizCategoryName] || 'shoukuanjiekou.png';

        // æ‹¼æ¥è´¦å•å†…å®¹
        billItem.innerHTML = `
    <div class="bill-icon">
        <img src="icons/${iconSrc}" alt="${bill.bizCategoryName}">
    </div>
    <div class="bill-info">
        <h4>${bill.remark || bill.targetName}</h4> <!-- ä¼˜å…ˆæ˜¾ç¤ºå¤‡æ³¨ï¼Œæ— åˆ™æ˜¾ç¤ºç›®æ ‡åç§° -->
        <p>${bill.targetTypeName} ${isExpense ? 'æ”¯ä»˜' : 'æ”¶æ¬¾'} â€¢ ${formattedTime}</p>
        <span class="bill-category">${bill.bizCategoryName}</span>
    </div>
    <div class="bill-amount ${isExpense ? 'expense' : 'income'}">
        ${amountSign}Â¥${parseFloat(bill.amount).toFixed(2)}
    </div>
`;

        return billItem;
    }
    function initBillSummary() {
        // 1. è·å–å½“å‰é€‰ä¸­çš„å¹´æœˆï¼ˆä»æœˆä»½é€‰æ‹©å™¨ä¸­æå–ï¼‰
        const currentMonthText = document.getElementById('currentMonth').textContent.trim();
        const year = currentMonthText.split('å¹´')[0]; // æå–å¹´ä»½ï¼ˆå¦‚"2025"ï¼‰
        const month = currentMonthText.split('å¹´')[1].replace('æœˆ', ''); // æå–æœˆä»½ï¼ˆå¦‚"07"ï¼‰

        // 2. è·å–tokenè¿›è¡Œèº«ä»½éªŒè¯
        let token = '';
        try {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            token = userData.token || '';

        } catch (error) {
            console.error('è·å–tokenå¤±è´¥:', error);
            showToast('ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
            return;
        }
        if (!token) {
            showToast('è¯·å…ˆç™»å½•');
            return;
        }

        // 3. è°ƒç”¨è´¦å•æ€»è§ˆæ¥å£
        showToast('åŠ è½½è´¦å•æ€»è§ˆæ•°æ®ä¸­...');
        fetch(`http://graywolf.top:6031/appassets/assets/bills/summary?year=${year}&month=${month}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
                'Accept': '*/*'
            }
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200 && data.data) {
                    const summaryData = data.data;
                    // æ›´æ–°æ€»æ”¶å…¥ã€æ€»æ”¯å‡ºã€ç»“ä½™
                    updateSummaryNumbers(summaryData);
                    // æ›´æ–°æ”¯å‡ºåˆ†ç±»å›¾è¡¨
                    updateExpenseCategories(summaryData.expenseV0 || []);
                    showToast('è´¦å•æ€»è§ˆåŠ è½½æˆåŠŸ');
                } else {
                    showToast(data.message || 'è·å–è´¦å•æ•°æ®å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('è´¦å•æ€»è§ˆåˆå§‹åŒ–å¤±è´¥:', error);
                showToast(error.message || 'ç½‘ç»œå¼‚å¸¸ï¼ŒåŠ è½½å¤±è´¥');
            });
    }
    function updateSummaryNumbers(data) {
        // æ ¼å¼åŒ–é‡‘é¢ä¸ºçš„å­—ç¬¦ä¸²


    // æ›´æ–°DOM
    document.querySelector('.summary-item .income').textContent = data.totalIncome;
    document.querySelector('.summary-item .expense').textContent = data.totalExpense;
    document.querySelector('.summary-item .balance').textContent = data.balance;
    }

    /**
     * æ›´æ–°æ”¯å‡ºåˆ†ç±»å›¾è¡¨ï¼ˆå¤„ç†å•ä¸ªåˆ†ç±»å’Œå¤šä¸ªåˆ†ç±»çš„æƒ…å†µï¼‰
     * @param {Array} expenseList - æ¥å£è¿”å›çš„æ”¯å‡ºåˆ†ç±»æ•°æ®
     */
    function updateExpenseCategories(expenseList) {
        const chartContainer = document.querySelector('.expense-chart');
        if (!chartContainer) return;

        // å®šä¹‰å›ºå®šåˆ†ç±»ï¼ˆä¸UIå¯¹åº”ï¼Œç¡®ä¿æ ·å¼ä¸€è‡´ï¼‰
        const fixedCategories = [
            { name: 'é¤é¥®', color: '#ff6b6b' },
            { name: 'å‡ºè¡Œ', color: '#4ecdc4' },
            { name: 'è´­ç‰©', color: '#45b7d1' },
            { name: 'å…¶ä»–', color: '#f9ca24' }
        ];

        // å°†æ¥å£æ•°æ®è½¬æ¢ä¸ºMapï¼ˆæŒ‰åˆ†ç±»åç§°æ˜ å°„ï¼‰
        const expenseMap = new Map();
        expenseList.forEach(item => {
            expenseMap.set(item.bizCategoryName, {
                amount: item.amount,
                percentage: item.percentage
            });
        });

        // ç”Ÿæˆå®Œæ•´çš„åˆ†ç±»æ•°æ®ï¼ˆç¼ºå¤±åˆ†ç±»å¡«å……0ï¼‰
        const fullCategories = fixedCategories.map(cat => {
            const matched = expenseMap.get(cat.name) || { amount: '0', percentage: '0.00' };
            return {
                ...cat,
                amount: matched.amount,
                percentage: Math.round(parseFloat(matched.percentage)).toString()
            };
        });

        // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“å›¾è¡¨
        chartContainer.innerHTML = '';
        fullCategories.forEach(item => {
            const chartItem = document.createElement('div');
            chartItem.className = 'chart-item';
            // æ ¼å¼åŒ–é‡‘é¢ï¼ˆä¿ç•™ä¸¤ä½å°æ•°ï¼‰
            const formattedAmount = parseFloat(item.amount).toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            chartItem.innerHTML = `
        <div class="chart-color" style="background: ${item.color};"></div>
        <span class="chart-label">${item.name}</span>
        <span class="chart-amount">Â¥${formattedAmount}</span>
        <span class="chart-percent">${item.percentage}%</span>
    `;
            chartContainer.appendChild(chartItem);
        });
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è´¦å•åˆ—è¡¨
    document.addEventListener('DOMContentLoaded', function () {
        initBillsList();
        initHiddenSelector();
        updateMonthDisplay();

        initBillSummary();
    });
</script>
</body>

</html>